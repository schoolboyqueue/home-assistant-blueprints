#!/bin/sh
# Commit-msg hook for Home Assistant Blueprints repository
# Enforces Conventional Commits format

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip validation for merge commits, revert commits, and fixup/squash commits
case "$COMMIT_MSG" in
    Merge*|Revert*|fixup!*|squash!*|amend!*)
        exit 0
        ;;
esac

# Skip if it's an automated commit (e.g., from CI)
case "$COMMIT_MSG" in
    \[skip\ ci\]*|\[ci\ skip\]*)
        exit 0
        ;;
esac

printf "${BLUE}Validating commit message format...${NC}\n"

# Conventional Commits regex pattern
# Format: <type>[(scope)][!]: <description>
# Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert, security
# Scope is optional and can be any word (typically blueprint name)
# ! indicates breaking change
CONVENTIONAL_COMMIT_PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|security)(\([a-zA-Z0-9_-]+\))?(!)?: .+$'

# Extract the first line (subject) of the commit message
COMMIT_SUBJECT=$(echo "$COMMIT_MSG" | head -1)

# Validate the commit message format
if ! echo "$COMMIT_SUBJECT" | grep -qE "$CONVENTIONAL_COMMIT_PATTERN"; then
    echo ""
    printf "${RED}Invalid commit message format!${NC}\n"
    echo ""
    printf "Your commit message:\n"
    printf "  ${YELLOW}%s${NC}\n" "$COMMIT_SUBJECT"
    echo ""
    printf "Expected format: ${GREEN}<type>(<scope>): <description>${NC}\n"
    echo ""
    printf "Valid types:\n"
    printf "  ${GREEN}feat${NC}     - New feature\n"
    printf "  ${GREEN}fix${NC}      - Bug fix\n"
    printf "  ${GREEN}docs${NC}     - Documentation only changes\n"
    printf "  ${GREEN}style${NC}    - Formatting, missing semi colons, etc; no code change\n"
    printf "  ${GREEN}refactor${NC} - Code change that neither fixes a bug nor adds a feature\n"
    printf "  ${GREEN}perf${NC}     - Performance improvement\n"
    printf "  ${GREEN}test${NC}     - Adding missing tests\n"
    printf "  ${GREEN}build${NC}    - Changes to build process or dependencies\n"
    printf "  ${GREEN}ci${NC}       - CI configuration changes\n"
    printf "  ${GREEN}chore${NC}    - Maintenance tasks\n"
    printf "  ${GREEN}revert${NC}   - Revert a previous commit\n"
    printf "  ${GREEN}security${NC} - Security fixes\n"
    echo ""
    printf "Examples:\n"
    printf "  ${GREEN}feat(adaptive-comfort-control): add temperature offset support${NC}\n"
    printf "  ${GREEN}fix(adaptive-fan-control): correct humidity calculation${NC}\n"
    printf "  ${GREEN}docs: update README with new installation instructions${NC}\n"
    printf "  ${GREEN}chore: update gitignore${NC}\n"
    printf "  ${GREEN}feat!: breaking change example${NC}\n"
    echo ""
    exit 1
fi

# Validate subject line length (should be <= 72 characters for best display)
SUBJECT_LENGTH=$(echo "$COMMIT_SUBJECT" | wc -c | tr -d ' ')
SUBJECT_LENGTH=$((SUBJECT_LENGTH - 1))  # subtract newline
if [ "$SUBJECT_LENGTH" -gt 72 ]; then
    printf "${YELLOW}Warning: Commit subject line is %d characters (recommended: <= 72)${NC}\n" "$SUBJECT_LENGTH"
fi

# Validate subject doesn't end with a period
case "$COMMIT_SUBJECT" in
    *.)
        printf "${YELLOW}Warning: Commit subject should not end with a period${NC}\n"
        ;;
esac

# Validate subject starts with lowercase after the colon
# Extract the description part (after the colon)
DESCRIPTION=$(echo "$COMMIT_SUBJECT" | sed 's/^[^:]*: //')
FIRST_CHAR=$(echo "$DESCRIPTION" | cut -c1)

# Only warn if it starts with uppercase (not strict requirement)
case "$FIRST_CHAR" in
    [A-Z])
        printf "${YELLOW}Note: Consider using lowercase for the first character of description${NC}\n"
        ;;
esac

# Check for scope when modifying blueprint files
STAGED_BLUEPRINTS=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null | grep -E '^blueprints/[^/]+/.*\.yaml$' || true)

if [ -n "$STAGED_BLUEPRINTS" ]; then
    # Extract scope from commit message if present
    SCOPE=$(echo "$COMMIT_SUBJECT" | grep -oE '\([a-zA-Z0-9_-]+\)' | tr -d '()' || true)

    if [ -z "$SCOPE" ]; then
        # Get unique blueprint directories
        BLUEPRINT_DIRS=$(echo "$STAGED_BLUEPRINTS" | xargs -I {} dirname {} | sort -u | xargs -I {} basename {})
        DIR_COUNT=$(echo "$BLUEPRINT_DIRS" | wc -l | tr -d ' ')

        if [ "$DIR_COUNT" -eq 1 ]; then
            printf "${YELLOW}Tip: Consider adding a scope for the blueprint:${NC}\n"
            printf "  ${GREEN}feat(%s): your description${NC}\n" "$BLUEPRINT_DIRS"
        fi
    fi
fi

# Warn if commit message contains Claude Code references (per CLAUDE.md guidelines)
if echo "$COMMIT_MSG" | grep -qiE 'claude|anthropic|co-authored-by.*claude|generated with claude'; then
    printf "${YELLOW}Warning: Commit message contains Claude/AI references${NC}\n"
    printf "${YELLOW}Per project guidelines, these should not be included in commits${NC}\n"
fi

printf "${GREEN}Commit message format is valid!${NC}\n"
exit 0
