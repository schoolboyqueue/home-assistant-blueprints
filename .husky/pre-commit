#!/bin/bash
# Pre-commit hook for Home Assistant Blueprints repository
# Validates blueprints before allowing commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
VALIDATOR="$REPO_ROOT/scripts/validate-blueprint/validate-blueprint.py"

echo -e "${BLUE}Running pre-commit checks...${NC}"

# Check if validator exists
if [[ ! -f "$VALIDATOR" ]]; then
    echo -e "${YELLOW}Warning: Blueprint validator not found at $VALIDATOR${NC}"
    echo -e "${YELLOW}Skipping blueprint validation${NC}"
    exit 0
fi

# Get staged YAML files in blueprints directory
STAGED_BLUEPRINTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^blueprints/[^/]+/.*\.yaml$' || true)

if [[ -z "$STAGED_BLUEPRINTS" ]]; then
    echo -e "${GREEN}No blueprint files staged for commit${NC}"
else
    echo -e "${BLUE}Validating staged blueprints:${NC}"

    VALIDATION_FAILED=0

    for blueprint in $STAGED_BLUEPRINTS; do
        echo -e "  Checking ${YELLOW}$blueprint${NC}..."

        # Run validation on the staged version of the file
        # We need to validate the actual staged content, not the working directory version
        if ! python3 "$VALIDATOR" "$REPO_ROOT/$blueprint" 2>&1; then
            VALIDATION_FAILED=1
            echo -e "  ${RED}FAILED${NC}: $blueprint"
        else
            echo -e "  ${GREEN}OK${NC}: $blueprint"
        fi
    done

    if [[ $VALIDATION_FAILED -eq 1 ]]; then
        echo ""
        echo -e "${RED}Blueprint validation failed!${NC}"
        echo -e "Please fix the issues above before committing."
        echo -e "You can run the validator manually:"
        echo -e "  ${YELLOW}python3 scripts/validate-blueprint/validate-blueprint.py <blueprint.yaml>${NC}"
        exit 1
    fi

    echo -e "${GREEN}All blueprint validations passed!${NC}"
fi

# Check for version consistency in staged blueprints
echo ""
echo -e "${BLUE}Checking version consistency...${NC}"

for blueprint in $STAGED_BLUEPRINTS; do
    blueprint_dir=$(dirname "$REPO_ROOT/$blueprint")
    changelog="$blueprint_dir/CHANGELOG.md"

    if [[ -f "$changelog" ]]; then
        # Extract version from blueprint name field
        blueprint_name_version=$(grep -E '^\s*name:.*v[0-9]+\.[0-9]+\.[0-9]+' "$REPO_ROOT/$blueprint" | head -1 | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 | sed 's/^v//' || true)

        # Extract version from blueprint_version variable
        blueprint_var_version=$(grep -E '^\s*blueprint_version:' "$REPO_ROOT/$blueprint" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || true)

        # Extract latest version from CHANGELOG
        changelog_version=$(grep -E '^\s*##\s*\[' "$changelog" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || true)

        if [[ -n "$blueprint_name_version" && -n "$blueprint_var_version" ]]; then
            if [[ "$blueprint_name_version" != "$blueprint_var_version" ]]; then
                echo -e "${RED}Version mismatch in $blueprint:${NC}"
                echo -e "  Blueprint name version: ${YELLOW}$blueprint_name_version${NC}"
                echo -e "  blueprint_version var:  ${YELLOW}$blueprint_var_version${NC}"
                echo -e "${RED}Please ensure both versions match!${NC}"
                exit 1
            fi

            if [[ -n "$changelog_version" && "$blueprint_name_version" != "$changelog_version" ]]; then
                echo -e "${YELLOW}Warning: CHANGELOG version ($changelog_version) differs from blueprint version ($blueprint_name_version)${NC}"
                echo -e "${YELLOW}Consider updating CHANGELOG.md with the new version${NC}"
            fi
        fi
    fi
done

echo -e "${GREEN}Version consistency check passed!${NC}"

# Check for common mistakes
echo ""
echo -e "${BLUE}Checking for common mistakes...${NC}"

MISTAKES_FOUND=0

for blueprint in $STAGED_BLUEPRINTS; do
    # Check for !input inside {{ }}
    if grep -qE '\{\{[^}]*!input[^}]*\}\}' "$REPO_ROOT/$blueprint" 2>/dev/null; then
        echo -e "${RED}Error in $blueprint: Found !input inside {{ }} template${NC}"
        echo -e "  ${YELLOW}Bind !input to a variable first, then use the variable in templates${NC}"
        MISTAKES_FOUND=1
    fi

    # Check for tabs (should use spaces)
    if grep -qP '^\t' "$REPO_ROOT/$blueprint" 2>/dev/null; then
        echo -e "${YELLOW}Warning in $blueprint: Contains tabs (prefer spaces for YAML)${NC}"
    fi

    # Check for trailing whitespace
    if grep -qE '\s+$' "$REPO_ROOT/$blueprint" 2>/dev/null; then
        echo -e "${YELLOW}Warning in $blueprint: Contains trailing whitespace${NC}"
    fi
done

if [[ $MISTAKES_FOUND -eq 1 ]]; then
    echo -e "${RED}Common mistakes found! Please fix before committing.${NC}"
    exit 1
fi

echo -e "${GREEN}No common mistakes found!${NC}"

# Check that README and CHANGELOG exist for each modified blueprint directory
echo ""
echo -e "${BLUE}Checking documentation files...${NC}"

for blueprint in $STAGED_BLUEPRINTS; do
    blueprint_dir=$(dirname "$REPO_ROOT/$blueprint")

    # Skip shared directory
    if [[ "$blueprint_dir" == *"/shared"* ]]; then
        continue
    fi

    if [[ ! -f "$blueprint_dir/README.md" ]]; then
        echo -e "${YELLOW}Warning: Missing README.md in $(basename "$blueprint_dir")${NC}"
    fi

    if [[ ! -f "$blueprint_dir/CHANGELOG.md" ]]; then
        echo -e "${YELLOW}Warning: Missing CHANGELOG.md in $(basename "$blueprint_dir")${NC}"
    fi
done

echo -e "${GREEN}Documentation check complete!${NC}"

echo ""
echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
