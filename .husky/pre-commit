#!/bin/bash
# Pre-commit hook for Home Assistant Blueprints repository
# Validates blueprints before allowing commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"
VALIDATOR="$REPO_ROOT/scripts/validate-blueprint-go/build/validate-blueprint"

echo -e "${BLUE}Running pre-commit checks...${NC}"

# Check if validator exists
if [[ ! -f "$VALIDATOR" ]]; then
    echo -e "${YELLOW}Warning: Blueprint validator not found at $VALIDATOR${NC}"
    echo -e "${YELLOW}Skipping blueprint validation${NC}"
    exit 0
fi

# Get staged YAML files in blueprints directory (excluding shared/ which contains non-blueprint resources)
STAGED_BLUEPRINTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^blueprints/[^/]+/.*\.yaml$' | grep -v '^blueprints/shared/' || true)

if [[ -z "$STAGED_BLUEPRINTS" ]]; then
    echo -e "${GREEN}No blueprint files staged for commit${NC}"
else
    echo -e "${BLUE}Validating staged blueprints:${NC}"

    VALIDATION_FAILED=0

    for blueprint in $STAGED_BLUEPRINTS; do
        echo -e "  Checking ${YELLOW}$blueprint${NC}..."

        # Run validation on the staged version of the file
        # We need to validate the actual staged content, not the working directory version
        if ! "$VALIDATOR" "$REPO_ROOT/$blueprint" 2>&1; then
            VALIDATION_FAILED=1
            echo -e "  ${RED}FAILED${NC}: $blueprint"
        else
            echo -e "  ${GREEN}OK${NC}: $blueprint"
        fi
    done

    if [[ $VALIDATION_FAILED -eq 1 ]]; then
        echo ""
        echo -e "${RED}Blueprint validation failed!${NC}"
        echo -e "Please fix the issues above before committing."
        echo -e "You can run the validator manually:"
        echo -e "  ${YELLOW}./scripts/validate-blueprint-go/build/validate-blueprint <blueprint.yaml>${NC}"
        exit 1
    fi

    echo -e "${GREEN}All blueprint validations passed!${NC}"
fi

# Check for version consistency in staged blueprints
echo ""
echo -e "${BLUE}Checking version consistency...${NC}"

for blueprint in $STAGED_BLUEPRINTS; do
    blueprint_dir=$(dirname "$REPO_ROOT/$blueprint")
    changelog="$blueprint_dir/CHANGELOG.md"

    if [[ -f "$changelog" ]]; then
        # Extract version from blueprint name field
        blueprint_name_version=$(grep -E '^\s*name:.*v[0-9]+\.[0-9]+\.[0-9]+' "$REPO_ROOT/$blueprint" | head -1 | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 | sed 's/^v//' || true)

        # Extract version from blueprint_version variable
        blueprint_var_version=$(grep -E '^\s*blueprint_version:' "$REPO_ROOT/$blueprint" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || true)

        # Extract latest version from CHANGELOG
        changelog_version=$(grep -E '^\s*##\s*\[' "$changelog" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || true)

        if [[ -n "$blueprint_name_version" && -n "$blueprint_var_version" ]]; then
            if [[ "$blueprint_name_version" != "$blueprint_var_version" ]]; then
                echo -e "${RED}Version mismatch in $blueprint:${NC}"
                echo -e "  Blueprint name version: ${YELLOW}$blueprint_name_version${NC}"
                echo -e "  blueprint_version var:  ${YELLOW}$blueprint_var_version${NC}"
                echo -e "${RED}Please ensure both versions match!${NC}"
                exit 1
            fi

            if [[ -n "$changelog_version" && "$blueprint_name_version" != "$changelog_version" ]]; then
                echo -e "${YELLOW}Warning: CHANGELOG version ($changelog_version) differs from blueprint version ($blueprint_name_version)${NC}"
                echo -e "${YELLOW}Consider updating CHANGELOG.md with the new version${NC}"
            fi
        fi
    fi
done

echo -e "${GREEN}Version consistency check passed!${NC}"

# Check for common mistakes
echo ""
echo -e "${BLUE}Checking for common mistakes...${NC}"

MISTAKES_FOUND=0

for blueprint in $STAGED_BLUEPRINTS; do
    # Check for !input inside {{ }}
    if grep -qE '\{\{[^}]*!input[^}]*\}\}' "$REPO_ROOT/$blueprint" 2>/dev/null; then
        echo -e "${RED}Error in $blueprint: Found !input inside {{ }} template${NC}"
        echo -e "  ${YELLOW}Bind !input to a variable first, then use the variable in templates${NC}"
        MISTAKES_FOUND=1
    fi

    # Check for tabs (should use spaces)
    if grep -qP '^\t' "$REPO_ROOT/$blueprint" 2>/dev/null; then
        echo -e "${YELLOW}Warning in $blueprint: Contains tabs (prefer spaces for YAML)${NC}"
    fi

    # Check for trailing whitespace
    if grep -qE '\s+$' "$REPO_ROOT/$blueprint" 2>/dev/null; then
        echo -e "${YELLOW}Warning in $blueprint: Contains trailing whitespace${NC}"
    fi
done

if [[ $MISTAKES_FOUND -eq 1 ]]; then
    echo -e "${RED}Common mistakes found! Please fix before committing.${NC}"
    exit 1
fi

echo -e "${GREEN}No common mistakes found!${NC}"

# Check that README and CHANGELOG exist for each modified blueprint directory
echo ""
echo -e "${BLUE}Checking documentation files...${NC}"

for blueprint in $STAGED_BLUEPRINTS; do
    blueprint_dir=$(dirname "$REPO_ROOT/$blueprint")

    # Skip shared directory
    if [[ "$blueprint_dir" == *"/shared"* ]]; then
        continue
    fi

    if [[ ! -f "$blueprint_dir/README.md" ]]; then
        echo -e "${YELLOW}Warning: Missing README.md in $(basename "$blueprint_dir")${NC}"
    fi

    if [[ ! -f "$blueprint_dir/CHANGELOG.md" ]]; then
        echo -e "${YELLOW}Warning: Missing CHANGELOG.md in $(basename "$blueprint_dir")${NC}"
    fi
done

echo -e "${GREEN}Documentation check complete!${NC}"

#------------------------------------------------------------------------------
# Go Tools Linting
#------------------------------------------------------------------------------

# Check if any Go files are staged
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^scripts/(ha-ws-client-go|validate-blueprint-go)/.*\.go$' || true)

if [[ -n "$STAGED_GO_FILES" ]]; then
    echo ""
    echo -e "${BLUE}Running Go linting checks...${NC}"

    # Add Go bin to PATH for tools like golangci-lint, gofumpt
    export PATH="$HOME/go/bin:$PATH"

    # Check if golangci-lint is available
    if ! command -v golangci-lint &> /dev/null; then
        echo -e "${YELLOW}Warning: golangci-lint not found. Run 'make install-go-tools' to install.${NC}"
        echo -e "${YELLOW}Skipping Go linting...${NC}"
    else
        GO_LINT_FAILED=0

        # Check validate-blueprint-go if it has staged files
        if echo "$STAGED_GO_FILES" | grep -q "validate-blueprint-go"; then
            echo -e "  Linting ${YELLOW}validate-blueprint-go${NC}..."
            if ! (cd "$REPO_ROOT/scripts/validate-blueprint-go" && golangci-lint run 2>&1); then
                GO_LINT_FAILED=1
                echo -e "  ${RED}FAILED${NC}: validate-blueprint-go linting"
            else
                echo -e "  ${GREEN}OK${NC}: validate-blueprint-go"
            fi
        fi

        # Check ha-ws-client-go if it has staged files
        if echo "$STAGED_GO_FILES" | grep -q "ha-ws-client-go"; then
            echo -e "  Linting ${YELLOW}ha-ws-client-go${NC}..."
            if ! (cd "$REPO_ROOT/scripts/ha-ws-client-go" && golangci-lint run 2>&1); then
                GO_LINT_FAILED=1
                echo -e "  ${RED}FAILED${NC}: ha-ws-client-go linting"
            else
                echo -e "  ${GREEN}OK${NC}: ha-ws-client-go"
            fi
        fi

        if [[ $GO_LINT_FAILED -eq 1 ]]; then
            echo ""
            echo -e "${RED}Go linting failed!${NC}"
            echo -e "Please fix the issues above before committing."
            echo -e "You can run linting manually:"
            echo -e "  ${YELLOW}cd scripts/<tool> && make lint${NC}"
            echo -e "Or auto-fix with:"
            echo -e "  ${YELLOW}cd scripts/<tool> && make lint-fix${NC}"
            exit 1
        fi

        echo -e "${GREEN}Go linting passed!${NC}"
    fi
fi

#------------------------------------------------------------------------------
# Go Tools Version and Changelog Checks
#------------------------------------------------------------------------------

# Check if any Go files are staged (including go.mod/go.sum for version checks)
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^scripts/(ha-ws-client-go|validate-blueprint-go)/.*\.(go|mod|sum)$' || true)

if [[ -n "$STAGED_GO_FILES" ]]; then
    echo ""
    echo -e "${BLUE}Checking Go tool versions and changelogs...${NC}"

    GO_TOOLS=("ha-ws-client-go" "validate-blueprint-go")
    GO_VERSIONS=()
    VERSION_ERROR=0

    for tool in "${GO_TOOLS[@]}"; do
        TOOL_DIR="$REPO_ROOT/scripts/$tool"
        MAKEFILE="$TOOL_DIR/Makefile"
        CHANGELOG="$TOOL_DIR/CHANGELOG.md"

        # Check if CHANGELOG.md exists
        if [[ ! -f "$CHANGELOG" ]]; then
            echo -e "${RED}Error: Missing CHANGELOG.md in $tool${NC}"
            echo -e "  ${YELLOW}Please create $CHANGELOG following Keep a Changelog format${NC}"
            VERSION_ERROR=1
            continue
        fi

        # Extract VERSION from Makefile (default value)
        if [[ -f "$MAKEFILE" ]]; then
            MAKEFILE_VERSION=$(grep -E '^VERSION\?=' "$MAKEFILE" | head -1 | sed 's/VERSION?=//' || true)
        else
            MAKEFILE_VERSION=""
        fi

        # Extract latest version from CHANGELOG (first ## [X.Y.Z] entry)
        CHANGELOG_VERSION=$(grep -E '^\s*##\s*\[' "$CHANGELOG" | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || true)

        if [[ -n "$MAKEFILE_VERSION" && -n "$CHANGELOG_VERSION" ]]; then
            if [[ "$MAKEFILE_VERSION" != "$CHANGELOG_VERSION" ]]; then
                echo -e "${RED}Version mismatch in $tool:${NC}"
                echo -e "  Makefile VERSION:  ${YELLOW}$MAKEFILE_VERSION${NC}"
                echo -e "  CHANGELOG version: ${YELLOW}$CHANGELOG_VERSION${NC}"
                echo -e "${YELLOW}Please ensure Makefile VERSION matches the latest CHANGELOG entry${NC}"
                VERSION_ERROR=1
            else
                echo -e "  ${GREEN}$tool: v$MAKEFILE_VERSION${NC} âœ“"
                GO_VERSIONS+=("$MAKEFILE_VERSION")
            fi
        elif [[ -z "$CHANGELOG_VERSION" ]]; then
            echo -e "${YELLOW}Warning: Could not extract version from $tool/CHANGELOG.md${NC}"
            echo -e "  ${YELLOW}Ensure CHANGELOG.md has entries like: ## [1.0.0] - YYYY-MM-DD${NC}"
        fi
    done

    # Check that both tools have the same version (synchronized releases)
    if [[ ${#GO_VERSIONS[@]} -eq 2 ]]; then
        if [[ "${GO_VERSIONS[0]}" != "${GO_VERSIONS[1]}" ]]; then
            echo -e "${YELLOW}Warning: Go tool versions are not synchronized:${NC}"
            echo -e "  ha-ws-client-go:      v${GO_VERSIONS[0]}"
            echo -e "  validate-blueprint-go: v${GO_VERSIONS[1]}"
            echo -e "${YELLOW}Consider keeping both tools at the same version for coordinated releases${NC}"
            # This is a warning, not an error - versions don't have to match
        fi
    fi

    if [[ $VERSION_ERROR -eq 1 ]]; then
        echo ""
        echo -e "${RED}Go tool version/changelog check failed!${NC}"
        echo -e "Please fix the issues above before committing."
        exit 1
    fi

    echo -e "${GREEN}Go tool version/changelog check passed!${NC}"
fi

echo ""
echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
