name: Build and Release Go Tools

on:
  push:
    tags:
      - 'v*'
      - 'ha-ws-client-go/v*'
      - 'validate-blueprint-go/v*'
  workflow_dispatch:
    inputs:
      build_target:
        description: 'Which tool(s) to build'
        required: true
        default: 'both'
        type: choice
        options:
          - both
          - ha-ws-client-go
          - validate-blueprint-go

permissions:
  contents: write

jobs:
  determine-builds:
    name: Determine what to build
    runs-on: ubuntu-latest
    outputs:
      build_client: ${{ steps.check.outputs.build_client }}
      build_validator: ${{ steps.check.outputs.build_validator }}
      release_version: ${{ steps.check.outputs.release_version }}
      release_tag: ${{ steps.check.outputs.release_tag }}
      release_title: ${{ steps.check.outputs.release_title }}
      client_version: ${{ steps.check.outputs.client_version }}
      validator_version: ${{ steps.check.outputs.validator_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine build targets
        id: check
        env:
          INPUT_TARGET: ${{ github.event.inputs.build_target }}
        run: |
          # Get versions from Makefiles
          VALIDATE_VERSION=$(grep -E '^VERSION\s*(\?=|:=|=)' scripts/validate-blueprint-go/Makefile | head -1 | sed 's/.*[?:]\?=\s*//' | tr -d ' ')
          CLIENT_VERSION=$(grep -E '^VERSION\s*(\?=|:=|=)' scripts/ha-ws-client-go/Makefile | head -1 | sed 's/.*[?:]\?=\s*//' | tr -d ' ')

          echo "validator_version=$VALIDATE_VERSION" >> $GITHUB_OUTPUT
          echo "client_version=$CLIENT_VERSION" >> $GITHUB_OUTPUT

          # Determine what to build based on trigger
          TAG_NAME="${GITHUB_REF_NAME}"
          BUILD_CLIENT="false"
          BUILD_VALIDATOR="false"

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use input
            case "$INPUT_TARGET" in
              "both")
                BUILD_CLIENT="true"
                BUILD_VALIDATOR="true"
                ;;
              "ha-ws-client-go")
                BUILD_CLIENT="true"
                ;;
              "validate-blueprint-go")
                BUILD_VALIDATOR="true"
                ;;
            esac
          elif [[ "$TAG_NAME" == ha-ws-client-go/* ]]; then
            BUILD_CLIENT="true"
          elif [[ "$TAG_NAME" == validate-blueprint-go/* ]]; then
            BUILD_VALIDATOR="true"
          elif [[ "$TAG_NAME" == v* ]]; then
            # Combined v* tag - build both
            BUILD_CLIENT="true"
            BUILD_VALIDATOR="true"
          fi

          echo "build_client=$BUILD_CLIENT" >> $GITHUB_OUTPUT
          echo "build_validator=$BUILD_VALIDATOR" >> $GITHUB_OUTPUT

          # Determine release version (higher of the two being built)
          if [ "$BUILD_CLIENT" == "true" ] && [ "$BUILD_VALIDATOR" == "true" ]; then
            if [ "$(printf '%s\n' "$VALIDATE_VERSION" "$CLIENT_VERSION" | sort -V | tail -1)" = "$VALIDATE_VERSION" ]; then
              echo "release_version=$VALIDATE_VERSION" >> $GITHUB_OUTPUT
            else
              echo "release_version=$CLIENT_VERSION" >> $GITHUB_OUTPUT
            fi
          elif [ "$BUILD_CLIENT" == "true" ]; then
            echo "release_version=$CLIENT_VERSION" >> $GITHUB_OUTPUT
          else
            echo "release_version=$VALIDATE_VERSION" >> $GITHUB_OUTPUT
          fi

          # Determine tag for release
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # For manual dispatch, construct tag from version
            if [ "$BUILD_CLIENT" == "true" ] && [ "$BUILD_VALIDATOR" == "true" ]; then
              # Use higher version for combined release tag
              if [ "$(printf '%s\n' "$VALIDATE_VERSION" "$CLIENT_VERSION" | sort -V | tail -1)" = "$VALIDATE_VERSION" ]; then
                RELEASE_TAG="v$VALIDATE_VERSION"
              else
                RELEASE_TAG="v$CLIENT_VERSION"
              fi
            elif [ "$BUILD_CLIENT" == "true" ]; then
              RELEASE_TAG="ha-ws-client-go/v$CLIENT_VERSION"
            else
              RELEASE_TAG="validate-blueprint-go/v$VALIDATE_VERSION"
            fi
          else
            # For tag push, use the actual tag
            RELEASE_TAG="$TAG_NAME"
          fi
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

          # Determine release title based on what's being built
          if [ "$BUILD_CLIENT" == "true" ] && [ "$BUILD_VALIDATOR" == "true" ]; then
            RELEASE_TITLE="ha-ws-client-go v$CLIENT_VERSION, validate-blueprint-go v$VALIDATE_VERSION"
          elif [ "$BUILD_CLIENT" == "true" ]; then
            RELEASE_TITLE="ha-ws-client-go v$CLIENT_VERSION"
          else
            RELEASE_TITLE="validate-blueprint-go v$VALIDATE_VERSION"
          fi
          echo "release_title=$RELEASE_TITLE" >> $GITHUB_OUTPUT

          echo "Tag: $TAG_NAME"
          echo "Release tag: $RELEASE_TAG"
          echo "Release title: $RELEASE_TITLE"
          echo "Build ha-ws-client-go: $BUILD_CLIENT (v$CLIENT_VERSION)"
          echo "Build validate-blueprint-go: $BUILD_VALIDATOR (v$VALIDATE_VERSION)"

  test:
    name: Run Tests
    needs: determine-builds
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool:
          - validate-blueprint-go
          - ha-ws-client-go

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: scripts/${{ matrix.tool }}/go.sum

      - name: Run linter
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.62.2
          working-directory: scripts/${{ matrix.tool }}
          args: --timeout=5m

      - name: Run tests
        working-directory: scripts/${{ matrix.tool }}
        run: go test -race -covermode=atomic ./...

  build:
    name: Build Go Binaries
    needs: [determine-builds, test]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: arm
            goarm: 7
            suffix: linux-armv7
          - goos: linux
            goarch: arm
            goarm: 6
            suffix: linux-armv6
          - goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - goos: windows
            goarch: amd64
            suffix: windows-amd64
            ext: .exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build validate-blueprint
        if: needs.determine-builds.outputs.build_validator == 'true'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 0
          VERSION: ${{ needs.determine-builds.outputs.validator_version }}
        run: |
          cd scripts/validate-blueprint-go
          LDFLAGS="-s -w -X main.Version=$VERSION -X main.BuildTime=$(date -u '+%Y-%m-%d_%H:%M:%S') -X main.GitCommit=${GITHUB_SHA::7}"
          # Add ARM version for selfupdate package on ARM builds
          if [ -n "$GOARM" ]; then
            LDFLAGS="$LDFLAGS -X github.com/home-assistant-blueprints/selfupdate.ArmVersion=$GOARM"
          fi
          go build -ldflags "$LDFLAGS" -o ../../dist/validate-blueprint-${{ matrix.suffix }}${{ matrix.ext }} .

      - name: Build ha-ws-client
        if: needs.determine-builds.outputs.build_client == 'true'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 0
          VERSION: ${{ needs.determine-builds.outputs.client_version }}
        run: |
          cd scripts/ha-ws-client-go
          LDFLAGS="-s -w -X main.Version=$VERSION -X main.BuildTime=$(date -u '+%Y-%m-%d_%H:%M:%S') -X main.GitCommit=${GITHUB_SHA::7}"
          # Add ARM version for selfupdate package on ARM builds
          if [ -n "$GOARM" ]; then
            LDFLAGS="$LDFLAGS -X github.com/home-assistant-blueprints/selfupdate.ArmVersion=$GOARM"
          fi
          go build -ldflags "$LDFLAGS" -o ../../dist/ha-ws-client-${{ matrix.suffix }}${{ matrix.ext }} ./cmd/ha-ws-client

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.suffix }}
          path: dist/
          retention-days: 1
          if-no-files-found: ignore

  release:
    name: Create Release
    needs: [determine-builds, build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binaries-*
          merge-multiple: true

      - name: Create checksums
        run: |
          cd artifacts
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create versions.json
        env:
          BUILD_CLIENT: ${{ needs.determine-builds.outputs.build_client }}
          BUILD_VALIDATOR: ${{ needs.determine-builds.outputs.build_validator }}
          CLIENT_VERSION: ${{ needs.determine-builds.outputs.client_version }}
          VALIDATOR_VERSION: ${{ needs.determine-builds.outputs.validator_version }}
        run: |
          cd artifacts
          echo "{" > versions.json
          FIRST=true
          if [ "$BUILD_CLIENT" == "true" ]; then
            echo "  \"ha-ws-client-go\": \"$CLIENT_VERSION\"" >> versions.json
            FIRST=false
          fi
          if [ "$BUILD_VALIDATOR" == "true" ]; then
            if [ "$FIRST" == "false" ]; then
              # Add comma to previous line
              sed -i '$ s/$/,/' versions.json
            fi
            echo "  \"validate-blueprint-go\": \"$VALIDATOR_VERSION\"" >> versions.json
          fi
          echo "}" >> versions.json
          cat versions.json

      - name: Generate release body
        id: body
        env:
          BUILD_CLIENT: ${{ needs.determine-builds.outputs.build_client }}
          BUILD_VALIDATOR: ${{ needs.determine-builds.outputs.build_validator }}
          CLIENT_VERSION: ${{ needs.determine-builds.outputs.client_version }}
          VALIDATOR_VERSION: ${{ needs.determine-builds.outputs.validator_version }}
        run: |
          {
            echo 'content<<EOF'
            echo "## Go Tools Release"
            echo ""
            echo "### Versions"
            if [ "$BUILD_VALIDATOR" == "true" ]; then
              echo "- **validate-blueprint-go**: v$VALIDATOR_VERSION"
            fi
            if [ "$BUILD_CLIENT" == "true" ]; then
              echo "- **ha-ws-client-go**: v$CLIENT_VERSION"
            fi
            echo ""
            echo "### Downloads"
            echo ""
            echo "| Platform | validate-blueprint | ha-ws-client |"
            echo "|----------|-------------------|--------------|"
            if [ "$BUILD_VALIDATOR" == "true" ] && [ "$BUILD_CLIENT" == "true" ]; then
              echo "| Linux x86_64 | \`validate-blueprint-linux-amd64\` | \`ha-ws-client-linux-amd64\` |"
              echo "| Linux ARM64 (Pi 4) | \`validate-blueprint-linux-arm64\` | \`ha-ws-client-linux-arm64\` |"
              echo "| Linux ARMv7 (Pi 2/3) | \`validate-blueprint-linux-armv7\` | \`ha-ws-client-linux-armv7\` |"
              echo "| Linux ARMv6 (Pi Zero/1) | \`validate-blueprint-linux-armv6\` | \`ha-ws-client-linux-armv6\` |"
              echo "| macOS Intel | \`validate-blueprint-darwin-amd64\` | \`ha-ws-client-darwin-amd64\` |"
              echo "| macOS Apple Silicon | \`validate-blueprint-darwin-arm64\` | \`ha-ws-client-darwin-arm64\` |"
              echo "| Windows x86_64 | \`validate-blueprint-windows-amd64.exe\` | \`ha-ws-client-windows-amd64.exe\` |"
            elif [ "$BUILD_VALIDATOR" == "true" ]; then
              echo "| Linux x86_64 | \`validate-blueprint-linux-amd64\` | - |"
              echo "| Linux ARM64 (Pi 4) | \`validate-blueprint-linux-arm64\` | - |"
              echo "| Linux ARMv7 (Pi 2/3) | \`validate-blueprint-linux-armv7\` | - |"
              echo "| Linux ARMv6 (Pi Zero/1) | \`validate-blueprint-linux-armv6\` | - |"
              echo "| macOS Intel | \`validate-blueprint-darwin-amd64\` | - |"
              echo "| macOS Apple Silicon | \`validate-blueprint-darwin-arm64\` | - |"
              echo "| Windows x86_64 | \`validate-blueprint-windows-amd64.exe\` | - |"
            else
              echo "| Linux x86_64 | - | \`ha-ws-client-linux-amd64\` |"
              echo "| Linux ARM64 (Pi 4) | - | \`ha-ws-client-linux-arm64\` |"
              echo "| Linux ARMv7 (Pi 2/3) | - | \`ha-ws-client-linux-armv7\` |"
              echo "| Linux ARMv6 (Pi Zero/1) | - | \`ha-ws-client-linux-armv6\` |"
              echo "| macOS Intel | - | \`ha-ws-client-darwin-amd64\` |"
              echo "| macOS Apple Silicon | - | \`ha-ws-client-darwin-arm64\` |"
              echo "| Windows x86_64 | - | \`ha-ws-client-windows-amd64.exe\` |"
            fi
            echo ""
            echo "### Installation"
            echo ""
            echo "1. Download the appropriate binary for your platform"
            echo "2. Make it executable: \`chmod +x <binary-name>\`"
            echo "3. Move to your PATH: \`mv <binary-name> /usr/local/bin/\`"
            echo ""
            echo "### Changelogs"
            echo "- [validate-blueprint-go CHANGELOG](https://github.com/${{ github.repository }}/blob/main/scripts/validate-blueprint-go/CHANGELOG.md)"
            echo "- [ha-ws-client-go CHANGELOG](https://github.com/${{ github.repository }}/blob/main/scripts/ha-ws-client-go/CHANGELOG.md)"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.determine-builds.outputs.release_tag }}
          name: ${{ needs.determine-builds.outputs.release_title }}
          body: ${{ steps.body.outputs.content }}
          files: |
            artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: true
