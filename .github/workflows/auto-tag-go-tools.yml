name: Auto-tag Go Tools on Version Bump

on:
  workflow_run:
    workflows: ["CI Go Tools"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: write
  actions: write

jobs:
  check-and-tag:
    # Only run if CI workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'
    name: Check versions and create tags
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if version files changed
        id: changed-files
        run: |
          # Get the commit SHA from the triggering workflow run
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"

          # Check if any version-related files changed in this commit
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r "$COMMIT_SHA" 2>/dev/null || echo "")

          VERSION_FILES_CHANGED=false
          if echo "$CHANGED_FILES" | grep -qE '^scripts/(validate-blueprint-go|ha-ws-client-go)/(Makefile|CHANGELOG\.md)$'; then
            VERSION_FILES_CHANGED=true
          fi

          echo "changed=$VERSION_FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "Version files changed: $VERSION_FILES_CHANGED"
          if [ "$VERSION_FILES_CHANGED" = "true" ]; then
            echo "Changed version files:"
            echo "$CHANGED_FILES" | grep -E '^scripts/(validate-blueprint-go|ha-ws-client-go)/(Makefile|CHANGELOG\.md)$' || true
          fi

      - name: Check validate-blueprint-go version
        if: steps.changed-files.outputs.changed == 'true'
        id: validate-version
        run: |
          VERSION=$(grep -E '^VERSION\s*(\?=|:=|=)' scripts/validate-blueprint-go/Makefile | head -1 | sed 's/.*[?:]\?=\s*//' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if git tag -l "validate-blueprint-go/v$VERSION" | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Check ha-ws-client-go version
        if: steps.changed-files.outputs.changed == 'true'
        id: client-version
        run: |
          VERSION=$(grep -E '^VERSION\s*(\?=|:=|=)' scripts/ha-ws-client-go/Makefile | head -1 | sed 's/.*[?:]\?=\s*//' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if git tag -l "ha-ws-client-go/v$VERSION" | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create validate-blueprint-go tag
        if: steps.changed-files.outputs.changed == 'true' && steps.validate-version.outputs.exists == 'false'
        env:
          VERSION: ${{ steps.validate-version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "validate-blueprint-go/v$VERSION" -m "Release validate-blueprint-go v$VERSION"
          git push origin "validate-blueprint-go/v$VERSION"

      - name: Create ha-ws-client-go tag
        if: steps.changed-files.outputs.changed == 'true' && steps.client-version.outputs.exists == 'false'
        env:
          VERSION: ${{ steps.client-version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "ha-ws-client-go/v$VERSION" -m "Release ha-ws-client-go v$VERSION"
          git push origin "ha-ws-client-go/v$VERSION"

      - name: Create combined release tag
        if: steps.changed-files.outputs.changed == 'true' && (steps.validate-version.outputs.exists == 'false' || steps.client-version.outputs.exists == 'false')
        env:
          VERSION: ${{ steps.validate-version.outputs.version }}
        run: |
          if git tag -l "v$VERSION" | grep -q .; then
            echo "Combined tag v$VERSION already exists, skipping"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "v$VERSION" -m "Release Go Tools v$VERSION"
            git push origin "v$VERSION"
          fi

      - name: Trigger release workflow
        if: steps.changed-files.outputs.changed == 'true' && (steps.validate-version.outputs.exists == 'false' || steps.client-version.outputs.exists == 'false')
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Determine which tool(s) to build
          BUILD_TARGET="both"
          if [ "${{ steps.validate-version.outputs.exists }}" == "true" ]; then
            BUILD_TARGET="ha-ws-client-go"
          elif [ "${{ steps.client-version.outputs.exists }}" == "true" ]; then
            BUILD_TARGET="validate-blueprint-go"
          fi

          echo "Triggering release workflow for: $BUILD_TARGET"
          gh workflow run "Build and Release Go Tools" --field build_target="$BUILD_TARGET"
