name: CI Go Tools

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/validate-blueprint-go/**'
      - 'scripts/ha-ws-client-go/**'
      - '.github/workflows/ci-go-tools.yml'
  pull_request:
    paths:
      - 'scripts/validate-blueprint-go/**'
      - 'scripts/ha-ws-client-go/**'
      - '.github/workflows/ci-go-tools.yml'

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tool:
          - validate-blueprint-go
          - ha-ws-client-go

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: scripts/${{ matrix.tool }}/go.sum

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.62.2
          working-directory: scripts/${{ matrix.tool }}
          args: --timeout=5m

      - name: Run unit tests with coverage
        working-directory: scripts/${{ matrix.tool }}
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: scripts/${{ matrix.tool }}/coverage.out
          flags: ${{ matrix.tool }}
          name: ${{ matrix.tool }}-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Check formatting
        working-directory: scripts/${{ matrix.tool }}
        run: |
          go install mvdan.cc/gofumpt@v0.7.0
          test -z "$(gofumpt -l .)"

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: scripts/ha-ws-client-go/go.sum

      - name: Prepare Home Assistant config
        run: |
          mkdir -p /tmp/ha-config
          cp scripts/ha-ws-client-go/testdata/ha-config/configuration.yaml /tmp/ha-config/

      - name: Start Home Assistant
        run: |
          docker run -d \
            --name homeassistant \
            -p 8123:8123 \
            -v /tmp/ha-config:/config \
            ghcr.io/home-assistant/home-assistant:stable

      - name: Wait for Home Assistant to be ready
        run: |
          echo "Waiting for Home Assistant to start..."
          for i in {1..90}; do
            # Check onboarding endpoint (available without auth on fresh install)
            if curl -sf http://localhost:8123/api/onboarding > /dev/null 2>&1; then
              echo "Home Assistant responded, waiting for full initialization..."
              sleep 10  # Give HA time to fully initialize
              echo "Home Assistant is ready!"
              exit 0
            fi
            echo "Attempt $i: Waiting..."
            sleep 2
          done
          echo "Home Assistant failed to start"
          docker logs homeassistant
          exit 1

      - name: Complete Home Assistant onboarding
        id: onboarding
        run: |
          # Complete onboarding flow to create user
          echo "Starting onboarding..."

          # Step 1: Create user
          curl -sf -X POST http://localhost:8123/api/onboarding/users \
            -H "Content-Type: application/json" \
            -d '{"client_id":"http://localhost:8123/","name":"Test User","username":"testuser","password":"testpassword123","language":"en"}' \
            -o /tmp/user_response.json

          AUTH_CODE=$(jq -r '.auth_code' /tmp/user_response.json)
          echo "Got auth code"

          # Step 2: Exchange auth code for tokens
          curl -sf -X POST http://localhost:8123/auth/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=authorization_code&code=${AUTH_CODE}&client_id=http://localhost:8123/" \
            -o /tmp/token_response.json

          ACCESS_TOKEN=$(jq -r '.access_token' /tmp/token_response.json)
          export ACCESS_TOKEN
          echo "Got access token"

          # Step 3: Complete remaining onboarding steps
          curl -sf -X POST http://localhost:8123/api/onboarding/core_config \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{}'

          curl -sf -X POST http://localhost:8123/api/onboarding/analytics \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{}'

          curl -sf -X POST http://localhost:8123/api/onboarding/integration \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{}' || true

          # Step 4: Create long-lived access token
          LLAT_RESPONSE=$(curl -sf -X POST http://localhost:8123/api/websocket \
            --no-buffer \
            -H "Upgrade: websocket" \
            -H "Connection: Upgrade" 2>/dev/null || true)

          # Use Python to create LLAT via WebSocket (more reliable)
          pip install websockets > /dev/null 2>&1

          python3 - <<'PYEOF'
          import asyncio, json, os, websockets
          async def get_llat():
              token = os.environ.get("ACCESS_TOKEN")
              async with websockets.connect("ws://localhost:8123/api/websocket") as ws:
                  await ws.recv()
                  await ws.send(json.dumps({"type": "auth", "access_token": token}))
                  msg = json.loads(await ws.recv())
                  if msg["type"] != "auth_ok": raise Exception("Auth failed")
                  await ws.send(json.dumps({"id": 1, "type": "auth/long_lived_access_token", "client_name": "Integration Tests", "lifespan": 365}))
                  msg = json.loads(await ws.recv())
                  with open("/tmp/ha_token.txt", "w") as f: f.write(msg["result"])
          asyncio.run(get_llat())
          PYEOF

          LONG_LIVED_TOKEN=$(cat /tmp/ha_token.txt)

          echo "HA_TOKEN=${LONG_LIVED_TOKEN}" >> $GITHUB_OUTPUT
          echo "Successfully created long-lived access token"

      - name: Generate test data
        env:
          HA_TOKEN: ${{ steps.onboarding.outputs.HA_TOKEN }}
        run: |
          echo "Triggering automations to generate trace data..."

          # Trigger automations by changing entity states
          curl -sf -X POST http://localhost:8123/api/services/input_number/set_value \
            -H "Authorization: Bearer ${HA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"entity_id": "input_number.test_temperature", "value": 25}'

          sleep 2

          curl -sf -X POST http://localhost:8123/api/services/input_boolean/turn_on \
            -H "Authorization: Bearer ${HA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"entity_id": "input_boolean.motion_detected"}'

          sleep 2

          curl -sf -X POST http://localhost:8123/api/services/input_select/select_option \
            -H "Authorization: Bearer ${HA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"entity_id": "input_select.test_mode", "option": "away"}'

          sleep 2

          # Run the test script
          curl -sf -X POST http://localhost:8123/api/services/script/test_script \
            -H "Authorization: Bearer ${HA_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{}'

          sleep 2
          echo "Test data generated successfully"

      - name: Run integration tests
        working-directory: scripts/ha-ws-client-go
        env:
          HA_HOST: localhost:8123
          HA_TOKEN: ${{ steps.onboarding.outputs.HA_TOKEN }}
        run: |
          echo "Running integration tests against Home Assistant..."
          go test -tags=integration -race -v ./internal/handlers/...

      - name: Show Home Assistant logs on failure
        if: failure()
        run: |
          echo "=== Home Assistant Logs ==="
          docker logs homeassistant --tail 200

      - name: Cleanup
        if: always()
        run: |
          docker stop homeassistant || true
          docker rm homeassistant || true

  build:
    name: Build Test
    runs-on: ubuntu-latest
    needs: lint-and-test
    strategy:
      matrix:
        tool:
          - validate-blueprint-go
          - ha-ws-client-go
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: scripts/${{ matrix.tool }}/go.sum

      - name: Build validate-blueprint
        if: matrix.tool == 'validate-blueprint-go'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          cd scripts/validate-blueprint-go
          go build -ldflags "-s -w" -o /dev/null .

      - name: Build ha-ws-client
        if: matrix.tool == 'ha-ws-client-go'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          cd scripts/ha-ws-client-go
          go build -ldflags "-s -w" -o /dev/null ./cmd/ha-ws-client
