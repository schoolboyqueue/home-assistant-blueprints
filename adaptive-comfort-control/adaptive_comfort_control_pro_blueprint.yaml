blueprint:
    name: "Adaptive Comfort Control Pro v4.18.5"
    description: >
        Adaptive comfort control + HVAC pause with unit awareness (Â°C/Â°F), seasonal bias,
        built-in psychrometrics (dew point, absolute humidity, enthalpy), optional RMOT,
        and COâ‚‚-driven ventilation preference. Includes per-field help text and regional
        presets (seasonal bias + ventilation/psychrometrics/COâ‚‚) by U.S. state or region.
    domain: automation
    author: Jeremy Carter
    source_url: https://github.com/schoolboyqueue/home-assistant-blueprints/blob/main/adaptive-comfort-control/adaptive_comfort_control_pro_blueprint.yaml

    input:
        core:
            name: Core
            icon: mdi:home-thermometer
            collapsed: false
            input:
                climate_entity:
                    name: "Climate Device"
                    description: "Your thermostat or climate entity to control (e.g., Ecobee, Generic Thermostat, SmartIR)."
                    selector:
                        entity:
                            domain: ["climate"]

                indoor_temp_sensor:
                    name: "Indoor Temperature"
                    description: "Primary indoor air temperature for the room (sensor/input_number/weather)."
                    selector:
                        entity:
                            domain: ["sensor", "input_number", "weather"]

                outdoor_temp_sensor:
                    name: "Outdoor Temperature"
                    description: "Outdoor temperature used by the ASHRAE-55 adaptive model (sensor/input_number/weather)."
                    selector:
                        entity:
                            domain: ["sensor", "input_number", "weather"]

        optional_sensors:
            name: Optional Sensors
            icon: mdi:plus-circle
            collapsed: true
            input:
                mean_radiant_temp_sensor:
                    name: "Mean Radiant Temperature"
                    description: "If provided, operative temperature = mean(indoor air, mean radiant). Useful near large windows or radiant sources."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor", "input_number"]

                indoor_humidity_sensor:
                    name: "Indoor Humidity"
                    description: "Indoor RH (%) for psychrometrics (dew point, AH, enthalpy). If blank, assumes 50%."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor", "input_number"]

                outdoor_humidity_sensor:
                    name: "Outdoor Humidity"
                    description: "Outdoor RH (%) for psychrometrics. If blank, assumes 50%."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor", "input_number", "weather"]

                occupancy_sensor:
                    name: "Occupancy"
                    description: "Presence/motion sensor to bias behavior when home is occupied (optional)."
                    default: binary_sensor.none
                    selector:
                        entity:
                            domain: ["binary_sensor"]
                            device_class: ["motion", "occupancy", "presence"]

        comfort:
            name: Comfort & Units
            icon: mdi:tune-variant
            collapsed: false
            input:
                units_override:
                    name: "Units"
                    description: "Auto-detect by default. You can force Â°C or Â°F if your sensors/climate are mixed. âš ï¸ When set to 'c', use Â°C fields below. When 'f', use Â°F fields. When 'auto', use whichever matches your system."
                    default: "auto"
                    selector:
                        select:
                            options:
                                - label: "Auto-detect from sensors"
                                  value: "auto"
                                - label: "Force Celsius (Â°C)"
                                  value: "c"
                                - label: "Force Fahrenheit (Â°F)"
                                  value: "f"

                comfort_category:
                    name: "ASHRAE 55 Category (tolerance)"
                    description: "Controls comfort band width: I = Â±2Â°C (office), II = Â±3Â°C (typical home), III = Â±4Â°C (max savings)."
                    default: "II"
                    selector:
                        select:
                            options:
                                - label: "Category I (Â±2Â°C / Â±3.6Â°F) â€” ~90% satisfaction (office)"
                                  value: "I"
                                - label: "Category II (Â±3Â°C / Â±5.4Â°F) â€” ~80% satisfaction (typical home)"
                                  value: "II"
                                - label: "Category III (Â±4Â°C / Â±7.2Â°F) â€” ~65% satisfaction (max savings)"
                                  value: "III"

                min_comfort_temp_c:
                    name: "â„ï¸ Minimum Comfort (Â°C) â€” Metric Only"
                    description: "Hard lower bound for the comfort band. â„¹ï¸ Only used when Units='auto' with metric sensors, or Units='c'. Ignored if using Â°F."
                    default: 18.0
                    selector:
                        number:
                            min: 10.0
                            max: 25.0
                            step: 0.5
                            unit_of_measurement: "Â°C"

                max_comfort_temp_c:
                    name: "ðŸ”¥ Maximum Comfort (Â°C) â€” Metric Only"
                    description: "Hard upper bound for the comfort band. â„¹ï¸ Only used when Units='auto' with metric sensors, or Units='c'. Ignored if using Â°F."
                    default: 28.0
                    selector:
                        number:
                            min: 20.0
                            max: 35.0
                            step: 0.5
                            unit_of_measurement: "Â°C"

                min_comfort_temp_f:
                    name: "â„ï¸ Minimum Comfort (Â°F) â€” Imperial Only"
                    description: "Hard lower bound for the comfort band. â„¹ï¸ Only used when Units='auto' with imperial sensors, or Units='f'. Ignored if using Â°C."
                    default: 64.0
                    selector:
                        number:
                            min: 50.0
                            max: 75.0
                            step: 0.5
                            unit_of_measurement: "Â°F"

                max_comfort_temp_f:
                    name: "ðŸ”¥ Maximum Comfort (Â°F) â€” Imperial Only"
                    description: "Hard upper bound for the comfort band. â„¹ï¸ Only used when Units='auto' with imperial sensors, or Units='f'. Ignored if using Â°C."
                    default: 82.0
                    selector:
                        number:
                            min: 75.0
                            max: 95.0
                            step: 0.5
                            unit_of_measurement: "Â°F"

                use_operative_temperature:
                    name: "Use Operative Temperature"
                    description: "If on and MRT provided: target uses operative temp (average of air and radiant)."
                    default: false
                    selector:
                        boolean: {}

                air_velocity:
                    name: "Typical Air Velocity (m/s)"
                    description: "Air movement increases perceived cooling. Values >0.3 m/s activate cooling offsets above 25Â°C."
                    default: 0.1
                    selector:
                        number:
                            min: 0.0
                            max: 2.0
                            step: 0.1
                            unit_of_measurement: "m/s"

                adaptive_air_velocity:
                    name: "Auto Fan Adjustment"
                    description: "If enabled, increases fan speed as the room deviates from the comfort band."
                    default: true
                    selector:
                        boolean: {}

                humidity_comfort_enable:
                    name: "Humidity Comfort Correction"
                    description: "Applies small offsets for very high (>60%) or very low (<30%) indoor RH."
                    default: true
                    selector:
                        boolean: {}

                comfort_precision_mode:
                    name: "Precision Comfort (more responsive)"
                    description: "Includes velocity/humidity offsets in the adaptive setpoint. More responsive, slightly chattier."
                    default: false
                    selector:
                        boolean: {}

        seasons:
            name: Seasonal Bias & Regional Presets
            icon: mdi:weather-partly-snowy-rainy
            collapsed: true
            input:
                season_entity:
                    name: "Season Entity"
                    description: "If empty, we infer season from month. Use sensor.season or your own season sensor if available."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor"]

                regional_defaults_enable:
                    name: "Enable Regional Presets"
                    description: "Apply regional defaults (by U.S. state/region) for seasonal bias, ventilation threshold, psychrometrics, and COâ‚‚."
                    default: false
                    selector:
                        boolean: {}

                user_state_code:
                    name: "U.S. State (for Auto Preset)"
                    description: "Optional. When preset is 'Auto from State', this derives your region."
                    default: ""
                    selector:
                        select:
                            options:
                                - ""
                                - AL - Alabama
                                - AK - Alaska
                                - AZ - Arizona
                                - AR - Arkansas
                                - CA - California
                                - CO - Colorado
                                - CT - Connecticut
                                - DE - Delaware
                                - FL - Florida
                                - GA - Georgia
                                - HI - Hawaii
                                - ID - Idaho
                                - IL - Illinois
                                - IN - Indiana
                                - IA - Iowa
                                - KS - Kansas
                                - KY - Kentucky
                                - LA - Louisiana
                                - ME - Maine
                                - MD - Maryland
                                - MA - Massachusetts
                                - MI - Michigan
                                - MN - Minnesota
                                - MS - Mississippi
                                - MO - Missouri
                                - MT - Montana
                                - NE - Nebraska
                                - NV - Nevada
                                - NH - New Hampshire
                                - NJ - New Jersey
                                - NM - New Mexico
                                - NY - New York
                                - NC - North Carolina
                                - ND - North Dakota
                                - OH - Ohio
                                - OK - Oklahoma
                                - OR - Oregon
                                - PA - Pennsylvania
                                - RI - Rhode Island
                                - SC - South Carolina
                                - SD - South Dakota
                                - TN - Tennessee
                                - TX - Texas
                                - UT - Utah
                                - VT - Vermont
                                - VA - Virginia
                                - WA - Washington
                                - WV - West Virginia
                                - WI - Wisconsin
                                - WY - Wyoming
                                - DC - District of Columbia

                seasonal_bias_preset:
                    name: "Seasonal Bias Preset"
                    description: "Choose a preset or 'Auto from State' (uses U.S. State) or 'None (Manual)' to use your numeric biases."
                    default: "Auto from State"
                    selector:
                        select:
                            options:
                                - Auto from State
                                - Hot-Humid
                                - Hot-Dry
                                - Marine
                                - Mixed-Humid
                                - Mixed-Dry
                                - Cold
                                - Very Cold
                                - None (Manual)

                bias_preset_intensity:
                    name: "Preset Intensity (x)"
                    description: "Scales preset magnitudes. 1.0 = recommended; raise if you want stronger seasonal nudges."
                    default: 1.0
                    selector:
                        number:
                            min: 0.0
                            max: 2.0
                            step: 0.1

                winter_bias:
                    name: "Winter Bias (system units)"
                    description: "Manual seasonal nudge when it's winter: + warms target, - cools it. Ignored if Regional Presets are enabled."
                    default: 0.0
                    selector:
                        number:
                            min: -5.0
                            max: 5.0
                            step: 0.1

                summer_bias:
                    name: "Summer Bias (system units)"
                    description: "Manual nudge in summer: + warms target, - cools it. Ignored if Regional Presets are enabled."
                    default: 0.0
                    selector:
                        number:
                            min: -5.0
                            max: 5.0
                            step: 0.1

                shoulder_bias:
                    name: "Spring/Autumn Bias (system units)"
                    description: "Manual nudge in shoulder seasons. Ignored if Regional Presets are enabled."
                    default: 0.0
                    selector:
                        number:
                            min: -5.0
                            max: 5.0
                            step: 0.1

        ventilation_energy:
            name: Ventilation & Energy
            icon: mdi:leaf
            collapsed: true
            input:
                natural_ventilation_enable:
                    name: "Enable Natural Ventilation"
                    description: "When outdoor conditions are suitable, turn HVAC off and prefer opening windows."
                    default: true
                    selector:
                        boolean: {}

                natural_ventilation_threshold:
                    name: "Temperature Threshold (system units)"
                    description: "How close outdoor temp must be to indoor to allow natural ventilation (smaller = stricter)."
                    default: 2.0
                    selector:
                        number:
                            min: 0.5
                            max: 5.0
                            step: 0.1

                energy_save_mode:
                    name: "Energy Save Mode"
                    description: "Allows slightly more aggressive setpoints when unoccupied (setback when away)."
                    default: true
                    selector:
                        boolean: {}

                setback_temperature_offset:
                    name: "Setback Offset (system units)"
                    description: "How far we shift the target for energy savings when unoccupied."
                    default: 2.0
                    selector:
                        number:
                            min: 0.5
                            max: 5.0
                            step: 0.1

        psychrometrics:
            name: Built-in Psychrometrics
            icon: mdi:thermometer-water
            collapsed: true
            input:
                psychro_enable:
                    name: "Enable Moisture/Economizer Guards"
                    description: "Uses computed dew point, absolute humidity, and enthalpy to block muggy ventilation and prefer 'free cooling.'"
                    default: true
                    selector:
                        boolean: {}

                max_outdoor_dewpoint_sys:
                    name: "Max Outdoor Dew Point (system units)"
                    description: "Block natural ventilation if outdoor dew point exceeds this (e.g., 65Â°F / 18.3Â°C)."
                    default: 65.0
                    selector:
                        number:
                            min: 30
                            max: 80
                            step: 0.5

                muggy_delta_dp_sys:
                    name: "Muggy Delta Dew Point (system units)"
                    description: "Block natural ventilation if (outdoor_dp - indoor_dp) is greater than or equal to this amount."
                    default: 2.0
                    selector:
                        number:
                            min: 0.0
                            max: 10.0
                            step: 0.5

                economizer_delta_h:
                    name: "Economizer Enthalpy Delta (kJ/kg)"
                    description: "Prefer ventilation when outdoor enthalpy is lower than indoor by at least this amount."
                    default: 3.0
                    selector:
                        number:
                            min: 0.0
                            max: 20.0
                            step: 0.5

                economizer_delta_ah:
                    name: "Economizer Absolute Humidity Delta (g/mÂ³)"
                    description: "If enthalpy isn't favorable, still prefer ventilation when AH_out is sufficiently lower than AH_in."
                    default: 2.0
                    selector:
                        number:
                            min: 0.0
                            max: 10.0
                            step: 0.5

                baro_pressure_sensor:
                    name: "Barometric Pressure (optional)"
                    description: "If provided, overrides sea-level assumption for psychrometrics. Supports kPa, hPa/mbar, Pa, inHg, mmHg."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor"]
                site_elevation_m:
                    name: "Site Elevation (m, optional)"
                    description: "If no pressure sensor, estimate pressure from elevation. Sensor > manual > LUT by state > sea level."
                    default: 0
                    selector:
                        number:
                            min: -200
                            max: 5000
                            step: 1
                            unit_of_measurement: "m"

        air_quality_rmot:
            name: Air Quality & RMOT (Optional)
            icon: mdi:molecule-co2
            collapsed: true
            input:
                co2_enable:
                    name: "Enable COâ‚‚ Preference"
                    description: "When indoor COâ‚‚ exceeds outdoor by a threshold, favor ventilation and nudge targets (seasonally)."
                    default: false
                    selector:
                        boolean: {}

                co2_indoor_sensor:
                    name: "Indoor COâ‚‚ (ppm)"
                    description: "Your indoor COâ‚‚ sensor in ppm (optional)."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor"]

                co2_outdoor_sensor:
                    name: "Outdoor COâ‚‚ (ppm)"
                    description: "Outdoor (or baseline) COâ‚‚ in ppm (optional)."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor"]

                co2_delta_ppm:
                    name: "COâ‚‚ Delta Threshold (ppm)"
                    description: "Treat as ventilation priority when Indoor - Outdoor â‰¥ this value."
                    default: 400
                    selector:
                        number:
                            min: 100
                            max: 2000
                            step: 50

                co2_bias_max_sys:
                    name: "Max COâ‚‚ Temperature Bias (system units)"
                    description: "Maximum seasonal nudge: warmer in winter, cooler in summer, scaled by COâ‚‚ gap (shoulder = 0)."
                    default: 0.5
                    selector:
                        number:
                            min: 0.0
                            max: 3.0
                            step: 0.1

                rmot_enable:
                    name: "Use Running Mean Outdoor Temperature (RMOT)"
                    description: "If enabled, provide an RMOT sensor (Â°C/Â°F). Replaces outdoor temp in the adaptive model."
                    default: false
                    selector:
                        boolean: {}

                rmot_sensor:
                    name: "RMOT Sensor"
                    description: "A rolling mean sensor (e.g., 7-14 day average of daily means). Use HA helpers or a Stats sensor."
                    default: sensor.none
                    selector:
                        entity:
                            domain: ["sensor", "input_number"]

        manual_override:
            name: Manual Override Detection
            icon: mdi:hand-back-right
            collapsed: true
            input:
                manual_override_enable:
                    name: "Enable Manual Override Detection"
                    description: "Pause automation when user manually adjusts thermostat, allowing manual control for a period."
                    default: true
                    selector:
                        boolean: {}

                manual_override_duration_min:
                    name: "Override Duration (minutes)"
                    description: "How long to pause automation after detecting manual adjustment (0 = disabled)."
                    default: 60
                    selector:
                        number:
                            min: 0
                            max: 480
                            step: 5
                            mode: slider

                manual_override_tolerance:
                    name: "Detection Tolerance (climate units)"
                    description: "Minimum change to count as manual override. Prevents false triggers from small setpoint drift."
                    default: 1.0
                    selector:
                        number:
                            min: 0.1
                            max: 5.0
                            step: 0.1

                manual_override_action:
                    name: "Override Detected Action (optional)"
                    description: "Actions to run when manual override is detected (notify user, etc.)."
                    default: []
                    selector:
                        action: {}

                learn_from_overrides:
                    name: "Learn from Manual Adjustments"
                    description: "Gradually adjust comfort model based on your manual temperature changes. Learns your preferences over time."
                    default: true
                    selector:
                        boolean: {}

                learning_rate:
                    name: "Learning Rate"
                    description: "How quickly to adapt to manual changes. Higher = faster learning but less stable. 0.1 = conservative, 0.3 = aggressive."
                    default: 0.15
                    selector:
                        number:
                            min: 0.05
                            max: 0.5
                            step: 0.05

                learned_offset_helper:
                    name: "Learned Offset Storage (input_number helper)"
                    description: "Create an input_number helper to store learned preferences. IMPORTANT: set its minimum below 0 (e.g., -10) and maximum above 0 so both warmer and cooler manual changes can be learned. Leave empty to disable learning persistence."
                    default: ""
                    selector:
                        entity:
                            domain: ["input_number"]
                            multiple: false

                manual_override_until:
                    name: "Manual Override Until (input_datetime helper)"
                    description: "Required for override to work correctly. Create an input_datetime helper (date and time) to store when manual override expires. Without this, override will not persist across automation restarts."
                    default: ""
                    selector:
                        entity:
                            domain: ["input_datetime"]
                            multiple: false

        pause:
            name: HVAC Pause
            icon: mdi:pause-octagon
            collapsed: true
            input:
                pause_sensors:
                    name: "Doors/Windows to Monitor"
                    description: "Binary sensors that represent openings. HVAC pauses when any are open."
                    default: []
                    selector:
                        entity:
                            domain: ["binary_sensor"]
                            multiple: true
                            device_class: ["door", "opening", "window"]

                pause_open_delay:
                    name: "Pause after Open (sec)"
                    description: "Delay before pausing HVAC after an opening turns ON."
                    default: 60
                    selector:
                        number:
                            min: 0
                            max: 900
                            step: 5
                            mode: slider

                pause_close_delay:
                    name: "Resume after Close (sec)"
                    description: "Delay before resuming HVAC after all openings are OFF."
                    default: 30
                    selector:
                        number:
                            min: 0
                            max: 900
                            step: 5
                            mode: slider

                pause_max_timeout_min:
                    name: "Max Pause Timeout (min)"
                    description: "If > 0, run a timeout action if an opening stays ON beyond this duration."
                    default: 0
                    selector:
                        number:
                            min: 0
                            max: 240
                            step: 1

                pause_action:
                    name: "Pause Action (optional)"
                    description: "Extra things to do when pausing (notify, lights, etc.)."
                    default: []
                    selector:
                        action: {}


                accelerate_resume_enable:
                    name: "Accelerate Resume Near Risk"
                    description: "When indoor temp is close to freeze/overheat guards, shorten resume (and optionally open) delays."
                    default: true
                    selector:
                        boolean: {}

                warn_band_sys:
                    name: "Risk Warning Band (system units)"
                    description: "Range around each guard where acceleration starts (e.g., 3Â°F / 1.5Â°C)."
                    default: 3.0
                    selector:
                        number:
                            min: 1.0
                            max: 10.0
                            step: 0.5

                min_resume_delay_sec:
                    name: "Minimum Resume Delay (sec)"
                    description: "Floor for resume delay when accelerating near risk (prevents chatter)."
                    default: 5
                    selector:
                        number:
                            min: 0
                            max: 60
                            step: 1

                min_open_delay_sec:
                    name: "Minimum Open Delay (sec)"
                    description: "Optional floor for open-delay when accelerating (set >0 to also trim open delay near risk)."
                    default: 5
                    selector:
                        number:
                            min: 0
                            max: 60
                            step: 1

                accel_strength:
                    name: "Acceleration Strength (0â€“1.5)"
                    description: "How aggressively to shorten delays near risk. 0.8 is a good starting point."
                    default: 0.8
                    selector:
                        number:
                            min: 0.0
                            max: 1.5
                            step: 0.1
                resume_action:
                    name: "Resume Action (optional)"
                    description: "Extra things to do when resuming (notify, restore scene, etc.)."
                    default: []
                    selector:
                        action: {}

                pause_timeout_action:
                    name: "Timeout Action (optional)"
                    description: "Actions to run if Max Pause Timeout is exceeded while still open."
                    default: []
                    selector:
                        action: {}

        safety:
            name: Safety & Guards
            icon: mdi:shield-alert
            collapsed: true
            input:
                safety_min_sys:
                    name: "Absolute Minimum Temperature (system units)"
                    description: "Hard floor to prevent freeze risk. Set â‰¥ 40Â°F / 4.4Â°C. All targets and bands will never go below this."
                    default: 45.0
                    selector:
                        number:
                            min: 35.0
                            max: 60.0
                            step: 0.5
                safety_max_sys:
                    name: "Absolute Maximum Temperature (system units)"
                    description: "Hard ceiling to prevent excessive heat. All targets and bands will never exceed this."
                    default: 92.0
                    selector:
                        number:
                            min: 80.0
                            max: 100.0
                            step: 0.5
                freeze_protect_enable:
                    name: "Freeze-Protect (block HVAC pause when too cold indoors)"
                    description: "If indoor temp is at/below the freeze guard, treat doors/windows as closed to avoid damaging cold."
                    default: true
                    selector:
                        boolean: {}
                freeze_guard_sys:
                    name: "Freeze Guard Threshold (system units)"
                    description: "If indoor temp â‰¤ this, HVAC Pause is disabled (doors/windows ignored)."
                    default: 45.0
                    selector:
                        number:
                            min: 35.0
                            max: 55.0
                            step: 0.5
                overheat_protect_enable:
                    name: "Overheat-Protect (block HVAC pause when too hot indoors)"
                    description: "If indoor temp is at/above the overheat guard, treat doors/windows as closed to allow cooling."
                    default: true
                    selector:
                        boolean: {}
                overheat_guard_sys:
                    name: "Overheat Guard Threshold (system units)"
                    description: "If indoor temp â‰¥ this, HVAC Pause is disabled (doors/windows ignored)."
                    default: 88.0
                    selector:
                        number:
                            min: 80.0
                            max: 95.0
                            step: 0.5

        control:
            name: Control Bands / Debounce
            icon: mdi:clock-outline
            collapsed: true
            input:
                heat_deadband:
                    name: "Heat Deadband (system units)"
                    description: "Minimum difference between current and target to trigger heating changes."
                    default: 1.5
                    selector:
                        number:
                            min: 0.5
                            max: 3.0
                            step: 0.1

                cool_deadband:
                    name: "Cool Deadband (system units)"
                    description: "Minimum difference between current and target to trigger cooling changes."
                    default: 1.0
                    selector:
                        number:
                            min: 0.5
                            max: 3.0
                            step: 0.1

                inside_band_half_width:
                    name: "Inside-Band Half-Width (system units)"
                    description: "Width around the adaptive target when your thermostat supports Heat/Cool (auto)."
                    default: 1.0
                    selector:
                        number:
                            min: 0.5
                            max: 3.0
                            step: 0.1

                auto_min_separation:
                    name: "Auto Mode Min Separation (system units)"
                    description: "If your thermostat requires a minimum gap between low/high in Heat/Cool (Auto), set it here. Leave 0 if not enforced."
                    default: 0.0
                    selector:
                        number:
                            min: 0.0
                            max: 5.0
                            step: 0.1

                thermostat_profile:
                    name: "Thermostat Profile"
                    description: "Optional vendor profile to enforce a safe minimum separation in Auto/Heat-Cool when the device doesn't report one. 'Auto (detect/device)' prefers the device-advertised minimum if available."
                    default: "Auto (detect/device)"
                    selector:
                        select:
                            options:
                                - "Auto (detect/device)"
                                - "Ecobee"
                                - "Google Nest"
                                - "Honeywell T-series (T5/T6/T9)"
                                - "Honeywell Home/Resideo (Lyric/Prestige/VisionPRO)"
                                - "Honeywell T6 Pro Z-Wave"
                                - "Emerson Sensi"
                                - "Carrier Infinity/Edge"
                                - "Bryant Evolution"
                                - "Trane/American Standard"
                                - "Lennox iComfort"
                                - "Bosch Connected Control"
                                - "Amazon Smart Thermostat"
                                - "Tado"
                                - "Netatmo"
                                - "Hive"
                                - "Heatmiser Neo"
                                - "Mysa (Electric Heat)"
                                - "Wyze"
                                - "Tuya Zigbee (Generic)"
                                - "Zigbee (ZHA Generic)"
                                - "Z-Wave (ZWAVE_JS Generic)"
                                - "Generic (no minimum)"

                vendor_min_override_sys:
                    name: "Override Vendor Min Separation (system units, optional)"
                    description: "If set (>0), this value overrides the selected profileâ€™s built-in minimum. Use your thermostatâ€™s documented minimum or installer setting. Leave 0 to keep the profile default."
                    default: 0.0
                    selector:
                        number:
                            min: 0.0
                            max: 5.0
                            step: 0.1

                mode_cooldown_min:
                    name: "Min Mode Cooldown (min)"
                    description: "Optional minimum minutes between switching HVAC modes to reduce short-cycling."
                    default: 10
                    selector:
                        number:
                            min: 0
                            max: 60
                            step: 1

        sleep:
            name: Sleep / Circadian Preferences
            icon: mdi:sleep
            collapsed: true
            input:
                sleep_enable:
                    name: "Enable Sleep Cooling"
                    description: "Apply a nighttime cooling bias and optional tighter band."
                    default: true
                    selector:
                        boolean: {}

                sleep_mode_entity:
                    name: "Sleep Mode (optional)"
                    description: "Binary sensor or helper that is ON during sleep (e.g., Bedtime, Sleep Mode). Overrides schedule when ON."
                    default: binary_sensor.none
                    selector:
                        entity:
                            domain: ["binary_sensor", "input_boolean"]

                sleep_start_time:
                    name: "Sleep Start"
                    description: "Time of day sleep usually begins (local)."
                    default: "22:00:00"
                    selector:
                        time: {}

                sleep_end_time:
                    name: "Sleep End"
                    description: "Time of day sleep usually ends (local)."
                    default: "07:00:00"
                    selector:
                        time: {}

                sleep_bias_sys:
                    name: "Sleep Bias (system units)"
                    description: "Shift the adaptive target by this amount during sleep (negative = cooler)."
                    default: -1.0
                    selector:
                        number:
                            min: -5.0
                            max: 5.0
                            step: 0.1

                sleep_tighten_sys:
                    name: "Tighten Band (system units)"
                    description: "Reduce the inside-band half-width during sleep for steadier temps (0 = no change)."
                    default: 0.0
                    selector:
                        number:
                            min: 0.0
                            max: 3.0
                            step: 0.1

        debug:
            name: Debug
            icon: mdi:bug-outline
            collapsed: true
            input:
                debug_level:
                    name: "Level"
                    description: "Select 'basic' for helpful trace logs; 'verbose' adds psychrometrics and band calculations."
                    default: "basic"
                    selector:
                        select:
                            options:
                                - "off"
                                - "basic"
                                - "verbose"

# ---------------------- VARIABLES ----------------------
variables:
    blueprint_version: "4.18.5"
    # Bind inputs
    climate_entity_id: !input climate_entity
    indoor_sensor_id: !input indoor_temp_sensor
    outdoor_sensor_id: !input outdoor_temp_sensor
    _raw_mrt_sensor_values: !input mean_radiant_temp_sensor
    _raw_rh_in_values: !input indoor_humidity_sensor
    _raw_rh_out_values: !input outdoor_humidity_sensor
    _raw_occupancy_values: !input occupancy_sensor
    _raw_co2_in_values: !input co2_indoor_sensor
    _raw_co2_out_values: !input co2_outdoor_sensor
    _raw_rmot_values: !input rmot_sensor
    _raw_season_entity_values: !input season_entity
    units_override_val: !input units_override
    category: !input comfort_category
    energy_save: !input energy_save_mode
    nat_vent_enable: !input natural_ventilation_enable
    dv_sys_in: !input natural_ventilation_threshold
    setback_sys: !input setback_temperature_offset
    min_sys_c_pref: !input min_comfort_temp_c
    max_sys_c_pref: !input max_comfort_temp_c
    min_sys_f_pref: !input min_comfort_temp_f
    max_sys_f_pref: !input max_comfort_temp_f
    use_operative: !input use_operative_temperature
    v_ms: !input air_velocity
    adaptive_fan: !input adaptive_air_velocity
    humid_enable: !input humidity_comfort_enable
    precision: !input comfort_precision_mode
    heat_db_sys: !input heat_deadband
    cool_db_sys: !input cool_deadband
    inside_half_sys: !input inside_band_half_width
    auto_sep_sys: !input auto_min_separation
    cooldown_min: !input mode_cooldown_min
    dbg: !input debug_level
    pause_entities: !input pause_sensors
    pause_open_delay_in: !input pause_open_delay
    pause_close_delay_in: !input pause_close_delay
    pause_timeout_min_val: !input pause_max_timeout_min

    # Safety inputs
    safety_min_sys_in: !input safety_min_sys
    safety_max_sys_in: !input safety_max_sys
    freeze_protect_enable: !input freeze_protect_enable
    freeze_guard_sys_in: !input freeze_guard_sys
    overheat_protect_enable: !input overheat_protect_enable
    overheat_guard_sys_in: !input overheat_guard_sys

    # Pause acceleration inputs
    accelerate_resume_enable: !input accelerate_resume_enable
    warn_band_sys_in: !input warn_band_sys
    min_resume_delay_sec_in: !input min_resume_delay_sec
    min_open_delay_sec_in: !input min_open_delay_sec
    accel_strength_in: !input accel_strength

    # Sleep inputs
    sleep_enable: !input sleep_enable
    _raw_sleep_entity_values: !input sleep_mode_entity
    sleep_start_str: !input sleep_start_time
    sleep_end_str: !input sleep_end_time
    sleep_bias_sys_in: !input sleep_bias_sys
    sleep_tighten_sys_in: !input sleep_tighten_sys

    # Manual override inputs
    manual_override_enable: !input manual_override_enable
    manual_override_duration_min: !input manual_override_duration_min
    manual_override_tolerance: !input manual_override_tolerance
    learn_from_overrides: !input learn_from_overrides
    learning_rate: !input learning_rate
    _raw_learned_offset_helper: !input learned_offset_helper
    _raw_manual_override_until: !input manual_override_until

    # --------- Unit inference ---------
    _u_indoor: "{{ state_attr(indoor_sensor_id, 'unit_of_measurement') | default('', true) | string }}"
    _u_outdoor: >
        {% if outdoor_sensor_id|string and outdoor_sensor_id.startswith('weather.') %}
          {{ state_attr(outdoor_sensor_id, 'temperature_unit') | default('', true) | string }}
        {% else %}
          {{ state_attr(outdoor_sensor_id, 'unit_of_measurement') | default('', true) | string }}
        {% endif %}
    _u_climate: >
        {{ state_attr(climate_entity_id, 'temperature_unit') | default(state_attr(climate_entity_id, 'unit_of_measurement'), true) | default('', true) | string }}
    is_imperial: >
        {% if units_override_val == 'c' %} false
        {% elif units_override_val == 'f' %} true
        {% else %}
          {% set u = (_u_indoor or _u_outdoor or _u_climate) | lower %}
          {{ 'f' in u }}
        {% endif %}
    _is_weather_in:  "{{ indoor_sensor_id  is string and indoor_sensor_id.startswith('weather.') }}"
    _is_weather_out: "{{ outdoor_sensor_id is string and outdoor_sensor_id.startswith('weather.') }}"
    unit_sym: "{{ 'Â°F' if is_imperial else 'Â°C' }}"

    # Unit conversion helpers (reduces repetition)
    _to_sys_mult: "{{ 9/5 if is_imperial else 1 }}"
    _to_sys_add: "{{ 32 if is_imperial else 0 }}"

    mrt_sensor_id: >
        {% set raw = _raw_mrt_sensor_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}
    rh_in_id: >
        {% set raw = _raw_rh_in_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}
    rh_out_id: >
        {% set raw = _raw_rh_out_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none', 'weather.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}
    occupancy_sensor_id: >
        {% set raw = _raw_occupancy_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'binary_sensor.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}

    sleep_entity_id: >
        {% set raw = _raw_sleep_entity_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'binary_sensor.none', 'input_boolean.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}

    learned_offset_helper_id: >
        {% set raw = _raw_learned_offset_helper %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'input_number.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}

    # Read current learned offset (in system units, will be converted to C)
    learned_offset_sys: >
        {% if learned_offset_helper_id %}
          {{ states(learned_offset_helper_id) | float(0) }}
        {% else %}0{% endif %}
    learned_offset_c: "{{ (learned_offset_sys * 5/9) if is_imperial else learned_offset_sys }}"

    # Manual override helper parsing
    manual_override_until_id: >
        {% set raw = _raw_manual_override_until %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'input_datetime.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}

    # Check if manual override is currently active
    is_override_active: >
        {% if not manual_override_enable or manual_override_duration_min | int(0) <= 0 or not manual_override_until_id %}
          false
        {% else %}
          {% set until_ts = state_attr(manual_override_until_id, 'timestamp') %}
          {% set now_ts = as_timestamp(now()) %}
          {% if until_ts is none or now_ts is none %}
            false
          {% else %}
            {{ now_ts < until_ts }}
          {% endif %}
        {% endif %}

    # Regional Presets
    regional_defaults_enable: !input regional_defaults_enable
    state_code: !input user_state_code
    bias_preset: !input seasonal_bias_preset
    bias_intensity_raw: !input bias_preset_intensity

    # Psychrometrics toggles/thresholds (user inputs)
    psychro_enable: !input psychro_enable
    max_outdoor_dp_sys_in: !input max_outdoor_dewpoint_sys
    muggy_delta_dp_sys_in: !input muggy_delta_dp_sys
    econ_dh_in: !input economizer_delta_h
    econ_dah_in: !input economizer_delta_ah

    # Air quality / RMOT
    co2_enable: !input co2_enable
    co2_delta_ppm_in: !input co2_delta_ppm
    co2_bias_max_sys: !input co2_bias_max_sys
    rmot_enable: !input rmot_enable
    co2_in_id: >
        {% set raw = _raw_co2_in_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}
    co2_out_id: >
        {% set raw = _raw_co2_out_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}
    rmot_sensor_id: >
        {% set raw = _raw_rmot_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none', 'input_number.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}

    _raw_baro_values: !input baro_pressure_sensor
    baro_sensor_id: >
        {% set raw = _raw_baro_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}

    # Seasons (manual biases)
    season_entity_id: >
        {% set raw = _raw_season_entity_values %}
        {% if raw is string %}
          {% set e = raw %}
        {% elif raw is iterable %}
          {% set e = (raw[0] if raw|length > 0 else '') %}
        {% else %}
          {% set e = '' %}
        {% endif %}
        {% set e = e | default('', true) %}
        {% set v = e | string | lower %}
        {% if v not in ['', 'none', 'sensor.none'] %}{{ e }}{% else %}{{ '' }}{% endif %}
    winter_bias_sys_manual: !input winter_bias
    summer_bias_sys_manual: !input summer_bias
    shoulder_bias_sys_manual: !input shoulder_bias

    # Numeric normalization
    bias_intensity: "{{ bias_intensity_raw | float(1.0) }}"

    # Safety bounds & guards in Â°C and system units
    safety_min_c: "{{ ((safety_min_sys_in|float - 32) * 5/9) if is_imperial else (safety_min_sys_in|float) }}"
    safety_max_c: "{{ ((safety_max_sys_in|float - 32) * 5/9) if is_imperial else (safety_max_sys_in|float) }}"
    freeze_guard_c: "{{ ((freeze_guard_sys_in|float - 32) * 5/9) if is_imperial else (freeze_guard_sys_in|float) }}"
    overheat_guard_c: "{{ ((overheat_guard_sys_in|float - 32) * 5/9) if is_imperial else (overheat_guard_sys_in|float) }}"
    t_in_sys: >
        {% set v = (state_attr(indoor_sensor_id,'temperature') if _is_weather_in else states(indoor_sensor_id)) | float(20) %}
        {% set u = (state_attr(indoor_sensor_id,'temperature_unit') if _is_weather_in else state_attr(indoor_sensor_id,'unit_of_measurement')) | default('', true) | string %}
        {% set c = ((v - 32) * 5 / 9) if (u|lower in ['Â°f','f','fahrenheit'] or (u == '' and is_imperial)) else v %}
        {{ (c * 9/5 + 32) if is_imperial else c }}

    # --------- Risk-aware pause acceleration ---------
    warn_band_sys: "{{ warn_band_sys_in | float(3.0) }}"
    _risk_cold: "{{ [ (freeze_guard_sys_in | float(45)) - (t_in_sys | float(0)), 0 ] | max }}"
    _risk_hot:  "{{ [ (t_in_sys | float(0)) - (overheat_guard_sys_in | float(88)), 0 ] | max }}"
    risk_near: >
        {% set wb = warn_band_sys | float(3.0) %}
        {% set r = ([ _risk_cold | float(0), _risk_hot | float(0) ] | max) %}
        {% if wb <= 0 %} 0.0
        {% else %} {{ [ (r / wb), 1.0 ] | min }} {% endif %}
    risk_active: >
        {{ (accelerate_resume_enable | bool) and (risk_near | float(0)) > 0 and not ((t_in_sys | float(0)) <= (freeze_guard_sys_in | float(45)) or (t_in_sys | float(0)) >= (overheat_guard_sys_in | float(88))) }}

    # Safety re-enable flag: when approaching guards (risk_near high) and any guard is enabled
    safety_reenable_needed: >
        {% set r = risk_near | float(0) %}
        {{ (freeze_protect_enable or overheat_protect_enable) and (r >= 0.7) }}

    # Keep copies of user-configured base delays (seconds)
    pause_open_delay_base: "{{ pause_open_delay_in | int(0) }}"
    pause_close_delay_base: "{{ pause_close_delay_in | int(0) }}"

    # Compute accelerated delays (seconds), with floors to avoid chatter
    pause_close_delay_eff: >
        {% set base = pause_close_delay_base | int(0) %}
        {% if risk_active %}
          {% set k = accel_strength_in | float(0.8) %}
          {% set scaled = (base * (1 - (k * (risk_near | float(0))))) | round(0) %}
          {{ [ min_resume_delay_sec_in | int(5), scaled | int(0) ] | max }}
        {% else %}
          {{ base }}
        {% endif %}

    pause_open_delay_eff: >
        {% set base = pause_open_delay_base | int(0) %}
        {% if risk_active %}
          {# Use 50% of acceleration strength for open delay (less aggressive than resume) #}
          {% set k = (0.5 * (accel_strength_in | float(0.8))) %}
          {% set scaled = (base * (1 - (k * (risk_near | float(0))))) | round(0) %}
          {{ [ min_open_delay_sec_in | int(5), scaled | int(0) ] | max }}
        {% else %}
          {{ base }}
        {% endif %}

    # Shadow the original delay variables so existing actions automatically pick up the effective values


    # --------- Input conversions to Â°C ---------
    min_sys: "{{ min_sys_f_pref if is_imperial else min_sys_c_pref }}"
    max_sys: "{{ max_sys_f_pref if is_imperial else max_sys_c_pref }}"
    dv_sys: >
        {# Effective ventilation threshold after regional preset #}
        {% set base = dv_sys_in | float(2.0) %}
        {% if regional_defaults_enable %}
          {% set r = (state_code.split(' ')[0] if state_code else '') %}
          {% set tight_states = ['AZ','NV','TX','FL','LA','MS','AL','GA','SC'] %}
          {% set loose_states = ['CA','OR','WA','CO','UT','NM'] %}
          {% if r in tight_states %}
            {{ 1.5 }}
          {% elif r in loose_states %}
            {{ 2.0 }}
          {% else %}
            {{ base }}
          {% endif %}
        {% else %}
          {{ base }}
        {% endif %}
    setback_c: "{{ (setback_sys|float * 5/9) if is_imperial else (setback_sys|float) }}"
    min_c: "{{ [ ((min_sys|float - 32) * 5/9) if is_imperial else (min_sys|float),  safety_min_c ] | max }}"
    max_c: "{{ [ ((max_sys|float - 32) * 5/9) if is_imperial else (max_sys|float),  safety_max_c ] | min }}"
    inside_half_c: "{{ (inside_half_sys|float * 5/9) if is_imperial else (inside_half_sys|float) }}"

    # --------- Regional presets for psychrometrics/COâ‚‚ (base values in Â°C / ppm / kJ/kg / g/mÂ³) ---------
    _region_from_state: >
        {% set s = (state_code.split(' ')[0] if state_code else '') %}
        {% set hot_humid = ['FL','LA','MS','AL','GA','SC','HI','TX'] %}
        {% set hot_dry = ['AZ','NV','NM','UT'] %}
        {% set marine = ['CA','OR','WA'] %}
        {% set mixed_humid = ['NC','TN','KY','AR','OK','VA','MD','DC','DE','NJ','PA','MO','IL','IN','OH','KS','WV'] %}
        {% set mixed_dry = ['CO','WY','ID','MT','ND','SD','NE'] %}
        {% set cold = ['NY','CT','RI','MA','VT','NH','ME','MI','WI','MN','IA'] %}
        {% set very_cold = ['AK'] %}
        {% if s in hot_humid %} Hot-Humid
        {% elif s in hot_dry %} Hot-Dry
        {% elif s in marine %} Marine
        {% elif s in mixed_humid %} Mixed-Humid
        {% elif s in mixed_dry %} Mixed-Dry
        {% elif s in very_cold %} Very Cold
        {% elif s in cold %} Cold
        {% else %} None {% endif %}

    region_pick: >
        {% if not regional_defaults_enable %} None
        {% elif bias_preset == 'Auto from State' %} {{ _region_from_state }}
        {% elif bias_preset == 'None (Manual)' %} None
        {% else %} {{ bias_preset }} {% endif %}

    # Baselines by region
    _dp_max_c: >
        {% set r = region_pick %}
        {% if r == 'Hot-Humid' %} 18.0
        {% elif r == 'Hot-Dry' %} 19.0
        {% elif r == 'Marine' %} 16.5
        {% elif r == 'Mixed-Humid' %} 17.0
        {% elif r == 'Mixed-Dry' %} 16.0
        {% elif r == 'Cold' %} 17.0
        {% elif r == 'Very Cold' %} 16.0
        {% else %} {{ none }} {% endif %}

    _muggy_delta_c: >
        {% set r = region_pick %}
        {% if r == 'Hot-Humid' %} 1.0
        {% elif r == 'Hot-Dry' %} 2.0
        {% elif r == 'Marine' %} 1.5
        {% elif r == 'Mixed-Humid' %} 1.5
        {% elif r == 'Mixed-Dry' %} 1.5
        {% elif r == 'Cold' %} 1.5
        {% elif r == 'Very Cold' %} 1.5
        {% else %} {{ none }} {% endif %}

    _econ_dh: >
        {% set r = region_pick %}
        {% if r == 'Hot-Humid' %} 4.0
        {% elif r == 'Hot-Dry' %} 2.0
        {% elif r == 'Marine' %} 3.0
        {% elif r == 'Mixed-Humid' %} 3.5
        {% elif r == 'Mixed-Dry' %} 2.5
        {% elif r == 'Cold' %} 3.0
        {% elif r == 'Very Cold' %} 3.0
        {% else %} {{ none }} {% endif %}

    _econ_dah: >
        {% set r = region_pick %}
        {% if r == 'Hot-Humid' %} 3.0
        {% elif r == 'Hot-Dry' %} 1.0
        {% elif r == 'Marine' %} 2.0
        {% elif r == 'Mixed-Humid' %} 2.0
        {% elif r == 'Mixed-Dry' %} 1.5
        {% elif r == 'Cold' %} 2.0
        {% elif r == 'Very Cold' %} 2.0
        {% else %} {{ none }} {% endif %}

    _co2_delta: >
        {% set r = region_pick %}
        {% if r == 'Hot-Humid' %} 450
        {% elif r == 'Hot-Dry' %} 450
        {% elif r == 'Marine' %} 400
        {% elif r == 'Mixed-Humid' %} 450
        {% elif r == 'Mixed-Dry' %} 450
        {% elif r == 'Cold' %} 450
        {% elif r == 'Very Cold' %} 500
        {% else %} {{ none }} {% endif %}

    # Apply presets (convert to system units where needed)
    max_outdoor_dp_sys: >
        {% if _dp_max_c is not none %}
          {{ (_dp_max_c * 9/5 + 32) if is_imperial else _dp_max_c }}
        {% else %} {{ max_outdoor_dp_sys_in }} {% endif %}
    muggy_delta_dp_sys: >
        {% if _muggy_delta_c is not none %}
          {{ (_muggy_delta_c * 9/5) if is_imperial else _muggy_delta_c }}
        {% else %} {{ muggy_delta_dp_sys_in }} {% endif %}
    econ_dh: "{{ _econ_dh if _econ_dh is not none else econ_dh_in }}"
    econ_dah: "{{ _econ_dah if _econ_dah is not none else econ_dah_in }}"
    co2_delta_ppm: "{{ _co2_delta if _co2_delta is not none else co2_delta_ppm_in }}"

    # --------- Psychrometric thresholds to Â°C ---------
    max_outdoor_dp_c: "{{ ((max_outdoor_dp_sys|float - 32) * 5/9) if is_imperial else (max_outdoor_dp_sys|float) }}"
    muggy_delta_dp_c: "{{ (muggy_delta_dp_sys|float * 5/9) if is_imperial else (muggy_delta_dp_sys|float) }}"
    co2_bias_max_c: "{{ (co2_bias_max_sys|float * 5/9) if is_imperial else (co2_bias_max_sys|float) }}"

    tol_c: "{% if category == 'I' %}2.0{% elif category == 'II' %}3.0{% else %}4.0{% endif %}"

    # --------- Normalize temps to Â°C ---------
    t_out_c_raw: >
        {% set v = (state_attr(outdoor_sensor_id,'temperature') if _is_weather_out else states(outdoor_sensor_id)) | float(20) %}
        {% set u = (state_attr(outdoor_sensor_id,'temperature_unit') if _is_weather_out else state_attr(outdoor_sensor_id,'unit_of_measurement')) | default('', true) | string %}
        {% if u|lower in ['Â°f','f','fahrenheit'] or (u == '' and is_imperial) %} {{ ((v - 32) * 5 / 9) }}
        {% else %} {{ v }} {% endif %}

    # Optional RMOT source
    t_rmot_c: >
        {# Robust RMOT parsing: skip if unknown/unavailable, handle units #}
        {% if rmot_enable and rmot_sensor_id %}
          {% set raw = states(rmot_sensor_id) %}
          {% set v = (raw if raw not in ['unknown','unavailable',''] else none) %}
          {% if v is not none %}
            {% set vf = v | float(none) %}
            {% set u = state_attr(rmot_sensor_id, 'unit_of_measurement') | default('', true) | string %}
            {% if vf is number %}
              {% if u|lower in ['Â°f','f','fahrenheit'] or (u == '' and is_imperial) %} {{ ((vf - 32) * 5 / 9) }}
              {% else %} {{ vf }} {% endif %}
            {% else %}
              {{ none }}
            {% endif %}
          {% else %}
            {{ none }}
          {% endif %}
        {% else %} {{ none }} {% endif %}

    t_out_c: "{{ t_rmot_c if t_rmot_c is not none else t_out_c_raw }}"

    t_in_air_c: >
        {% set v = (state_attr(indoor_sensor_id,'temperature') if _is_weather_in else states(indoor_sensor_id)) | float(20) %}
        {% set u = (state_attr(indoor_sensor_id,'temperature_unit') if _is_weather_in else state_attr(indoor_sensor_id,'unit_of_measurement')) | default('', true) | string %}
        {% if u|lower in ['Â°f','f','fahrenheit'] or (u == '' and is_imperial) %} {{ ((v - 32) * 5 / 9) }}
        {% else %} {{ v }} {% endif %}

    t_mrt_c: >
        {% if mrt_sensor_id %}
          {% set v = (state_attr(mrt_sensor_id,'temperature') if _is_weather_in else states(mrt_sensor_id)) | float(t_in_air_c) %}
          {% set u = (state_attr(mrt_sensor_id,'temperature_unit') if _is_weather_in else state_attr(mrt_sensor_id,'unit_of_measurement')) | default('', true) | string %}
          {% if u|lower in ['Â°f','f','fahrenheit'] or (u == '' and is_imperial) %} {{ ((v - 32) * 5 / 9) }}
          {% else %} {{ v }} {% endif %}
        {% else %} {{ t_in_air_c }} {% endif %}

    t_in_c: >
        {% if use_operative and mrt_sensor_id %} {{ ((t_in_air_c + t_mrt_c) | float / 2) | round(2) }}
        {% else %} {{ t_in_air_c }} {% endif %}

    # --------- RH (%) ---------
    rh_in: "{% if rh_in_id %}{{ states(rh_in_id) | float(50) }}{% else %}50{% endif %}"
    rh_out: >
        {% if rh_out_id %}
          {% if _is_weather_out %}
            {{ state_attr(rh_out_id, 'humidity') | float(50) }}
          {% elif state_attr(rh_out_id, 'humidity') is not none %}
            {{ state_attr(rh_out_id, 'humidity') | float(50) }}
          {% else %}
            {{ states(rh_out_id) | float(50) }}
          {% endif %}
        {% else %}50{% endif %}

    # --------- Pressure model (sensor > manual elevation > LUT by state > sea level) ---------
    # Approximate average elevations by state (meters). Values are coarse; prefer sensor/manual when available.
    _state_elev_lut: >
        {{ {
          'AL':150,'AK':580,'AZ':1250,'AR':200,'CA':880,'CO':2000,'CT':150,'DC':20,'DE':20,'FL':30,
          'GA':180,'HI':920,'ID':1520,'IL':180,'IN':210,'IA':335,'KS':610,'KY':230,'LA':30,'ME':180,
          'MD':110,'MA':150,'MI':270,'MN':370,'MS':90,'MO':240,'MT':1035,'NE':790,'NV':1675,'NH':300,
          'NJ':80,'NM':1735,'NY':300,'NC':220,'ND':580,'OH':260,'OK':400,'OR':1000,'PA':340,'RI':60,
          'SC':110,'SD':670,'TN':260,'TX':520,'UT':1890,'VT':300,'VA':290,'WA':520,'WV':460,'WI':320,'WY':2040
        } }}
    _state_code: "{{ (state_code.split(' ')[0] if state_code else '') }}"
    lut_elev_m: >
        {% set d = _state_elev_lut %}
        {% if d is mapping and _state_code in d %}{{ d[_state_code] }}{% else %}0{% endif %}

    site_elevation_m_in: !input site_elevation_m
    site_elevation_eff_m: >
        {# prefer manual elevation if not zero/non-default, else LUT when regional presets enabled, else 0 #}
        {% set man = site_elevation_m_in | float(0) %}
        {% if man != 0 %}{{ man }}
        {% elif regional_defaults_enable %}{{ lut_elev_m | float(0) }}
        {% else %}0{% endif %}

    # Convert a barometer reading to kPa (supports several common units)
    _baro_unit: "{{ state_attr(baro_sensor_id, 'unit_of_measurement') | default('', true) | string }}"
    _baro_val_raw: "{{ states(baro_sensor_id) if baro_sensor_id else '' }}"
    _baro_val_num: >
        {% if baro_sensor_id and _baro_val_raw not in ['unknown','unavailable',''] %}
          {{ _baro_val_raw | float(0) }}
        {% else %}{{ none }}{% endif %}
    baro_kpa_from_sensor: >
        {% set v = _baro_val_num %}
        {% if v is not none %}
          {% set u = _baro_unit | lower %}
          {% if 'kpa' in u %}{{ v }}
          {% elif 'hpa' in u or 'mbar' in u %}{{ v / 10.0 }}
          {% elif u == 'pa' %}{{ v / 1000.0 }}
          {% elif 'inhg' in u %}{{ v * 3.38639 }}
          {% elif 'mmhg' in u %}{{ v * 0.133322 }}
          {% else %}{{ none }}{% endif %}
        {% else %}{{ none }}{% endif %}

    # Standard atmosphere adjusted by elevation when no sensor is present
    baro_kpa_from_elev: >
        {% set h = site_elevation_eff_m | float(0) %}
        {% if h > -200 %}
          {{ 101.325 * (1 - 2.25577e-5 * h) ** 5.25588 }}
        {% else %}{{ 101.325 }}{% endif %}

    pressure_kpa: >
        {% if baro_kpa_from_sensor is not none %}{{ baro_kpa_from_sensor }}
        {% else %}{{ baro_kpa_from_elev }}{% endif %}

    # --------- Built-in psychrometrics (T in Â°C, RH in %) ---------
    _psychro_on: "{{ psychro_enable or dbg == 'verbose' }}"
    psat_in_kpa: >
        {% if _psychro_on %}{{ 0.61078 * (2.718281828 ** ((17.2694 * t_in_c) / (t_in_c + 237.3))) }}{% else %}{{ none }}{% endif %}
    psat_out_kpa: >
        {% if _psychro_on %}{{ 0.61078 * (2.718281828 ** ((17.2694 * t_out_c) / (t_out_c + 237.3))) }}{% else %}{{ none }}{% endif %}
    pv_in_kpa:  "{{ ( (rh_in  | float(50) / 100.0) * psat_in_kpa )  if _psychro_on else none }}"
    pv_out_kpa: "{{ ( (rh_out | float(50) / 100.0) * psat_out_kpa ) if _psychro_on else none }}"
    dp_in_c: >
        {% if _psychro_on %}
          {% set x = pv_in_kpa / 0.61078 %}{% set ln = log(x) %}
          {{ (237.3 * ln) / (17.2694 - ln) }}
        {% else %}{{ none }}{% endif %}
    dp_out_c: >
        {% if _psychro_on %}
          {% set x = pv_out_kpa / 0.61078 %}{% set ln = log(x) %}
          {{ (237.3 * ln) / (17.2694 - ln) }}
        {% else %}{{ none }}{% endif %}
    ah_in: >
        {% if _psychro_on %}{% set Tk = t_in_c + 273.15 %}{{ (2.1674 * pv_in_kpa / Tk) * 1000.0 | round(2) }}{% else %}{{ none }}{% endif %}
    ah_out: >
        {% if _psychro_on %}{% set Tk = t_out_c + 273.15 %}{{ (2.1674 * pv_out_kpa / Tk) * 1000.0 | round(2) }}{% else %}{{ none }}{% endif %}
    w_in:  "{{ (0.62198 * pv_in_kpa  / (pressure_kpa - pv_in_kpa))  if (_psychro_on and (pressure_kpa - pv_in_kpa) > 0.1) else none }}"
    w_out: "{{ (0.62198 * pv_out_kpa / (pressure_kpa - pv_out_kpa)) if (_psychro_on and (pressure_kpa - pv_out_kpa) > 0.1) else none }}"
    h_in:  "{{ (1.006 * t_in_c  + w_in  * (2501 + 1.86 * t_in_c))  | round(2) if _psychro_on else none }}"
    h_out: "{{ (1.006 * t_out_c + w_out * (2501 + 1.86 * t_out_c)) | round(2) if _psychro_on else none }}"

    # --------- Occupancy / Energy Save (must be defined before sleep logic) ---------
    occ_now: >
        {% if occupancy_sensor_id %}
          {% set raw = states(occupancy_sensor_id) | default('', true) | string %}
          {% set s = raw | lower %}
          {% set dc = state_attr(occupancy_sensor_id, 'device_class') | default('', true) | string | lower %}
          {# Normalize common truthy/falsey and presence states #}
          {% set on_states  = ['on','home','present','occupied','true','detected','motion'] %}
          {% set off_states = ['off','not_home','away','clear','false','standby','none','closed'] %}
          {% if s in on_states %}
            true
          {% elif s in off_states %}
            false
          {% else %}
            {# Fallbacks by device class: presence/occupancy/motion default false unless explicitly on; person/device_tracker: home=on, not_home=off #}
            {% if dc in ['presence','occupancy','motion'] %}
              {{ s in on_states }}
            {% else %}
              {# Numeric or unknown states: treat >0 as on, else keep previous truthy if possible #}
              {% if s|float(none) is not none %}
                {{ (s | float(0)) > 0 }}
              {% else %}
                {{ s not in ['unknown','unavailable',''] }}
              {% endif %}
            {% endif %}
          {% endif %}
        {% else %}
          true
        {% endif %}

    setback_apply_c: "{{ setback_c if (energy_save and (not (occ_now | default(false) | bool))) else 0 }}"

    # --------- Sleep / Circadian logic ---------
    sleep_bias_c: "{{ (sleep_bias_sys_in|float * 5/9) if is_imperial else (sleep_bias_sys_in|float) }}"
    sleep_tighten_c: "{{ (sleep_tighten_sys_in|float * 5/9) if is_imperial else (sleep_tighten_sys_in|float) }}"

    # Time-window evaluation with wrap-around support (e.g., 22:00 â†’ 07:00)
    _now_m: "{{ now().hour*60 + now().minute }}"
    _st_parts: "{{ sleep_start_str.split(':') if sleep_start_str else ['22','0','0'] }}"
    _en_parts: "{{ sleep_end_str.split(':') if sleep_end_str else ['7','0','0'] }}"
    _st_m: >
        {% set h = (_st_parts[0]|int(22)) %}{% set m = (_st_parts[1]|int(0)) %}{{ h*60 + m }}
    _en_m: >
        {% set h = (_en_parts[0]|int(7)) %}{% set m = (_en_parts[1]|int(0)) %}{{ h*60 + m }}
    _time_active: >
        {% set nowm = _now_m|int %}
        {% set s = _st_m|int %}
        {% set e = _en_m|int %}
        {% if s <= e %}{{ (nowm >= s) and (nowm < e) }}
        {% else %}{{ (nowm >= s) or  (nowm < e) }}{% endif %}

    _sleep_switch: >
        {% if sleep_entity_id %}{{ is_state(sleep_entity_id, 'on') }}{% else %}false{% endif %}

    sleep_active: >
        {{ sleep_enable and ( (_sleep_switch|bool) or (_time_active|bool) ) and (occ_now|bool) }}

    sleep_bias_c_eff: "{{ sleep_bias_c if sleep_active else 0 }}"
    inside_half_c_eff: >
        {% if sleep_active %}
          {% set narrowed = (inside_half_c - sleep_tighten_c) %}
          {{ [narrowed, 0.4] | max }}
        {% else %}{{ inside_half_c }}{% endif %}

    # --------- Seasonal bias (existing logic) ---------
    _region_for_bias: "{{ region_pick }}"
    _preset_w_c: >
        {% set r = _region_for_bias %}
        {% set intensity = bias_intensity | float(1.0) %}
        {% if r == 'Very Cold' %} {{ 0.6 * intensity }}
        {% elif r == 'Cold' %} {{ 0.5 * intensity }}
        {% elif r == 'Mixed-Humid' %} {{ 0.3 * intensity }}
        {% elif r == 'Mixed-Dry' %} {{ 0.3 * intensity }}
        {% elif r == 'Hot-Humid' %} {{ 0.1 * intensity }}
        {% elif r == 'Hot-Dry' %} {{ 0.0 * intensity }}
        {% elif r == 'Marine' %} {{ 0.1 * intensity }}
        {% else %} {{ none }} {% endif %}
    _preset_s_c: >
        {% set r = _region_for_bias %}
        {% set intensity = bias_intensity | float(1.0) %}
        {% if r == 'Very Cold' %} {{ -0.2 * intensity }}
        {% elif r == 'Cold' %} {{ -0.2 * intensity }}
        {% elif r == 'Mixed-Humid' %} {{ -0.3 * intensity }}
        {% elif r == 'Mixed-Dry' %} {{ -0.2 * intensity }}
        {% elif r == 'Hot-Humid' %} {{ -0.5 * intensity }}
        {% elif r == 'Hot-Dry' %} {{ -0.4 * intensity }}
        {% elif r == 'Marine' %} {{ -0.1 * intensity }}
        {% else %} {{ none }} {% endif %}
    _preset_sh_c: >
        {% set r = _region_for_bias %}
        {% set intensity = bias_intensity | float(1.0) %}
        {% if r == 'Very Cold' %} {{ 0.3 * intensity }}
        {% elif r == 'Cold' %} {{ 0.2 * intensity }}
        {% elif r == 'Mixed-Humid' %} {{ 0.0 * intensity }}
        {% elif r == 'Mixed-Dry' %} {{ 0.0 * intensity }}
        {% elif r == 'Hot-Humid' %} {{ -0.2 * intensity }}
        {% elif r == 'Hot-Dry' %} {{ -0.1 * intensity }}
        {% elif r == 'Marine' %} {{ 0.0 * intensity }}
        {% else %} {{ none }} {% endif %}

    _w_sys_preset: "{{ (_preset_w_c * 9/5) if (is_imperial and _preset_w_c is not none) else _preset_w_c }}"
    _s_sys_preset: "{{ (_preset_s_c * 9/5) if (is_imperial and _preset_s_c is not none) else _preset_s_c }}"
    _sh_sys_preset: "{{ (_preset_sh_c * 9/5) if (is_imperial and _preset_sh_c is not none) else _preset_sh_c }}"

    winter_bias_sys: "{{ _w_sys_preset if (regional_defaults_enable and _w_sys_preset is not none) else winter_bias_sys_manual }}"
    summer_bias_sys: "{{ _s_sys_preset if (regional_defaults_enable and _s_sys_preset is not none) else summer_bias_sys_manual }}"
    shoulder_bias_sys: "{{ _sh_sys_preset if (regional_defaults_enable and _sh_sys_preset is not none) else shoulder_bias_sys_manual }}"

    # --------- Seasonal application ---------
    _season_raw: >
        {% if season_entity_id %}
          {{ states(season_entity_id) | string | lower }}
        {% else %}
          {% set m = now().month %}
          {% if m in [12,1,2] %} winter
          {% elif m in [6,7,8] %} summer
          {% else %} shoulder {% endif %}
        {% endif %}
    season_now: "{{ _season_raw }}"
    season_bias_sys_active: >
        {% if season_now == 'winter' %} {{ winter_bias_sys | float(0) }}
        {% elif season_now == 'summer' %} {{ summer_bias_sys | float(0) }}
        {% else %} {{ shoulder_bias_sys | float(0) }} {% endif %}
    season_bias_c: "{{ (season_bias_sys_active|float * 5/9) if is_imperial else (season_bias_sys_active|float) }}"

    co2_gap: >
        {% if co2_enable and co2_in_id and co2_out_id %}
          {{ (states(co2_in_id) | float(0)) - (states(co2_out_id) | float(0)) }}
        {% else %} 0 {% endif %}

    co2_dir: >
        {# COâ‚‚-driven seasonal bias: nudge comfort targets if COâ‚‚ gap exceeded #}
        {% if co2_enable and (co2_gap | float(0)) >= (co2_delta_ppm | float(0)) %}
          {% if season_now == 'winter' %} 1
          {% elif season_now == 'summer' %} -1
          {% else %} 0 {% endif %}
        {% else %} 0 {% endif %}

    co2_bias_c_eff: >
        {% set mag = co2_bias_max_c | float(0) %}
        {% if co2_dir != 0 %}
          {{ co2_dir * mag }}
        {% else %} 0 {% endif %}

    # --------- Adaptive model with learning ---------
    dv_c: "{{ (dv_sys|float * 5/9) if is_imperial else (dv_sys|float) }}"
    t_adapt_base_c: "{{ (18.9 + 0.255 * t_out_c) | round(2) }}"
    out_valid: "{{ t_out_c >= 10 and t_out_c <= 40 }}"
    t_adapt_c_raw: >
        {% set base = t_adapt_base_c + season_bias_c + co2_bias_c_eff + sleep_bias_c_eff + learned_offset_c %}
        {% if out_valid %}
          {% if precision %}{{ (base + 0 + 0) | round(2) }}
          {% else %}{{ base | round(2) }}{% endif %}
        {% else %}{{ (22.0 + season_bias_c + co2_bias_c_eff + sleep_bias_c_eff + learned_offset_c) | round(2) }}{% endif %}
    t_adapt_c: "{{ (t_adapt_c_raw) | round(2) }}"
    # Guard: keep adaptive target within [min_c+tol+setback, max_c-tol-setback] so band doesn't collapse to the edges
    t_adapt_c_guard: "{{ [ [ t_adapt_c, (max_c - tol_c - setback_apply_c) ] | min , (min_c + tol_c + setback_apply_c) ] | max | round(2) }}"
    band_min_c: "{{ [ [ t_adapt_c_guard - tol_c - setback_apply_c, min_c ] | max, max_c ] | min | round(2) }}"
    band_max_c: "{{ [ [ t_adapt_c_guard + tol_c + setback_apply_c, max_c ] | min, min_c ] | max | round(2) }}"
    # --- Final clamp with built-in ordering (no separate "sane" step needed) ---
    # Ensure band_min <= band_max (handle edge cases where adjustments cause inversion),
    # then apply final safety bounds to prevent exceeding user-configured limits.
    band_min_c_final: "{{ [ [ [ band_min_c, band_max_c ] | min | round(2), max_c ] | min, min_c ] | max }}"
    band_max_c_final: "{{ [ [ [ band_min_c, band_max_c ] | max | round(2), max_c ] | min, min_c ] | max }}"
    inside_low_c: "{{ (t_adapt_c - inside_half_c_eff - (setback_apply_c/2)) | round(2) }}"
    inside_high_c: "{{ (t_adapt_c + inside_half_c_eff + (setback_apply_c/2)) | round(2) }}"

    # --------- System units conversion ---------
    t_adapt_sys: "{{ t_adapt_c * _to_sys_mult + _to_sys_add }}"
    band_min_sys: "{{ band_min_c_final * _to_sys_mult + _to_sys_add }}"
    band_max_sys: "{{ band_max_c_final * _to_sys_mult + _to_sys_add }}"
    inside_low_sys: "{{ inside_low_c * _to_sys_mult + _to_sys_add }}"
    inside_high_sys: "{{ inside_high_c * _to_sys_mult + _to_sys_add }}"

    # --------- Climate unit outputs (convert from Â°C regardless of system heuristic) ---------
    min_allowed_raw: "{{ state_attr(climate_entity_id, 'min_temp') | float(7.2) }}"
    max_allowed_raw: "{{ state_attr(climate_entity_id, 'max_temp') | float(33.3) }}"

    # Detect climate unit: prefer explicit attribute; fallback to range heuristic
    climate_is_imperial: >
        {% set u = _u_climate | lower %}
        {% if 'f' in u %} true
        {% elif (max_allowed_raw | float(0)) >= 60 or (min_allowed_raw | float(0)) >= 30 %} true
        {% else %} false {% endif %}

    t_adapt_cli: "{{ (t_adapt_c_guard * 9/5 + 32) if climate_is_imperial else t_adapt_c_guard }}"
    band_min_cli: "{{ (band_min_c_final * 9/5 + 32) if climate_is_imperial else band_min_c_final }}"
    band_max_cli: "{{ (band_max_c_final * 9/5 + 32) if climate_is_imperial else band_max_c_final }}"
    inside_low_cli: "{{ (inside_low_c * 9/5 + 32) if climate_is_imperial else inside_low_c }}"
    inside_high_cli: "{{ (inside_high_c * 9/5 + 32) if climate_is_imperial else inside_high_c }}"

    # Limits remain in the climate's native units
    min_allowed_cli: "{{ min_allowed_raw }}"
    max_allowed_cli: "{{ max_allowed_raw }}"

    # HVAC capabilities
    hvac_modes: "{{ state_attr(climate_entity_id, 'hvac_modes') | default([], true) }}"
    supports_auto: "{{ 'auto' in hvac_modes }}"
    supports_heat_cool: "{{ 'heat_cool' in hvac_modes }}"
    fan_modes: "{{ state_attr(climate_entity_id, 'fan_modes') | default([], true) }}"
    hvac_mode_now: "{{ state_attr(climate_entity_id, 'hvac_mode') | string | lower }}"
    temp_now_sys: "{{ state_attr(climate_entity_id, 'temperature') | float(0) }}"
    temp_low_now_sys: "{{ state_attr(climate_entity_id, 'target_temp_low') | float(0) }}"
    temp_high_now_sys: "{{ state_attr(climate_entity_id, 'target_temp_high') | float(0) }}"
    fan_now: "{{ state_attr(climate_entity_id, 'fan_mode') | string | lower }}"

    # Minimum separation handling (only enforce if device or user requires it)
    cli_step: "{{ state_attr(climate_entity_id, 'target_temp_step') | float(1.0 if climate_is_imperial else 0.5) }}"
    # Attempt to read a device-advertised minimum separation (varies by integration)
    device_min_sep_cli: >
        {% set d1 = state_attr(climate_entity_id, 'min_temp_diff') %}
        {% set d2 = state_attr(climate_entity_id, 'temperature_difference') %}
        {% set v = d1 if d1 is not none else d2 %}
        {% set f = (v | float(0)) %}
        {{ f if f > 0 else 0 }}
    auto_sep_cli_from_user: >
        {% set sys = auto_sep_sys | float(0) %}
        {% if sys <= 0 %}0
        {% else %}
          {{ (sys if climate_is_imperial else (sys * 5/9)) }}
        {% endif %}

    thermostat_profile_val: !input thermostat_profile

    # ---- Thermostat profile auto-detect (device manufacturer/model + entity_id fallback) ----
    _ce_name: "{{ climate_entity_id | string | lower }}"
    _ce_manu: "{{ device_attr(climate_entity_id, 'manufacturer') | default('', true) | string | lower }}"
    _ce_model: "{{ device_attr(climate_entity_id, 'model')        | default('', true) | string | lower }}"

    thermostat_profile_auto: >
        {% set n = _ce_name %}
        {% set m = _ce_manu %}
        {% set md = _ce_model %}
        {# Vendor-specific checks by manufacturer/model first, then name substrings #}
        {% if 'ecobee' in m or 'ecobee' in md or 'ecobee' in n %}
          Ecobee
        {% elif 'google' in m or 'nest labs' in m or 'nest' in md or 'nest' in n %}
          Google Nest
        {% elif ('resideo' in m) or ('honeywell' in m) %}
          {# Distinguish T-series vs broader Honeywell/Resideo lines #}
          {% if 't6 pro' in md and ('z-wave' in md or 'zwave' in md or 'z-wave' in n or 'zwave' in n) %}
            Honeywell T6 Pro Z-Wave
          {% elif 't5' in md or 't6' in md or 't9' in md or 't10' in md or 't series' in md %}
            Honeywell T-series (T5/T6/T9)
          {% else %}
            Honeywell Home/Resideo (Lyric/Prestige/VisionPRO)
          {% endif %}
        {% elif 'carrier' in m or 'carrier' in n %}
          Carrier Infinity/Edge
        {% elif 'bryant' in m or 'bryant' in n %}
          Bryant Evolution
        {% elif 'trane' in m or 'trane' in n or 'american standard' in m or 'american standard' in n %}
          Trane/American Standard
        {% elif 'lennox' in m or 'lennox' in n %}
          Lennox iComfort
        {% elif 'wyze' in m or 'wyze' in n %}
          Wyze
        {% elif 'bosch' in m or 'bosch' in n %}
          Bosch Connected Control
        {% elif 'amazon' in m or 'amazon' in n %}
          Amazon Smart Thermostat
        {% elif 'tado' in m or 'tado' in n %}
          Tado
        {% elif 'netatmo' in m or 'netatmo' in n %}
          Netatmo
        {% elif 'hive' in m or 'hive' in n %}
          Hive
        {% elif 'heatmiser' in m or 'heatmiser' in n %}
          Heatmiser Neo
        {% elif 'mysa' in m or 'mysa' in n %}
          Mysa (Electric Heat)
        {% elif 'tuya' in m or 'tuya' in n %}
          Tuya Zigbee (Generic)
        {% elif 'zigbee' in m or 'zigbee' in n or 'zha' in n %}
          Zigbee (ZHA Generic)
        {% elif 'z-wave' in m or 'zwave' in m or 'z-wave' in n or 'zwave' in n %}
          Z-Wave (ZWAVE_JS Generic)
        {% else %}
          Generic (no minimum)
        {% endif %}

    # Selected vs. effective profile (auto-detect when dropdown = Auto)
    thermostat_profile_eff: >
        {% set sel = thermostat_profile_val | string %}
        {% if sel == 'Auto (detect/device)' %} {{ thermostat_profile_auto }}
        {% else %} {{ sel }} {% endif %}
    vendor_min_override_sys_in: !input vendor_min_override_sys

    # Map profile to a vendor minimum separation (in CLI units)
    # Lookup table: vendor profile -> minimum separation in Â°F
    _vendor_sep_lut_f: >
        {{ {
          'Ecobee': 5.0,
          'Google Nest': 3.0,
          'Honeywell T-series (T5/T6/T9)': 3.0,
          'Honeywell Home/Resideo (Lyric/Prestige/VisionPRO)': 2.0,
          'Honeywell T6 Pro Z-Wave': 3.0,
          'Emerson Sensi': 2.0,
          'Carrier Infinity/Edge': 2.0,
          'Bryant Evolution': 2.0,
          'Trane/American Standard': 3.0,
          'Lennox iComfort': 3.0,
          'Bosch Connected Control': 2.0,
          'Amazon Smart Thermostat': 2.0,
          'Wyze': 5.0,
          'Tado': 3.0,
          'Netatmo': 3.0,
          'Hive': 3.0,
          'Heatmiser Neo': 1.8,
          'Mysa (Electric Heat)': 3.0,
          'Tuya Zigbee (Generic)': 1.8,
          'Zigbee (ZHA Generic)': 1.8,
          'Z-Wave (ZWAVE_JS Generic)': 1.8
        } }}
    vendor_sep_cli_profile: >
        {% set p = thermostat_profile_eff | string %}
        {% set sep_f = _vendor_sep_lut_f.get(p, 0) | float(0) %}
        {{ sep_f if climate_is_imperial else (sep_f * 5/9) }}

    # Optional explicit override in system units -> convert to CLI units
    vendor_sep_cli_override: >
        {% set sys = vendor_min_override_sys_in | float(0) %}
        {% if sys <= 0 %}
          0
        {% else %}
          {{ sys if climate_is_imperial else (sys * 5/9) }}
        {% endif %}

    vendor_sep_cli: "{{ [vendor_sep_cli_override | float(0), vendor_sep_cli_profile | float(0)] | max }}"

    sep_cli_min: "{{ [ auto_sep_cli_from_user | float(0), device_min_sep_cli | float(0), vendor_sep_cli | float(0) ] | max }}"

    # ---------- Clamp helpers in climate units (guard against device range) ----------
    t_adapt_cli_capped: "{{ [[ t_adapt_cli, max_allowed_cli ] | min, min_allowed_cli ] | max }}"
    band_min_cli_capped: "{{ [[ band_min_cli, max_allowed_cli ] | min, min_allowed_cli ] | max }}"
    band_max_cli_capped: "{{ [[ band_max_cli, max_allowed_cli ] | min, min_allowed_cli ] | max }}"

    # ---------- Quantize to device step (floor) ----------
    band_min_cli_q: "{{ ((band_min_cli_capped / cli_step) | round(0,'floor') * cli_step) }}"
    band_max_cli_q: "{{ ((band_max_cli_capped / cli_step) | round(0,'floor') * cli_step) }}"
    t_adapt_cli_q:  "{{ ((t_adapt_cli_capped  / cli_step) | round(0,'floor') * cli_step) }}"

    # ---------- Enforce minimum separation for Auto/Heat-Cool ----------
    # Some thermostats require a minimum gap between heating and cooling setpoints.
    # If the comfort band is narrower than this minimum, expand it symmetrically around
    # the adaptive target to meet the device requirement.
    sep_needed: "{{ sep_cli_min | float(0) if (supports_auto or supports_heat_cool) else 0 }}"
    delta_q:    "{{ (band_max_cli_q - band_min_cli_q) | float(0) }}"
    need_expand: "{{ sep_needed > 0 and delta_q < sep_needed }}"

    low_cli_pref:  "{{ band_min_cli_q }}"
    high_cli_pref: "{{ band_max_cli_q }}"
    half_sep:      "{{ (sep_needed / 2.0) | float(0) }}"

    low_cli_exp:   "{{ ((t_adapt_cli_q - half_sep) / cli_step) | round(0,'floor') * cli_step }}"
    high_cli_exp:  "{{ low_cli_exp + ( (sep_needed / cli_step) | round(0,'ceil') * cli_step ) }}"

    target_low_cli_unc:  "{{ low_cli_exp  if need_expand else low_cli_pref  }}"
    target_high_cli_unc: "{{ high_cli_exp if need_expand else high_cli_pref }}"

    target_low_cli_cap:  "{{ [[ target_low_cli_unc,  max_allowed_cli ] | min, min_allowed_cli ] | max }}"
    target_high_cli_cap: "{{ [[ target_high_cli_unc, max_allowed_cli ] | min, min_allowed_cli ] | max }}"

    target_low_cli:  "{{ [ [ target_low_cli_cap,  target_high_cli_cap ] | min , min_allowed_cli ] | max }}"
    target_high_cli: "{{ [ [ target_high_cli_cap, target_low_cli_cap  ] | max , min_allowed_cli ] | max }}"

    # --------- Check if thermostat already at target setpoints (avoid unnecessary commands) ---------
    # Compare with tolerance to account for quantization/rounding
    _setpoint_tolerance: "{{ cli_step * 0.6 }}"  # Slightly more than half a step
    
    # For dual setpoint modes (auto/heat_cool)
    _dual_mode_matches: >
        {% if not (supports_auto or supports_heat_cool) %}
          false
        {% else %}
          {% set low_match = (temp_low_now_sys - target_low_cli) | abs < _setpoint_tolerance %}
          {% set high_match = (temp_high_now_sys - target_high_cli) | abs < _setpoint_tolerance %}
          {{ low_match and high_match }}
        {% endif %}
    
    # For single setpoint modes (heat/cool)
    _single_mode_matches: >
        {% if hvac_mode_now not in ['cool','heat'] %}
          false
        {% else %}
          {{ (temp_now_sys - t_adapt_cli_q) | abs < _setpoint_tolerance }}
        {% endif %}
    
    # Check if we need to send commands
    needs_temp_update: "{{ not (_dual_mode_matches or _single_mode_matches) }}"

    # --------- Debug helpers (strings computed in action when needed) ---------
    climate_unit_sym: "{{ 'Â°F' if climate_is_imperial else 'Â°C' }}"
    dbg_prefix: "Adaptive Climate (final v{{ blueprint_version }})"

trigger:
  # Core reactive triggers (debounced to prevent rapid re-evaluations)
  - platform: state
    id: indoor_temp_state
    entity_id: !input indoor_temp_sensor
    for:
      seconds: 30
  - platform: state
    id: outdoor_temp_state
    entity_id: !input outdoor_temp_sensor
    for:
      seconds: 60
  - platform: state
    id: occupancy_state
    entity_id: !input occupancy_sensor
  - platform: state
    id: season_state
    entity_id: !input season_entity
  - platform: state
    id: pause_any
    entity_id: !input pause_sensors

  # Manual override detection - monitor climate entity for user changes
  - platform: state
    id: climate_manual_change
    entity_id: !input climate_entity
    attribute: temperature
  - platform: state
    id: climate_manual_change_low
    entity_id: !input climate_entity
    attribute: target_temp_low
  - platform: state
    id: climate_manual_change_high
    entity_id: !input climate_entity
    attribute: target_temp_high

  # Optional sensors affecting psychrometrics or RMOT
  - platform: state
    id: rh_in_state
    entity_id: !input indoor_humidity_sensor
  - platform: state
    id: rh_out_state
    entity_id: !input outdoor_humidity_sensor
  - platform: state
    id: rmot_state
    entity_id: !input rmot_sensor
  - platform: state
    id: baro_state
    entity_id: !input baro_pressure_sensor

  # Periodic keep-alive / quantization tick
  - platform: time_pattern
    id: tick_10m
    minutes: "/10"
  - platform: time_pattern
    id: tick_hour
    hours: "*"
    minutes: 0

  # Start-up
  - platform: homeassistant
    id: ha_start
    event: start

condition: []

action:
  # ---------- Manual Override Detection ----------
  # Check if this trigger was a manual thermostat adjustment outside automation control
  - variables:
      _manual_trigger: >
        {{ trigger.id in ['climate_manual_change', 'climate_manual_change_low', 'climate_manual_change_high'] }}
      _manual_change_detected: >
        {% if not _manual_trigger %} false
        {% else %}
          {# Check if change exceeds tolerance threshold #}
          {% set tol = manual_override_tolerance | float(1.0) %}
          {% if trigger.id == 'climate_manual_change' %}
            {% set old = trigger.from_state.attributes.temperature | float(0) if trigger.from_state.attributes.temperature is not none else 0 %}
            {% set new = trigger.to_state.attributes.temperature | float(0) if trigger.to_state.attributes.temperature is not none else 0 %}
            {{ (new - old) | abs >= tol }}
          {% elif trigger.id == 'climate_manual_change_low' %}
            {% set old = trigger.from_state.attributes.target_temp_low | float(0) if trigger.from_state.attributes.target_temp_low is not none else 0 %}
            {% set new = trigger.to_state.attributes.target_temp_low | float(0) if trigger.to_state.attributes.target_temp_low is not none else 0 %}
            {{ (new - old) | abs >= tol }}
          {% elif trigger.id == 'climate_manual_change_high' %}
            {% set old = trigger.from_state.attributes.target_temp_high | float(0) if trigger.from_state.attributes.target_temp_high is not none else 0 %}
            {% set new = trigger.to_state.attributes.target_temp_high | float(0) if trigger.to_state.attributes.target_temp_high is not none else 0 %}
            {{ (new - old) | abs >= tol }}
          {% else %} false {% endif %}
        {% endif %}

  # If manual override detected, pause and exit
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ _manual_change_detected }}"
        sequence:
          # Calculate learned offset adjustment
          - variables:
              _manual_temp_cli: >
                {% if trigger.id == 'climate_manual_change' %}
                  {{ trigger.to_state.attributes.temperature | float(0) }}
                {% elif trigger.id == 'climate_manual_change_low' or trigger.id == 'climate_manual_change_high' %}
                  {# For dual setpoint, use midpoint #}
                  {% set low = trigger.to_state.attributes.target_temp_low | float(0) %}
                  {% set high = trigger.to_state.attributes.target_temp_high | float(0) %}
                  {{ (low + high) / 2 }}
                {% else %}0{% endif %}
              _manual_temp_c: "{{ (_manual_temp_cli - 32) * 5/9 if climate_is_imperial else _manual_temp_cli }}"
              _predicted_temp_c: "{{ t_adapt_c_guard }}"
              _error_c: "{{ _manual_temp_c - _predicted_temp_c }}"
              _old_offset_c: "{{ learned_offset_c }}"
              _alpha: "{{ learning_rate | float(0.15) }}"
              _new_offset_c: "{{ (1 - _alpha) * _old_offset_c + _alpha * _error_c }}"
              _new_offset_sys: "{{ _new_offset_c * 9/5 if is_imperial else _new_offset_c }}"

          # Update learned offset if learning enabled and helper provided
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (learn_from_overrides | bool) and (learned_offset_helper_id | string | length > 0) }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "HVAC Pro"
                      message: "DEBUG: writing learned offset helper {{ learned_offset_helper_id }} = {{ _new_offset_sys | round(2) }}"
                  - service: input_number.set_value
                    target:
                      entity_id: "{{ learned_offset_helper_id }}"
                    data:
                      value: "{{ _new_offset_sys | round(2) }}"

          # Set override expiry timestamp if helper is configured and override duration > 0
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ manual_override_enable and (manual_override_duration_min | int(0) > 0) and manual_override_until_id }}"
                sequence:
                  - variables:
                      _now_ts: "{{ as_timestamp(now()) | float(0) }}"
                      _duration_sec: "{{ manual_override_duration_min | int(60) * 60 }}"
                      _until_ts: "{{ (_now_ts + _duration_sec) | int }}"
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ manual_override_until_id }}"
                    data:
                      timestamp: "{{ _until_ts }}"

          # Log override
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ dbg in ['basic','verbose'] }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "HVAC Pro"
                      message: >
                        Manual override detected ({{ trigger.id }}). Manual={{ _manual_temp_c | round(1) }}Â°C, Predicted={{ _predicted_temp_c | round(1) }}Â°C, Error={{ _error_c | round(2) }}Â°C. 
                        {% if learn_from_overrides and learned_offset_helper_id %}
                        Learned offset: {{ _old_offset_c | round(2) }}Â°C â†’ {{ _new_offset_c | round(2) }}Â°C.
                        {% endif %}
                        Pausing for {{ manual_override_duration_min }} min{{ ' (helper set)' if manual_override_until_id else ' (WARNING: no helper - will NOT persist!)' }}.

          # Run custom override action (only when override is enabled and duration > 0)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ manual_override_enable and (manual_override_duration_min | int(0) > 0) }}"
                sequence: !input manual_override_action

          # Stop automation only when override is enabled and duration > 0
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ manual_override_enable and (manual_override_duration_min | int(0) > 0) }}"
                sequence:
                  - stop: "Manual override active - stopping automation"

  # ---------- Check if override is still active (persists across restarts) ----------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_override_active }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ dbg in ['basic','verbose'] }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "HVAC Pro"
                      message: "Manual override still active (expires {{ states(manual_override_until_id) }}). Skipping automation run."
          - stop: "Manual override active - skipping this run"

  # ---------- Verbose/basic logging ----------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ dbg in ['basic','verbose'] }}"
        sequence:
          - variables:
              _dbg_basic: >
                {{ dbg_prefix }} Band={{ band_min_sys | round(3) }}-{{ band_max_sys | round(3) }}{{ unit_sym }}; Set={{ t_adapt_sys | round(1) }}{{ unit_sym }}; In={{ t_in_sys | round(2) }}{{ unit_sym }}; Out={{ ((t_out_c * 9/5 + 32) if is_imperial else t_out_c) | round(2) }}{{ unit_sym }}; Trigger={{ (trigger.id if trigger is defined) if (trigger is defined) else 'unknown' }} ; sep_enforce={{ sep_needed > 0 }} sep_min={{ sep_cli_min | round(1) }}{{ climate_unit_sym }}; step={{ cli_step }} bounds={{ safety_min_sys_in }}â€“{{ safety_max_sys_in }}
          - service: logbook.log
            data:
              name: "HVAC Pro"
              message: "{{ _dbg_basic }}"
      - conditions:
          - condition: template
            value_template: "{{ dbg == 'verbose' }}"
        sequence:
          - variables:
              _dbg_verbose: >
                {{ dbg_prefix }} Band={{ band_min_sys | round(3) }}-{{ band_max_sys | round(3) }}{{ unit_sym }}; Set={{ t_adapt_sys | round(1) }}{{ unit_sym }}; In={{ t_in_sys | round(2) }}{{ unit_sym }}; Out={{ ((t_out_c * 9/5 + 32) if is_imperial else t_out_c) | round(2) }}{{ unit_sym }}; dp_out={{ dp_out_c | default(none) | round(1) if dp_out_c is not none else 'n/a' }}C, dp_in={{ dp_in_c | default(none) | round(1) if dp_in_c is not none else 'n/a' }}C, AH_out={{ ah_out | default(none) if ah_out is not none else 'n/a' }} g/mÂ³, AH_in={{ ah_in | default(none) if ah_in is not none else 'n/a' }} g/mÂ³, h_out={{ h_out | default(none) if h_out is not none else 'n/a' }} kJ/kg, h_in={{ h_in | default(none) if h_in is not none else 'n/a' }} kJ/kg; Trigger={{ (trigger.id if trigger is defined) if (trigger is defined) else 'unknown' }} ; sep_enforce={{ sep_needed > 0 }} sep_min={{ sep_cli_min | round(1) }}{{ climate_unit_sym }}; step={{ cli_step }} bounds={{ safety_min_sys_in }}â€“{{ safety_max_sys_in }}
          - service: logbook.log
            data:
              name: "HVAC Pro"
              message: "{{ _dbg_verbose }}"

  # ---------- Dynamic pause status & guard override ----------
  - variables:
      any_open_now: >
        {% set ents = pause_entities if pause_entities is iterable else [] %}
        {% if ents|length > 0 %}
          {{ expand(ents) | selectattr('state','eq','on') | list | count > 0 }}
        {% else %} false {% endif %}
      pause_blocked_now: >
        {{ (freeze_protect_enable and (t_in_sys|float(0) <= freeze_guard_sys_in|float(45)))
           or (overheat_protect_enable and (t_in_sys|float(0) >= overheat_guard_sys_in|float(88))) }}

  # ---------- Pause branch ----------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ any_open_now and not pause_blocked_now }}"
        sequence:
          - delay:
              seconds: "{{ pause_open_delay_eff }}"
          - service: climate.set_hvac_mode
            target:
              entity_id: !input climate_entity
            data:
              hvac_mode: "off"
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ pause_timeout_min_val|int(0) > 0 }}"
                sequence:
                  - delay:
                      minutes: "{{ pause_timeout_min_val|int(0) }}"
                  - variables:
                      _still_open: >
                        {% set ents = pause_entities if pause_entities is iterable else [] %}
                        {% if ents|length > 0 %}
                          {{ expand(ents) | selectattr('state','eq','on') | list | count > 0 }}
                        {% else %} false {% endif %}
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ _still_open }}"
                        sequence: !input pause_timeout_action

  # ---------- Resume & apply targets ----------
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ (not any_open_now) or pause_blocked_now }}"
        sequence:
          - delay:
              seconds: "{{ pause_close_delay_eff }}"

          # Natural ventilation preference (if enabled & suitable)
          # Logic: Enable natural vent when ALL of these are true:
          #   1. Feature is enabled (nat_vent_enable)
          #   2. Indoor/outdoor temps are valid numbers
          #   3. Outdoor temp is within threshold of indoor (not too different)
          #   4. Either psychrometrics disabled OR all psychro guards pass:
          #      - Outdoor dew point not too much higher than indoor (not muggy)
          #      - Outdoor enthalpy lower OR outdoor absolute humidity lower (economizer)
          #      - Outdoor dew point below maximum threshold
          - choose:
              - conditions:
                  - condition: template
                    value_template: >
                      {{ nat_vent_enable
                         and ( (t_out_c is number) and (t_in_c is number) )
                         and ( (t_out_c - t_in_c)|abs <= dv_c|float(1.0) )
                         and (
                               (not psychro_enable)
                               or (
                                     (dp_out_c is not none and dp_in_c is not none and (dp_out_c|float - dp_in_c|float) <= muggy_delta_dp_c|float(1.0))
                                     and ( (h_out is not none and h_in is not none and (h_in|float - h_out|float) >= econ_dh|float(0)) or
                                           (ah_out is not none and ah_in is not none and (ah_in|float - ah_out|float) >= econ_dah|float(0)) )
                                     and (dp_out_c is not none and (dp_out_c|float <= max_outdoor_dp_c|float(30)))
                                   )
                             )
                      }}
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: !input climate_entity
                    data:
                      hvac_mode: "off"
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ dbg in ['basic','verbose'] }}"
                        sequence:
                          - service: logbook.log
                            data:
                              name: "HVAC Pro"
                              message: "Natural ventilation preferred; HVAC kept off."

          # Otherwise enforce targets (only if values changed)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ supports_auto or supports_heat_cool }}"
                sequence:
                  # Set mode if needed
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ hvac_mode_now != 'heat_cool' }}"
                        sequence:
                          - service: climate.set_hvac_mode
                            target:
                              entity_id: !input climate_entity
                            data:
                              hvac_mode: "heat_cool"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ dbg == 'verbose' }}"
                                sequence:
                                  - service: logbook.log
                                    data:
                                      name: "HVAC Pro"
                                      message: "Mode changed: {{ hvac_mode_now }} â†’ heat_cool"
                  # Set temperature if needed
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ needs_temp_update }}"
                        sequence:
                          - service: climate.set_temperature
                            target:
                              entity_id: !input climate_entity
                            data:
                              target_temp_low:  "{{ target_low_cli  | float }}"
                              target_temp_high: "{{ target_high_cli | float }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ dbg == 'verbose' }}"
                                sequence:
                                  - service: logbook.log
                                    data:
                                      name: "HVAC Pro"
                                      message: "Temps updated: {{ temp_low_now_sys | round(1) }}/{{ temp_high_now_sys | round(1) }}{{ climate_unit_sym }} â†’ {{ target_low_cli | round(1) }}/{{ target_high_cli | round(1) }}{{ climate_unit_sym }}"
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ dbg == 'verbose' }}"
                            sequence:
                              - service: logbook.log
                                data:
                                  name: "HVAC Pro"
                                  message: "Setpoints unchanged ({{ target_low_cli | round(1) }}/{{ target_high_cli | round(1) }}{{ climate_unit_sym }}), skipping update"
              - conditions:
                  - condition: template
                    value_template: "{{ hvac_mode_now in ['cool','heat'] }}"
                sequence:
                  # Set temperature if needed
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ needs_temp_update }}"
                        sequence:
                          - service: climate.set_temperature
                            target:
                              entity_id: !input climate_entity
                            data:
                              temperature: "{{ t_adapt_cli_q | float }}"
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ dbg == 'verbose' }}"
                                sequence:
                                  - service: logbook.log
                                    data:
                                      name: "HVAC Pro"
                                      message: "Temp updated: {{ temp_now_sys | round(1) }}{{ climate_unit_sym }} â†’ {{ t_adapt_cli_q | round(1) }}{{ climate_unit_sym }}"
                    default:
                      - choose:
                          - conditions:
                              - condition: template
                                value_template: "{{ dbg == 'verbose' }}"
                            sequence:
                              - service: logbook.log
                                data:
                                  name: "HVAC Pro"
                                  message: "Setpoint unchanged ({{ t_adapt_cli_q | round(1) }}{{ climate_unit_sym }}), skipping update"
          # Turn on climate when not explicitly in hvac_mode 'off',
          # or when safety guards are enabled and we are approaching guard thresholds (safety-first).
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ hvac_mode_now != 'off' or safety_reenable_needed }}"
                sequence:
                  - service: climate.turn_on
                    target:
                      entity_id: !input climate_entity

mode: restart