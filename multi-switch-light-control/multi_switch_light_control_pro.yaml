blueprint:
  name: "Multi Switch Light Control Pro v1.5.5"
  description: >
    Turn a supported switch or remote into a smart light controller. Supports Inovelli
    Zigbee switches (via Zigbee2MQTT or ZHA), Zooz/Inovelli Z-Wave switches, and Lutron
    Pico remotes. The blueprint auto-detects the device protocol at runtime and adapts
    triggers + logic accordingly. Logs detected manufacturer/model/type when diagnostics
    are enabled.
  domain: automation
  author: "Jeremy Carter"
  source_url: >
    https://github.com/schoolboyqueue/home-assistant-blueprints/blob/main/
    multi-switch-light-control/multi_switch_light_control_pro.yaml

  input:
    core:
      name: Device & Lights
      icon: mdi:light-switch
      input:
        switch_device:
          name: "Switch or remote device"
          description: >
            REQUIRED. Select any Inovelli Zigbee switch (Zigbee2MQTT/ZHA), Zooz/Inovelli
            Z-Wave switch, or Lutron Pico remote. The blueprint auto-detects the protocol
            (Zigbee/Z-Wave/Lutron) and adapts triggers accordingly.
          selector:
            device:
              multiple: false
        zigbee_action_sensor:
          name: "Zigbee action sensor (auto-detected)"
          description: >
            OPTIONAL. For Zigbee switches only. The blueprint tries to auto-detect this,
            but if auto-detection fails, manually select the action sensor entity
            (e.g., sensor.switch_name_action). Leave at the placeholder value for
            Z-Wave/Lutron devices.
          default: sensor.placeholder_action_sensor
          selector:
            entity:
              domain: sensor
        light_target:
          name: "Light entities"
          description: "Select one or more target lights. The first entry is used for brightness reads."
          selector:
            entity:
              domain: light
              multiple: true
        light_area:
          name: "Optional: Area target"
          description: "If set, actions target this area instead of the single light entity."
          default: ""
          selector:
            area: {}

    dimming:
      name: Dimming parameters
      icon: mdi:brightness-6
      input:
        brightness_step_pct:
          name: "Brightness step (%)"
          description: "Amount to change the light each time the hold loop steps."
          default: 5
          selector:
            number:
              min: 1
              max: 50
              step: 1
              mode: slider
              unit_of_measurement: "%"
        dim_interval_ms:
          name: "Dim interval (ms)"
          description: "Delay between each brightness step while holding the paddle or a Lutron raise/lower button."
          default: 200
          selector:
            number:
              min: 50
              max: 1000
              step: 10
              mode: slider
              unit_of_measurement: "ms"
        min_on_brightness_pct:
          name: "Min on brightness when holding up (%)"
          description: "When the light is off, hold Up ensures it starts at least this bright."
          default: 10
          selector:
            number:
              min: 1
              max: 50
              step: 1
              mode: slider
              unit_of_measurement: "%"
        clamp_min_pct:
          name: "Clamp minimum brightness (%)"
          description: "Light turns off when dimming reaches this level or lower."
          default: 1
          selector:
            number:
              min: 0
              max: 50
              step: 1
              mode: slider
              unit_of_measurement: "%"
        clamp_max_pct:
          name: "Clamp maximum brightness (%)"
          description: "Logical cap for verbose logging and hold loops."
          default: 100
          selector:
            number:
              min: 50
              max: 100
              step: 1
              mode: slider
              unit_of_measurement: "%"
    scene_actions:
      name: Central Scene actions
      icon: mdi:gesture-tap
      input:
        up_press_1_action:
          name: "Up button press (1x)"
          description: "Optional custom action when the Up button is pressed once."
          selector:
            action: {}
          default: []
        up_press_2_action:
          name: "Up button press (2x)"
          description: "Optional custom action when the Up button is pressed twice."
          selector:
            action: {}
          default: []
        up_press_3_action:
          name: "Up button press (3x)"
          description: "Optional custom action when the Up button is pressed three times."
          selector:
            action: {}
          default: []
        up_press_4_action:
          name: "Up button press (4x)"
          description: "Optional custom action when the Up button is pressed four times."
          selector:
            action: {}
          default: []
        up_press_5_action:
          name: "Up button press (5x)"
          description: "Optional custom action when the Up button is pressed five times."
          selector:
            action: {}
          default: []
        down_press_1_action:
          name: "Down button press (1x)"
          description: "Optional custom action when the Down button is pressed once."
          selector:
            action: {}
          default: []
        down_press_2_action:
          name: "Down button press (2x)"
          description: "Optional custom action when the Down button is pressed twice."
          selector:
            action: {}
          default: []
        down_press_3_action:
          name: "Down button press (3x)"
          description: "Optional custom action when the Down button is pressed three times."
          selector:
            action: {}
          default: []
        down_press_4_action:
          name: "Down button press (4x)"
          description: "Optional custom action when the Down button is pressed four times."
          selector:
            action: {}
          default: []
        down_press_5_action:
          name: "Down button press (5x)"
          description: "Optional custom action when the Down button is pressed five times."
          selector:
            action: {}
          default: []

    lutron:
      name: Lutron Pico tuning
      icon: mdi:remote
      input:
        lutron_middle_button_action:
          name: "Middle (favorite) button action"
          description: "Optional sequence to run when the Pico favorite button is pressed."
          selector:
            action: {}
          default: []
        lutron_middle_button_brightness_pct:
          name: "Middle button brightness"
          description: "Brightness level when the favorite button uses the default action."
          default: 80
          selector:
            number:
              min: 1
              max: 100
              unit_of_measurement: "%"
        lutron_middle_button_kelvin:
          name: "Middle button color temperature"
          description: "Color temperature used when the default favorite action fires."
          default: 2800
          selector:
            number:
              min: 1500
              max: 40000
              unit_of_measurement: kelvin
        lutron_middle_button_transition_s:
          name: "Middle button transition (seconds)"
          description: "Fade time when the favorite button executes the default action."
          default: 1
          selector:
            number:
              min: 0
              max: 10
              unit_of_measurement: seconds
        lutron_on_transition_s:
          name: "Lutron On transition (seconds)"
          description: "Fade time when the Pico or a Central Scene on command turns the lights on."
          default: 1
          selector:
            number:
              min: 0
              max: 10
              unit_of_measurement: seconds
        lutron_off_transition_s:
          name: "Lutron Off transition (seconds)"
          description: "Fade time when the Pico or a Central Scene off command turns the lights off."
          default: 2
          selector:
            number:
              min: 0
              max: 10
              unit_of_measurement: seconds

    diagnostics:
      name: Diagnostics
      icon: mdi:bug-outline
      input:
        debug_level:
          name: "Debug level"
          description: "off: none, basic: key transitions, verbose: detailed brightness/clamp logging."
          default: "off"
          selector:
            select:
              mode: dropdown
              options:
                - "off"
                - "basic"
                - "verbose"
variables:
  blueprint_version: "1.5.5"

  switch_device: !input switch_device
  zigbee_action_sensor_input: !input zigbee_action_sensor
  light_targets: !input light_target
  light_target_sequence: >-
    {% set lt = light_targets | default('') %}
    {% if lt is string and lt | length > 0 %}
      [lt]
    {% elif lt is sequence and (lt | length > 0) %}
      {{ lt }}
    {% else %}
      []
    {% endif %}
  light_entity: >-
    {% set lt = light_targets | default('') %}
    {% if lt is string %}
      {{ lt }}
    {% elif lt is sequence and (lt | length > 0) %}
      {{ lt[0] }}
    {% else %}
      ""
    {% endif %}
  light_area_in: !input light_area
  step_pct_in: !input brightness_step_pct
  interval_ms_in: !input dim_interval_ms
  min_on_brightness_pct_in: !input min_on_brightness_pct
  clamp_min_pct_in: !input clamp_min_pct
  clamp_max_pct_in: !input clamp_max_pct
  up_press_1_action_input: !input up_press_1_action
  up_press_2_action_input: !input up_press_2_action
  up_press_3_action_input: !input up_press_3_action
  up_press_4_action_input: !input up_press_4_action
  up_press_5_action_input: !input up_press_5_action
  down_press_1_action_input: !input down_press_1_action
  down_press_2_action_input: !input down_press_2_action
  down_press_3_action_input: !input down_press_3_action
  down_press_4_action_input: !input down_press_4_action
  down_press_5_action_input: !input down_press_5_action
  lutron_middle_button_action_input: !input lutron_middle_button_action
  lutron_middle_button_brightness_pct_in: !input lutron_middle_button_brightness_pct
  lutron_middle_button_kelvin_in: !input lutron_middle_button_kelvin
  lutron_middle_button_transition_s_in: !input lutron_middle_button_transition_s
  lutron_on_transition_s_in: !input lutron_on_transition_s
  lutron_off_transition_s_in: !input lutron_off_transition_s
  debug_level_v: !input debug_level

  step_pct: "{{ step_pct_in | float(5) }}"
  interval_ms: "{{ interval_ms_in | int(200) }}"
  min_on_brightness_pct_v: "{{ min_on_brightness_pct_in | float(10) }}"
  clamp_min_pct_v: "{{ clamp_min_pct_in | float(1) }}"
  clamp_max_pct_v: "{{ clamp_max_pct_in | float(100) }}"
  step_abs_value: "{{ (step_pct / 100.0 * 255) | round(0) | int }}"

  min_abs_brightness: "{{ (clamp_min_pct_v / 100.0 * 255) | round(0) | int }}"
  min_on_abs_brightness: "{{ (min_on_brightness_pct_v / 100.0 * 255) | round(0) | int }}"
  max_abs_brightness: "{{ (clamp_max_pct_v / 100.0 * 255) | round(0) | int }}"

  lutron_middle_button_brightness_pct: "{{ lutron_middle_button_brightness_pct_in | float(80) }}"
  lutron_middle_button_kelvin: "{{ lutron_middle_button_kelvin_in | int(2800) }}"
  lutron_middle_button_transition_s: "{{ lutron_middle_button_transition_s_in | float(1) }}"
  lutron_on_transition_s: "{{ lutron_on_transition_s_in | float(1) }}"
  lutron_off_transition_s: "{{ lutron_off_transition_s_in | float(2) }}"

  detected_name: "{{ device_attr(switch_device, 'name') | default('Unknown device') }}"
  detected_manufacturer: "{{ device_attr(switch_device, 'manufacturer') | default('Unknown vendor') }}"
  detected_model: "{{ device_attr(switch_device, 'model') | default('Unknown model') }}"
  detected_label: >
    {{ detected_name }} | {{ detected_manufacturer }} {{ detected_model }}
  lutron_serial: "{{ device_attr(switch_device, 'serial_number') | default('') }}"

  # Auto-detect or use manual Zigbee2MQTT/ZHA action sensor entity
  action_sensor_placeholder: "sensor.placeholder_action_sensor"
  action_sensor_detection: >
    {% set entities = device_entities(switch_device) %}
    {% set action_sensors = entities | select('match', '^sensor\\..*_action$') | list %}
    {% if action_sensors | length == 1 %}
      {{ action_sensors[0] }}
    {% elif action_sensors | length > 1 %}
      {% set slug = detected_name | default('') | lower | replace(' ', '_') %}
      {% set narrowed = namespace(items=[]) %}
      {% for sensor in action_sensors %}
        {% set sensor_l = sensor | lower %}
        {% if slug | length > 0 and (slug in sensor_l) %}
          {% set narrowed.items = narrowed.items + [sensor] %}
        {% endif %}
      {% endfor %}
      {% if narrowed.items | length == 1 %}
        {{ narrowed.items[0] }}
      {% else %}
        ""
      {% endif %}
    {% else %}
      ""
    {% endif %}
  action_sensor_entity: >
    {% set provided = zigbee_action_sensor_input | default(action_sensor_placeholder) %}
    {% if provided != action_sensor_placeholder %}
      {{ provided }}
    {% elif action_sensor_detection | length > 0 %}
      {{ action_sensor_detection }}
    {% else %}
      ""
    {% endif %}
  has_action_sensor: "{{ action_sensor_entity | length > 0 }}"
  action_sensor_hint: >
    {% if not has_action_sensor and action_sensor_detection | length > 0 %}
      {{ action_sensor_detection }}
    {% else %}
      ""
    {% endif %}

  # Enhanced protocol detection: Zigbee2MQTT/ZHA, Z-Wave, or Lutron
  switch_type: >
    {% if has_action_sensor %}
      zigbee2mqtt
    {% else %}
      {% set manufacturer = detected_manufacturer | lower %}
      {% if 'lutron' in manufacturer %}
        lutron
      {% elif 'inovelli' in manufacturer %}
        inovelli
      {% elif 'zooz' in manufacturer %}
        zooz
      {% else %}
        generic
      {% endif %}
    {% endif %}
  area_set: >
    {% set a = light_area_in %}
    {{ a is string and a | length > 0 }}

  debug_enabled: "{{ debug_level_v in ['basic','verbose'] }}"
  debug_verbose: "{{ debug_level_v == 'verbose' }}"
mode: restart
max_exceeded: silent
trigger:
  - platform: event
    id: up_single
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: 0
  - platform: event
    id: up_single
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: "KeyPressed"
  - platform: event
    id: down_single
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: 0
  - platform: event
    id: down_single
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: "KeyPressed"
  - platform: event
    id: up_hold_start
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: 2
  - platform: event
    id: up_hold_start
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: "KeyHeldDown"
  - platform: event
    id: down_hold_start
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: 2
  - platform: event
    id: down_hold_start
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: "KeyHeldDown"
  - platform: event
    id: up_double
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: 3
  - platform: event
    id: up_double
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: "KeyPressed2x"
  - platform: event
    id: down_double
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: 3
  - platform: event
    id: down_double
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: "KeyPressed2x"
  - platform: event
    id: up_triple
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: 4
  - platform: event
    id: up_triple
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: "KeyPressed3x"
  - platform: event
    id: down_triple
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: 4
  - platform: event
    id: down_triple
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: "KeyPressed3x"
  - platform: event
    id: up_quad
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: 5
  - platform: event
    id: up_quad
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: "KeyPressed4x"
  - platform: event
    id: down_quad
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: 5
  - platform: event
    id: down_quad
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: "KeyPressed4x"
  - platform: event
    id: up_quint
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: 6
  - platform: event
    id: up_quint
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "001"
      value: "KeyPressed5x"
  - platform: event
    id: down_quint
    event_type: zwave_js_event
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: 6
  - platform: event
    id: down_quint
    event_type: zwave_js_value_notification
    event_data:
      device_id: !input switch_device
      command_class_name: "Central Scene"
      property: "scene"
      property_key: "002"
      value: "KeyPressed5x"
  - platform: event
    event_type: lutron_caseta_button_event
    event_data:
      serial: "{{ lutron_serial | default('') }}"
      type: press
      button_number: 2
    id: lutron_on
  - platform: event
    event_type: lutron_caseta_button_event
    event_data:
      serial: "{{ lutron_serial | default('') }}"
      type: press
      button_number: 3
    id: lutron_raise
  - platform: event
    event_type: lutron_caseta_button_event
    event_data:
      serial: "{{ lutron_serial | default('') }}"
      type: press
      button_number: 4
    id: lutron_stop
  - platform: event
    event_type: lutron_caseta_button_event
    event_data:
      serial: "{{ lutron_serial | default('') }}"
      type: press
      button_number: 5
    id: lutron_lower
  - platform: event
    event_type: lutron_caseta_button_event
    event_data:
      serial: "{{ lutron_serial | default('') }}"
      type: press
      button_number: 6
    id: lutron_off
  - platform: event
    event_type: lutron_caseta_button_event
    event_data:
      serial: "{{ lutron_serial | default('') }}"
      type: release
      button_number: 3
    id: lutron_raise_release
  - platform: event
    event_type: lutron_caseta_button_event
    event_data:
      serial: "{{ lutron_serial | default('') }}"
      type: release
      button_number: 5
    id: lutron_lower_release
  # Zigbee2MQTT Device Actions (MQTT integration)
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: up_single
    id: up_single_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: down_single
    id: down_single_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: up_double
    id: up_double_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: down_double
    id: down_double_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: up_triple
    id: up_triple_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: down_triple
    id: down_triple_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: up_quadruple
    id: up_quad_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: down_quadruple
    id: down_quad_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: up_quintuple
    id: up_quint_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: down_quintuple
    id: down_quint_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: up_held
    id: up_held_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: down_held
    id: down_held_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: up_release
    id: up_release_z2m
  - trigger: device
    device_id: !input switch_device
    domain: mqtt
    type: action
    subtype: down_release
    id: down_release_z2m
  # Zigbee2MQTT/ZHA state triggers (fire when the configured action sensor updates)
  # Defaults to a placeholder value so non-Zigbee setups remain valid
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "up_single"
    id: up_single_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "down_single"
    id: down_single_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "up_held"
    id: up_held_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "down_held"
    id: down_held_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "up_release"
    id: up_release_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "down_release"
    id: down_release_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "up_double"
    id: up_double_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "down_double"
    id: down_double_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "up_triple"
    id: up_triple_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "down_triple"
    id: down_triple_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "up_quadruple"
    id: up_quad_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "down_quadruple"
    id: down_quad_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "up_quintuple"
    id: up_quint_z2m
  - platform: state
    entity_id: !input zigbee_action_sensor
    to: "down_quintuple"
    id: down_quint_z2m
condition: []
action:
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          level: info
          message: >
            [Multi Switch Light Pro] Detected switch {{ detected_label }}
            | type={{ switch_type }}
  - if:
      - condition: template
        value_template: "{{ debug_enabled }}"
    then:
      - service: system_log.write
        data:
          level: info
          message: >
            [Multi Switch Light Pro] Trigger fired: id={{ trigger.id | default('unknown') }}
            | platform={{ trigger.platform | default('unknown') }}
            | switch_type={{ switch_type }}
  - if:
      - condition: template
        value_template: >
          {{
            debug_verbose and
            trigger is defined and
            trigger.platform == 'event' and
            trigger.event is defined
          }}
    then:
      - service: system_log.write
        data:
          level: debug
          message: >
            [Multi Switch Light Pro] Event data: {{ trigger.event.data | tojson }}
  - if:
      - condition: template
        value_template: >
          {{ debug_enabled and (not has_action_sensor) and (action_sensor_hint | length > 0) }}
    then:
      - service: system_log.write
        data:
          level: warning
          message: >
            [Multi Switch Light Pro] Detected Zigbee action sensor candidate {{ action_sensor_hint }}.
            Set the "Zigbee action sensor" input so Zigbee triggers can run.
  - if:
      - condition: template
        value_template: >
          {{ switch_type == 'lutron' and trigger.id == 'lutron_on' }}
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              level: info
              message: >
                [Multi Switch Light Pro] lutron_on → light.turn_on
      - if:
          - condition: template
            value_template: "{{ area_set }}"
        then:
          - service: light.turn_on
            target:
              area_id: "{{ light_area_in }}"
            data:
              brightness_pct: 100
              transition: "{{ lutron_on_transition_s }}"
        else:
          - repeat:
              for_each: "{{ light_target_sequence }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    brightness_pct: 100
                    transition: "{{ lutron_on_transition_s }}"
  - if:
      - condition: template
        value_template: >
          {{ switch_type == 'lutron' and trigger.id == 'lutron_raise' }}
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              level: info
              message: >
                [Multi Switch Light Pro] lutron_raise → hold brighten
      - repeat:
          sequence:
            - if:
                - condition: template
                  value_template: "{{ area_set }}"
              then:
                - service: light.turn_on
                  target:
                    area_id: "{{ light_area_in }}"
                  data:
                    brightness_step_pct: "{{ step_pct }}"
                  continue_on_error: true
              else:
                - repeat:
                    for_each: "{{ light_target_sequence }}"
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness_step_pct: "{{ step_pct }}"
                        continue_on_error: true
            - wait_for_trigger:
                - platform: event
                  event_type: lutron_caseta_button_event
                  event_data:
                    device_id: !input switch_device
                    action: "release_raise"
              timeout:
                milliseconds: "{{ interval_ms }}"
              continue_on_timeout: true
            - if:
                - condition: template
                  value_template: >
                    {{ wait is defined and wait.completed }}
              then:
                - if:
                    - condition: template
                      value_template: "{{ debug_enabled }}"
                  then:
                    - service: system_log.write
                      data:
                        level: info
                        message: >
                          [Multi Switch Light Pro] lutron_raise release → stop
                          brighten
                - stop:
          until:
            - condition: template
              value_template: "{{ state_attr(light_entity, 'brightness') | int(0) > 254 }}"
  - if:
      - condition: template
        value_template: >
          {{ switch_type == 'lutron' and trigger.id == 'lutron_stop' }}
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              level: info
              message: >
                [Multi Switch Light Pro] lutron_stop → favorite button
      - if:
          - condition: template
            value_template: >
              {{
                lutron_middle_button_action_input is defined and
                lutron_middle_button_action_input | length > 0
              }}
        then:
          - sequence: !input lutron_middle_button_action
        else:
          - if:
              - condition: template
                value_template: "{{ area_set }}"
            then:
              - service: light.turn_on
                target:
                  area_id: "{{ light_area_in }}"
                data:
                  brightness_pct: "{{ lutron_middle_button_brightness_pct }}"
                  kelvin: "{{ lutron_middle_button_kelvin }}"
                  transition: "{{ lutron_middle_button_transition_s }}"
            else:
              - repeat:
                  for_each: "{{ light_target_sequence }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        brightness_pct: "{{ lutron_middle_button_brightness_pct }}"
                        kelvin: "{{ lutron_middle_button_kelvin }}"
                        transition: "{{ lutron_middle_button_transition_s }}"
  - if:
      - condition: template
        value_template: >
          {{ switch_type == 'lutron' and trigger.id == 'lutron_lower' }}
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              level: info
              message: >
                [Multi Switch Light Pro] lutron_lower → hold dim
      - repeat:
          sequence:
            - if:
                - condition: template
                  value_template: "{{ area_set }}"
              then:
                - service: light.turn_on
                  target:
                    area_id: "{{ light_area_in }}"
                  data:
                    brightness_step_pct: "{{ step_pct * -1 }}"
                  continue_on_error: true
              else:
                - repeat:
                    for_each: "{{ light_target_sequence }}"
                    sequence:
                      - service: light.turn_on
                        target:
                          entity_id: "{{ repeat.item }}"
                        data:
                          brightness_step_pct: "{{ step_pct * -1 }}"
                        continue_on_error: true
            - wait_for_trigger:
                - platform: event
                  event_type: lutron_caseta_button_event
                  event_data:
                    device_id: !input switch_device
                    action: "release_lower"
              timeout:
                milliseconds: "{{ interval_ms }}"
              continue_on_timeout: true
            - if:
                - condition: template
                  value_template: >
                    {{ wait is defined and wait.completed }}
              then:
                - if:
                    - condition: template
                      value_template: "{{ debug_enabled }}"
                  then:
                    - service: system_log.write
                      data:
                        level: info
                        message: >
                          [Multi Switch Light Pro] lutron_lower release → stop dim
                - stop:
          until:
            - condition: template
              value_template: "{{ state_attr(light_entity, 'brightness') | int(0) < 1 }}"
  - if:
      - condition: template
        value_template: >
          {{ switch_type == 'lutron' and trigger.id == 'lutron_off' }}
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              level: info
              message: >
                [Multi Switch Light Pro] lutron_off → light.turn_off
      - if:
          - condition: template
            value_template: "{{ area_set }}"
        then:
          - service: light.turn_off
            target:
              area_id: "{{ light_area_in }}"
            data:
              transition: "{{ lutron_off_transition_s }}"
        else:
          - repeat:
              for_each: "{{ light_target_sequence }}"
              sequence:
                - service: light.turn_off
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    transition: "{{ lutron_off_transition_s }}"
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['up_single', 'up_single_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ up_press_1_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_single → custom action
          - sequence: !input up_press_1_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_single → light.turn_on (restore last)
          - if:
              - condition: template
                value_template: "{{ area_set }}"
            then:
              - service: light.turn_on
                target:
                  area_id: "{{ light_area_in }}"
                data:
                  transition: "{{ lutron_on_transition_s }}"
            else:
              - repeat:
                  for_each: "{{ light_target_sequence }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        transition: "{{ lutron_on_transition_s }}"
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['down_single', 'down_single_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ down_press_1_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_single → custom action
          - sequence: !input down_press_1_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_single → light.turn_off
          - if:
              - condition: template
                value_template: "{{ area_set }}"
            then:
              - service: light.turn_off
                target:
                  area_id: "{{ light_area_in }}"
                data:
                  transition: "{{ lutron_off_transition_s }}"
            else:
              - repeat:
                  for_each: "{{ light_target_sequence }}"
                  sequence:
                    - service: light.turn_off
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        transition: "{{ lutron_off_transition_s }}"
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['up_hold_start', 'up_held_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              level: info
              message: >
                [Multi Switch Light Pro] up_hold_start
      - condition: template
        value_template: "{{ states(light_entity) not in ['unknown','unavailable',''] }}"
      - if:
          - condition: template
            value_template: "{{ is_state(light_entity, 'off') }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] Light is off → turn_on to
                    min_on_brightness_pct={{ min_on_brightness_pct_v | int }}%
          - if:
              - condition: template
                value_template: "{{ area_set }}"
            then:
              - service: light.turn_on
                target:
                  area_id: "{{ light_area_in }}"
                data:
                  brightness: "{{ min_on_abs_brightness | int }}"
            else:
              - repeat:
                  for_each: "{{ light_target_sequence }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        brightness: "{{ min_on_abs_brightness | int }}"
      - repeat:
          sequence:
            - wait_for_trigger:
                - platform: event
                  event_type: zwave_js_event
                  event_data:
                    device_id: !input switch_device
                    command_class_name: "Central Scene"
                    property: "scene"
                    property_key: "001"
                    value: 1
                - platform: event
                  event_type: zwave_js_value_notification
                  event_data:
                    device_id: !input switch_device
                    command_class_name: "Central Scene"
                    property: "scene"
                    property_key: "001"
                    value: "KeyReleased"
                - platform: state
                  entity_id: !input zigbee_action_sensor
                  to: "up_release"
                - trigger: device
                  device_id: !input switch_device
                  domain: mqtt
                  type: action
                  subtype: up_release
              timeout:
                milliseconds: "{{ interval_ms }}"
            - if:
                - condition: template
                  value_template: >
                    {{ wait is defined and wait.completed }}
              then:
                - if:
                    - condition: template
                      value_template: "{{ debug_enabled }}"
                  then:
                    - service: system_log.write
                      data:
                        level: info
                        message: >
                          [Multi Switch Light Pro] up_release → stop brighten
                - stop:
            - variables:
                current_brightness: "{{ state_attr(light_entity,'brightness') | int(0) }}"
                target_brightness: >
                  {% set proposed = current_brightness + step_abs_value %}
                  {{ [proposed, max_abs_brightness] | min }}
            - if:
                - condition: template
                  value_template: "{{ debug_verbose }}"
              then:
                - service: system_log.write
                  data:
                    level: debug
                    message: >
                      [Multi Switch Light Pro] brighten step to
                      {{ target_brightness }}/255 | current={{ current_brightness }}/255
                      cap={{ max_abs_brightness }}
            - if:
                - condition: template
                  value_template: "{{ target_brightness > current_brightness }}"
              then:
                - if:
                    - condition: template
                      value_template: "{{ area_set }}"
                  then:
                    - service: light.turn_on
                      target:
                        area_id: "{{ light_area_in }}"
                      data:
                        brightness: "{{ target_brightness | int }}"
                  else:
                    - repeat:
                        for_each: "{{ light_target_sequence }}"
                        sequence:
                          - service: light.turn_on
                            target:
                              entity_id: "{{ repeat.item }}"
                            data:
                              brightness: "{{ target_brightness | int }}"
          until:
            - condition: template
              value_template: >
                {{ wait is defined and wait.completed }}
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['down_hold_start', 'down_held_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ debug_enabled }}"
        then:
          - service: system_log.write
            data:
              level: info
              message: >
                [Multi Switch Light Pro] down_hold_start
      - repeat:
          sequence:
            - wait_for_trigger:
                - platform: event
                  event_type: zwave_js_event
                  event_data:
                    device_id: !input switch_device
                    command_class_name: "Central Scene"
                    property: "scene"
                    property_key: "002"
                    value: 1
                - platform: event
                  event_type: zwave_js_value_notification
                  event_data:
                    device_id: !input switch_device
                    command_class_name: "Central Scene"
                    property: "scene"
                    property_key: "002"
                    value: "KeyReleased"
                - platform: state
                  entity_id: !input zigbee_action_sensor
                  to: "down_release"
                - trigger: device
                  device_id: !input switch_device
                  domain: mqtt
                  type: action
                  subtype: down_release
              timeout:
                milliseconds: "{{ interval_ms }}"
            - if:
                - condition: template
                  value_template: >
                    {{ wait is defined and wait.completed }}
              then:
                - if:
                    - condition: template
                      value_template: "{{ debug_enabled }}"
                  then:
                    - service: system_log.write
                      data:
                        level: info
                        message: >
                          [Multi Switch Light Pro] down_release → stop dim
                - stop:
            - if:
                - condition: template
                  value_template: "{{ is_state(light_entity, 'on') }}"
              then:
                - variables:
                    current_brightness: "{{ state_attr(light_entity,'brightness') | int(0) }}"
                    target_brightness: >
                      {% set proposed = current_brightness - step_abs_value %}
                      {{ [proposed, 0] | max }}
                - if:
                    - condition: template
                      value_template: "{{ debug_verbose }}"
                  then:
                    - service: system_log.write
                      data:
                        level: debug
                        message: >
                          [Multi Switch Light Pro] dim step to
                          {{ target_brightness }}/255 | current={{ current_brightness }}/255
                          min={{ min_abs_brightness }}
                - if:
                    - condition: template
                      value_template: "{{ target_brightness <= min_abs_brightness }}"
                  then:
                    - if:
                        - condition: template
                          value_template: "{{ debug_enabled }}"
                      then:
                        - service: system_log.write
                          data:
                            level: info
                            message: >
                              [Multi Switch Light Pro] brightness <= min clamp →
                              light.turn_off
                    - if:
                        - condition: template
                          value_template: "{{ area_set }}"
                      then:
                        - service: light.turn_off
                          target:
                            area_id: "{{ light_area_in }}"
                      else:
                        - repeat:
                            for_each: "{{ light_target_sequence }}"
                            sequence:
                              - service: light.turn_off
                                target:
                                  entity_id: "{{ repeat.item }}"
                    - stop: "Dim hold reached minimum; turning off"
                  else:
                    - if:
                        - condition: template
                          value_template: "{{ target_brightness < current_brightness }}"
                      then:
                        - if:
                            - condition: template
                              value_template: "{{ area_set }}"
                          then:
                            - service: light.turn_on
                              target:
                                area_id: "{{ light_area_in }}"
                              data:
                                brightness: "{{ target_brightness | int }}"
                          else:
                            - repeat:
                                for_each: "{{ light_target_sequence }}"
                                sequence:
                                  - service: light.turn_on
                                    target:
                                      entity_id: "{{ repeat.item }}"
                                    data:
                                      brightness: "{{ target_brightness | int }}"
          until:
            - condition: template
              value_template: >
                {{ wait is defined and wait.completed }}
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['up_double', 'up_double_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ up_press_2_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_double → custom action
          - sequence: !input up_press_2_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_double → run custom action
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['down_double', 'down_double_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ down_press_2_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_double → custom action
          - sequence: !input down_press_2_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_double → run custom action
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['up_triple', 'up_triple_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ up_press_3_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_triple → custom action
          - sequence: !input up_press_3_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_triple → run custom action
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['down_triple', 'down_triple_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ down_press_3_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_triple → custom action
          - sequence: !input down_press_3_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_triple → run custom action
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['up_quad', 'up_quad_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ up_press_4_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_quad → custom action
          - sequence: !input up_press_4_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_quad → no action defined
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['down_quad', 'down_quad_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ down_press_4_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_quad → custom action
          - sequence: !input down_press_4_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_quad → no action defined
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['up_quint', 'up_quint_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ up_press_5_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_quint → custom action
          - sequence: !input up_press_5_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] up_quint → no action defined
  - if:
      - condition: template
        value_template: >
          {{ switch_type != 'lutron' and trigger.id in ['down_quint', 'down_quint_z2m'] }}
    then:
      - if:
          - condition: template
            value_template: "{{ down_press_5_action_input | length > 0 }}"
        then:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_quint → custom action
          - sequence: !input down_press_5_action
        else:
          - if:
              - condition: template
                value_template: "{{ debug_enabled }}"
            then:
              - service: system_log.write
                data:
                  level: info
                  message: >
                    [Multi Switch Light Pro] down_quint → no action defined
