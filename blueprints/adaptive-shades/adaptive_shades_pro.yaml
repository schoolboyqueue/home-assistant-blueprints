blueprint:
  name: "Adaptive Shades Pro v1.12.3"
  description: >-
    Automatically positions vertical shades (blackout or zebra) using solar geometry and comfort signals.
    Implements the venetian blind strategy from Energies 13(7):1731: uses direct-vs-diffuse detection, clear-sky irradiance comparison,
    and temperature bands (winter/intermediate/summer) with distinct occupied vs unoccupied behavior. Select your shade and orientation,
    optionally add irradiance/temperature/lux sensors, and the blueprint will balance solar gain, glare control, and cooling load.
  domain: automation
  author: "Jeremy Carter"
  source_url: https://github.com/schoolboyqueue/home-assistant-blueprints/blob/main/adaptive-shades/adaptive_shades_pro.yaml

  input:

    core:
      name: Core Setup
      icon: mdi:blinds
      description: Primary shade control and solar geometry parameters.
      input:
        cover_target:
          name: Shade cover(s)
          description: One or more vertical shades (covers) to control. Works with blackout or zebra style shades that support position.
          selector:
            entity:
              domain: cover
              multiple: true
        window_orientation_deg:
          name: Window orientation (degrees)
          description: >-
            Direction the window faces, in degrees. Use 0° for North, 90° for East, 180° for South,
            270° for West. For diagonals, you can approximate: 45° = NE, 135° = SE, 225° = SW,
            315° = NW. Exact degrees are optional; a close compass direction is usually sufficient.
          default: 180
          selector:
            number:
              min: 0
              max: 359
              unit_of_measurement: "°"
              step: 1
        sun_entity:
          name: Sun entity
          description: >-
            Sun entity to use for elevation/azimuth and sunrise/sunset.
            Normally this should be 'sun.sun'.
          default: sun.sun
          selector:
            entity:
              domain: sun
        sun_tolerance_deg:
          name: Sun exposure cone (degrees)
          description: >-
            Half-angle around the window direction where the sun counts as "on this window".
            Most users can leave this at 45°. Try 30° if the shade reacts too often, or 60°
            if it does not react enough. This does not need to be exact.
          default: 45
          selector:
            number:
              min: 5
              max: 90
              step: 1
              unit_of_measurement: "°"
        admit_position_pct:
          name: Preferred open position (%)
          description: Position used to admit daylight/solar gain. 0 = fully open, 100 = fully closed.
          default: 20
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
        dim_position_pct:
          name: Preferred dimmed position (%)
          description: Position for filtered light with minimal glare.
          default: 50
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
        block_position_pct:
          name: Glare block position (%)
          description: Position used to block glare or excessive heat when the sun is on the window. 0 = fully open, 100 = fully closed.
          default: 85
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
        night_position_pct:
          name: Night/quiet hours position (%)
          description: >-
            Position used during quiet hours and after sunset. This is independent of the glare block position,
            allowing you to set a different level for nighttime privacy vs daytime glare control. 0 = fully open, 100 = fully closed.
          default: 85
          selector:
            number:
              min: 0
              max: 100
              step: 1
              unit_of_measurement: "%"
        position_hysteresis:
          name: Minimum position change (%)
          description: >-
            Minimum position change required before the shade will move. Prevents small, frequent adjustments.
            Set higher (e.g., 5-10%) if your shades move too often; set lower (e.g., 1-2%) for more precise control.
          default: 3
          selector:
            number:
              min: 1
              max: 15
              step: 1
              unit_of_measurement: "%"
        shading_mode:
          name: Shading mode
          description: >-
            Select 'slat' for venetian/vertical-louver shades that support tilt, or 'zebra' for
            banded zebra/roller shades that use position only. If unsure, choose 'zebra' for
            typical fabric roller blinds and 'slat' only for tilt-capable venetian-style covers.
          default: slat
          selector:
            select:
              options:
                - slat
                - zebra
        inverted_shades:
          name: Inverted shades
          description: >-
            Enable if your shade reports 0% as fully closed and 100% as fully open. This inverts
            the admit/dim/block positions so they map correctly to the device.
          default: false
          selector:
            boolean: {}

    sensors_and_targets:
      name: Comfort & Sensor Inputs
      icon: mdi:thermometer-auto
      description: Optional comfort and glare sensors. Blueprint falls back to sun geometry when sensors are omitted.
      input:
        indoor_temp_sensor:
          name: (Optional) Indoor temperature
          description: Temperature sensor inside the room. Used to bias shades open for heating or closed for cooling.
          default: ""
          selector:
            entity:
              domain: sensor
        outdoor_temp_sensor:
          name: (Optional) Outdoor temperature
          description: Outdoor temperature sensor. Used to gauge cooling load versus solar gain potential.
          default: ""
          selector:
            entity:
              domain: sensor
        indoor_lux_sensor:
          name: (Optional) Indoor illuminance
          description: Illuminance sensor near the window to detect glare. Leave empty to rely on sun geometry alone.
          default: ""
          selector:
            entity:
              domain: sensor
        climate_entity:
          name: (Optional) Climate entity
          description: >-
            HVAC climate entity for this room (e.g. climate.living_room). When set, the shade will
            bias behavior based on whether the system is actively heating or cooling.
          default: ""
          selector:
            entity:
              domain: climate
        weather_entity:
          name: (Optional) Weather entity
          description: >-
            Weather entity (e.g. weather.home) used to bias shading on cloudy or rainy days.
            Leave empty to ignore weather and rely on irradiance and sun position only.
          default: ""
          selector:
            entity:
              domain: weather
        cooling_setpoint:
          name: Cooling comfort upper bound
          description: >-
            Temperature (°C or °F) at which shades should bias toward blocking heat when no climate entity is provided.
            If a climate entity is set, its target cooling setpoint will be used instead.
          default: 25
          selector:
            number:
              min: 0
              max: 120
              step: 0.5
        heating_setpoint:
          name: Heating comfort lower bound
          description: >-
            Temperature (°C or °F) at which shades should bias toward admitting solar gain when no climate entity is provided.
            If a climate entity is set, its target heating setpoint will be used instead.
          default: 20
          selector:
            number:
              min: 0
              max: 120
              step: 0.5
        comfort_margin:
          name: Comfort margin
          description: Hysteresis around the comfort setpoints to reduce chatter. Same units as sensors.
          default: 0.5
          selector:
            number:
              min: 0
              max: 3
              step: 0.1
        glare_lux_threshold:
          name: Glare illuminance threshold (lux)
          description: >-
            Base glare threshold. If indoor illuminance rises above this (adjusted by the room profile),
            shades move toward the block/dim position when the sun is on the window.
          default: 1200
          selector:
            number:
              min: 100
              max: 40000
              step: 100
        room_profile:
          name: Room profile
          description: >-
            High-level behavior preset for this room. 'office' is more sensitive to glare on screens,
            'bedroom' tolerates a bit more light before reacting, and 'living' is balanced. You can
            still fine-tune the glare threshold below.
          default: living
          selector:
            select:
              options:
                - living
                - office
                - bedroom
        window_contacts:
          name: (Optional) Window contact sensors
          description: >-
            Optional: one window contact sensor per shade, in the same order as the Shade cover(s)
            list in Core Setup. When a mapped window sensor is open, that shade is forced fully open
            and will not close for glare or cooling until the window is closed again.
          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class:
                - window
                - door
              multiple: true
        window_open_delay:
          name: Window open delay (seconds)
          description: >-
            How long a window/door must stay open before the shade opens. Set to 0 for immediate
            response. Use a delay (e.g., 30-60 seconds) to avoid shade movements when briefly
            opening a window.
          default: 0
          selector:
            number:
              min: 0
              max: 300
              step: 5
              unit_of_measurement: "s"

    scheduling_and_overrides:
      name: Scheduling & Overrides
      icon: mdi:clock-check
      description: Optional presence and override helpers to suppress movement.
      input:
        presence_entity:
          name: (Optional) Presence entity
          description: When provided, shades adjust only if this entity is 'on' or 'home'. Leave empty to ignore presence.
          default: ""
          selector:
            entity:
              filter:
                - domain: person
                - domain: device_tracker
                - domain: binary_sensor
                - domain: input_boolean
        presence_required:
          name: Require presence to move
          description: If true, automation moves only when the presence entity looks present (on/home/occupied/present). If false, presence affects glare behavior but movement is allowed.
          default: false
          selector:
            boolean: {}
        manual_override:
          name: (Optional) Manual override helper
          description: When this input_boolean is 'on', shade adjustments pause. Turn off to resume automation.
          default: ""
          selector:
            entity:
              domain: input_boolean
        manual_timeout_minutes:
          name: Manual adjustment timeout (minutes)
          description: >-
            When the shade is manually adjusted, pause automatic movement for this many minutes.
            Set to 0 to disable automatic manual override detection.
          default: 60
          selector:
            number:
              min: 0
              max: 240
              step: 5
        quiet_hours_start:
          name: (Optional) Quiet hours start
          description: >-
            Optional extra time-of-day window to stop moving shades (keeps last position), regardless of
            sunrise/sunset. Night behavior is already controlled by the sun entity; use quiet hours only
            if you want an additional "do not move" window. Leave empty to disable quiet hours.
          default: ""
          selector:
            time: {}
        quiet_hours_end:
          name: (Optional) Quiet hours end
          description: >-
            Time-of-day to resume movement after the optional quiet hours window. This is independent of
            sunrise/sunset; leave empty (along with quiet_hours_start) to let the shade follow only the
            sun-based and comfort logic.
          default: ""
          selector:
            time: {}

    irradiance:
      name: Solar Irradiance (Optional, Advanced)
      icon: mdi:white-balance-sunny
      description: >-
        Advanced: vertical-plane irradiance to detect direct sun per the paper. Leave all fields at their defaults
        (or the whole section empty) unless you have a dedicated solarimeter and want to tune the clear-sky model.
      input:
        vertical_irradiance_sensor:
          name: (Optional) Vertical irradiance sensor
          description: Solarimeter on the same facade (W/m²). If set, used with clear-sky model to classify direct vs diffuse.
          default: ""
          selector:
            entity:
              domain: sensor
        clear_sky_A:
          name: Clear-sky coefficient A
          description: ASHRAE clear-sky A coefficient (default 1160 W/m²).
          default: 1160
          selector:
            number:
              min: 200
              max: 1400
              step: 10
        clear_sky_B:
          name: Clear-sky coefficient B
          description: ASHRAE clear-sky B coefficient (default 0.14).
          default: 0.14
          selector:
            number:
              min: 0.05
              max: 0.6
              step: 0.01
        direct_ratio_threshold:
          name: Direct sun detection ratio
          description: >-
            Advanced: measured/theoretical direct irradiance ratio to classify direct sun. Lower is more permissive.
            The default (0.35) suits most locations; you usually do not need to change this.
          default: 0.35
          selector:
            number:
              min: 0.1
              max: 1
              step: 0.05
        direct_irradiance_floor:
          name: Direct irradiance floor (W/m²)
          description: Minimum theoretical direct component before checking ratios (avoids noise at low sun angles).
          default: 50
          selector:
            number:
              min: 0
              max: 400
              step: 10
        diffuse_glare_threshold:
          name: Diffuse threshold (W/m²)
          description: Threshold used in diffuse mode per paper (G < 300 W/m²). Keeps original 300 default.
          default: 300
          selector:
            number:
              min: 100
              max: 800
              step: 10

    slat_geometry:
      name: Slat Geometry (Optional, Advanced)
      icon: mdi:angle-acute
      description: >-
        Advanced: used for the glare-limiting angle (Equation 8) in slat mode. The default ratio (~0.9) matches
        typical venetian slats. You normally do not need to measure or change these values.
      input:
        slat_gap_ratio:
          name: Slat gap to width ratio (d/L)
          description: Ratio of slat spacing to slat width. Leave default (0.9) for zebra/venetian-like behavior.
          default: 0.9
          selector:
            number:
              min: 0.2
              max: 1.5
              step: 0.05
        max_tilt_angle:
          name: Maximum tilt angle (degrees)
          description: Cap for computed slat angle (0 deg fully open, 180 deg fully closed). Used when mapping to cover position.
          default: 175
          selector:
            number:
              min: 90
              max: 180
              step: 1

    diagnostics:
      name: Diagnostics & Logging
      icon: mdi:bug
      description: Control logbook verbosity for this automation.
      input:
        debug_level:
          name: Debug level
          description: >-
            off = no logbook messages; basic = only key decisions (pause and movements);
            verbose = includes "no-move" cycles to help with tuning and debugging.
          default: basic
          selector:
            select:
              options:
                - label: "Off"
                  value: "off"
                - label: "Basic"
                  value: "basic"
                - label: "Verbose"
                  value: "verbose"

variables:
  blueprint_version: "1.12.3"
  cover_target: !input cover_target
  base_cover: >-
    {% set ct = cover_target | default('') %}
    {% if ct is string %}
      {{ ct }}
    {% elif ct is sequence and (ct | length > 0) %}
      {{ ct[0] }}
    {% else %}
      ""
    {% endif %}
  window_orientation_deg: !input window_orientation_deg
  sun_tolerance_deg: !input sun_tolerance_deg
  admit_position_pct: !input admit_position_pct
  dim_position_pct: !input dim_position_pct
  block_position_pct: !input block_position_pct
  night_position_pct: !input night_position_pct
  position_hysteresis: !input position_hysteresis
  shading_mode: !input shading_mode
  inverted_shades: !input inverted_shades
  sun_entity: !input sun_entity
  climate_entity: !input climate_entity
  room_profile: !input room_profile
  weather_entity: !input weather_entity
  indoor_temp_sensor: !input indoor_temp_sensor
  outdoor_temp_sensor: !input outdoor_temp_sensor
  indoor_lux_sensor: !input indoor_lux_sensor
  window_contacts: !input window_contacts
  window_open_delay: !input window_open_delay
  cooling_setpoint: !input cooling_setpoint
  heating_setpoint: !input heating_setpoint
  comfort_margin: !input comfort_margin
  glare_lux_threshold: !input glare_lux_threshold
  presence_entity: !input presence_entity
  presence_required: !input presence_required
  manual_override: !input manual_override
  manual_timeout_minutes: !input manual_timeout_minutes
  quiet_hours_start: !input quiet_hours_start
  quiet_hours_end: !input quiet_hours_end
  vertical_irradiance_sensor: !input vertical_irradiance_sensor
  clear_sky_A: !input clear_sky_A
  clear_sky_B: !input clear_sky_B
  direct_ratio_threshold: !input direct_ratio_threshold
  direct_irradiance_floor: !input direct_irradiance_floor
  diffuse_glare_threshold: !input diffuse_glare_threshold
  slat_gap_ratio: !input slat_gap_ratio
  max_tilt_angle: !input max_tilt_angle
  debug_level: !input debug_level
  debug_basic: "{{ debug_level in ['basic', 'verbose'] }}"
  debug_verbose: "{{ debug_level == 'verbose' }}"
  triggered_by_cover: "{{ trigger.id == 'cover_changed' if trigger is defined and trigger.id is defined else false }}"
  triggered_cover_entity: "{{ trigger.entity_id if triggered_by_cover else none }}"
  manual_change_detected: >-
    {% if not triggered_by_cover %}
      false
    {% else %}
      {# Ignore state changes while cover is actively moving (opening/closing) #}
      {% set cover_state = trigger.to_state.state if trigger.to_state is defined else '' %}
      {% if cover_state in ['opening', 'closing'] %}
        false
      {% else %}
        {% set ctx = trigger.to_state.context if trigger.to_state is defined else none %}
        {% if ctx is none %}
          false
        {% else %}
          {# UI changes have user_id; automations/scripts have parent_id; device reports have neither #}
          {% set user_id = ctx.user_id | default('') %}
          {% set parent_id = ctx.parent_id | default('') %}
          {% set from_ui = user_id is string and (user_id | length > 0) %}
          {% set from_automation = parent_id is string and (parent_id | length > 0) %}
          {% if from_ui %}
            {# Explicit UI interaction is always manual #}
            true
          {% elif from_automation %}
            {# Change from an automation/script - not manual #}
            false
          {% else %}
            {# Device state report (no user_id, no parent_id) - treat as potential manual change #}
            {# Note: Cannot compare to target position here due to variable ordering; #}
            {# the per-cover loop handles detailed position comparison #}
            true
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
  pi: 3.141592653589793
  e_const: 2.718281828459045
  deg_to_rad: 0.017453292519943295
  sun_above_horizon: "{{ is_state(sun_entity, 'above_horizon') }}"
  min_sun_elevation: "{{ 1 if sun_above_horizon else 90 }}"
  night_block_angle_deg: >-
    {# At night/quiet hours, use the dedicated night position, expressed as an angle out of 180°. #}
    {{ (night_position_pct | float(85) / 100.0) * 180.0 }}
  climate_hvac_mode: "{{ state_attr(climate_entity, 'hvac_mode') if climate_entity else none }}"
  climate_hvac_action: "{{ state_attr(climate_entity, 'hvac_action') if climate_entity else none }}"
  climate_target_high: "{{ state_attr(climate_entity, 'target_temp_high') | float(none) if climate_entity else none }}"
  climate_target_low: "{{ state_attr(climate_entity, 'target_temp_low') | float(none) if climate_entity else none }}"
  climate_target_temp: >-
    {% if climate_entity %}
      {% set t = state_attr(climate_entity, 'temperature') | float(none) %}
      {% if t is number %}
        {{ t }}
      {% else %}
        {{ state_attr(climate_entity, 'target_temperature') | float(none) }}
      {% endif %}
    {% else %}
      {{ none }}
    {% endif %}
  climate_heating: >-
    {% if not climate_entity %}
      false
    {% else %}
      {{ climate_hvac_action in ['heating'] or climate_hvac_mode in ['heat'] }}
    {% endif %}
  climate_cooling: >-
    {% if not climate_entity %}
      false
    {% else %}
      {{ climate_hvac_action in ['cooling'] or climate_hvac_mode in ['cool'] }}
    {% endif %}
  cover_supported_features: "{{ state_attr(base_cover, 'supported_features') | int(0) if base_cover else 0 }}"
  cover_supports_tilt: "{{ (cover_supported_features | bitwise_and(16)) > 0 }}"
  sun_azimuth: "{{ state_attr(sun_entity, 'azimuth') | float(0) }}"
  sun_elevation: "{{ state_attr(sun_entity, 'elevation') | float(-90) }}"
  weather_state: "{{ states(weather_entity) if weather_entity else none }}"
  weather_is_overcast: >-
    {% if not weather_state %}
      false
    {% else %}
      {% set s = weather_state %}
      {{ s in ['cloudy', 'overcast', 'rainy', 'pouring', 'snowy', 'hail', 'partlycloudy'] }}
    {% endif %}
  effective_heating_setpoint: >-
    {% if climate_entity %}
      {% if climate_target_high is number %}
        {{ climate_target_high }}
      {% elif climate_target_temp is number %}
        {{ climate_target_temp }}
      {% else %}
        {{ heating_setpoint }}
      {% endif %}
    {% else %}
      {{ heating_setpoint }}
    {% endif %}
  effective_cooling_setpoint: >-
    {% if climate_entity %}
      {% if climate_target_low is number %}
        {{ climate_target_low }}
      {% elif climate_target_temp is number %}
        {{ climate_target_temp }}
      {% else %}
        {{ cooling_setpoint }}
      {% endif %}
    {% else %}
      {{ cooling_setpoint }}
    {% endif %}
  # Normalize azimuth delta to [-180, 180] then take absolute value to test if the sun is hitting the window.
  sun_on_window: >-
    {% set delta = (((sun_azimuth - window_orientation_deg + 540) % 360) - 180) | abs %}
    {{ sun_elevation >= min_sun_elevation and delta <= sun_tolerance_deg }}
  indoor_temp: "{{ states(indoor_temp_sensor | default('')) | float(none) if indoor_temp_sensor else none }}"
  outdoor_temp: "{{ states(outdoor_temp_sensor | default('')) | float(none) if outdoor_temp_sensor else none }}"
  indoor_lux: "{{ states(indoor_lux_sensor | default('')) | float(none) if indoor_lux_sensor else none }}"
  presence_present: >-
    {% if not presence_entity %}
      false
    {% else %}
      {% set s = states(presence_entity) %}
      {{ s in ['on', 'home', 'occupied', 'present'] }}
    {% endif %}
  presence_ok: >-
    {% if not presence_entity %}
      true
    {% elif not presence_required %}
      true
    {% else %}
      {{ presence_present }}
    {% endif %}
  occupied: >-
    {% if not presence_entity %}
      true
    {% else %}
      {{ presence_present }}
    {% endif %}
  manual_override_active: >-
    {% set mo = manual_override | default('') %}
    {{ mo != '' and is_state(mo, 'on') }}
  auto_override_active: >-
    {# This is checked per-cover in the repeat loop using this_auto_override_active #}
    {# This top-level variable only checks UI-initiated changes; position comparison #}
    {# is done in the per-cover loop where desired_position_room is available #}
    {% if manual_timeout_minutes | int(0) <= 0 or not base_cover %}
      false
    {% else %}
      {% set s = states[base_cover] %}
      {% if s is none or s.last_changed is none %}
        false
      {% elif s.state in ['opening', 'closing'] %}
        {# Cover is still moving - don't evaluate manual detection yet #}
        false
      {% else %}
        {% set delta = (as_timestamp(now()) - as_timestamp(s.last_changed)) / 60 %}
        {% set ctx = s.context if s.context is defined else none %}
        {% set user_id = ctx.user_id | default('') if ctx else '' %}
        {% set parent_id = ctx.parent_id | default('') if ctx else '' %}
        {% set from_ui = user_id is string and (user_id | length > 0) %}
        {% set from_automation = parent_id is string and (parent_id | length > 0) %}
        {# Only detect explicit UI changes here; device reports are handled per-cover #}
        {% if from_ui %}
          {{ delta < (manual_timeout_minutes | float) }}
        {% else %}
          false
        {% endif %}
      {% endif %}
    {% endif %}
  in_quiet_hours: >-
    {% if not quiet_hours_start or not quiet_hours_end %}
      false
    {% else %}
      {% set now_time = now().time() %}
      {% set start = strptime(quiet_hours_start, '%H:%M:%S').time() %}
      {% set end = strptime(quiet_hours_end, '%H:%M:%S').time() %}
      {% if start < end %}
        {{ start <= now_time < end }}
      {% else %}
        {{ now_time >= start or now_time < end }}
      {% endif %}
    {% endif %}
  cooling_needed: >-
    {% if indoor_temp is not none %}
      {{ indoor_temp >= (effective_cooling_setpoint - comfort_margin) or climate_cooling }}
    {% elif climate_cooling %}
      true
    {% else %}
      false
    {% endif %}
  heating_needed: >-
    {% if indoor_temp is not none %}
      {{ indoor_temp <= (effective_heating_setpoint + comfort_margin) or climate_heating }}
    {% elif climate_heating %}
      true
    {% else %}
      false
    {% endif %}
  measured_irradiance: "{{ states(vertical_irradiance_sensor | default('')) | float(none) if vertical_irradiance_sensor else none }}"
  cos_az_offset: "{{ ((sun_azimuth - window_orientation_deg) | float * deg_to_rad) | cos }}"
  sin_elevation: "{{ (sun_elevation | float * deg_to_rad) | sin }}"
  cos_elevation: "{{ (sun_elevation | float * deg_to_rad) | cos }}"
  clear_sky_direct_normal: >-
    {% set sin_el = [sin_elevation, 0.017] | max %}
    {% set exponent = (-clear_sky_B / sin_el) | float %}
    {{ clear_sky_A * (e_const ** exponent) }}
  direct_incidence_cos: "{{ cos_az_offset * cos_elevation }}"
  direct_vertical_component: >-
    {% if direct_incidence_cos > 0 %}
      {{ clear_sky_direct_normal * direct_incidence_cos }}
    {% else %}
      0
    {% endif %}
  direct_sun_detected: >-
    {% if measured_irradiance is not none and direct_vertical_component > direct_irradiance_floor %}
      {{ measured_irradiance >= (direct_ratio_threshold * direct_vertical_component) }}
    {% else %}
      {# Fall back to sun geometry, but suppress "direct sun" when weather is clearly overcast #}
      {{ sun_on_window and not weather_is_overcast }}
    {% endif %}
  effective_glare_lux_threshold: >-
    {% if room_profile == 'office' %}
      {{ (glare_lux_threshold * 0.8) | round(0) }}
    {% elif room_profile == 'bedroom' %}
      {{ (glare_lux_threshold * 1.2) | round(0) }}
    {% else %}
      {{ glare_lux_threshold }}
    {% endif %}
  glare_detected: >-
    {% if indoor_lux is not none %}
      {{ indoor_lux >= effective_glare_lux_threshold }}
    {% else %}
      false
    {% endif %}
  beta_deg: >-
    {% if cos_az_offset == 0 %}
      90
    {% else %}
      {% set tan_elev = (sun_elevation | float * deg_to_rad) | tan %}
      {{ (tan_elev / cos_az_offset) | atan * 180 / pi }}
    {% endif %}
  beta_plus_90: "{{ beta_deg + 90 }}"
  diffuse_empirical_angle: "{{ 120 - (0.66 * sun_elevation) }}"
  slat_star_deg: >-
    {% set tan_beta = (beta_deg | float * deg_to_rad) | tan %}
    {% set ratio = slat_gap_ratio | float(0.9) %}
    {% set radicand = tan_beta*tan_beta - (ratio*ratio) + 1 %}
    {% if radicand <= 0 %}
      {{ beta_plus_90 }}
    {% else %}
      {% set num = tan_beta + (radicand | sqrt) %}
      {% set denom = 1 + ratio %}
      {{ 2 * (num / denom) | atan * 180 / pi }}
    {% endif %}
  mode_temp: >-
    {% set t = indoor_temp %}
    {% set heat_sp = effective_heating_setpoint %}
    {% set cool_sp = effective_cooling_setpoint %}
    {% if t is none and not climate_entity %}
      unknown
    {% elif climate_entity %}
      {# Climate mode takes precedence when clearly heating or cooling #}
      {% if climate_hvac_action in ['heating'] %}
        winter
      {% elif climate_hvac_action in ['cooling'] %}
        summer
      {% elif t is none %}
        unknown
      {% elif t <= (heat_sp + comfort_margin) %}
        winter
      {% elif t >= (cool_sp - comfort_margin) %}
        summer
      {% else %}
        intermediate
      {% endif %}
    {% else %}
      {# No climate entity: derive purely from temperature and setpoints #}
      {% if t <= (heat_sp + comfort_margin) %}
        winter
      {% elif t >= (cool_sp - comfort_margin) %}
        summer
      {% else %}
        intermediate
      {% endif %}
    {% endif %}
  target_angle_deg: >-
    {# Pause paths #}
    {% if manual_override_active or auto_override_active or in_quiet_hours or not presence_ok %}
      {{ none }}
    {% elif not sun_above_horizon %}
      {# Sun is below horizon: fully close to night block position. #}
      {{ night_block_angle_deg }}
    {% elif not direct_sun_detected and not sun_on_window %}
      {{ admit_position_pct / 100 * 180 }}
    {% else %}
      {% set G = measured_irradiance %}
      {% set angle = none %}
      {% if not occupied %}
        {% if mode_temp == 'winter' %}
          {% if not direct_sun_detected %}
            {% set angle = 110 %}
          {% else %}
            {% if beta_deg < 65 %}
              {% set angle = beta_plus_90 %}
            {% elif G is not none and G > diffuse_glare_threshold %}
              {% set angle = beta_plus_90 %}
            {% else %}
              {% set angle = diffuse_empirical_angle %}
            {% endif %}
          {% endif %}
        {% elif mode_temp == 'summer' %}
          {% set angle = max_tilt_angle %}
        {% elif mode_temp == 'intermediate' %}
          {% set angle = 80 %}
        {% else %}
          {% set angle = block_position_pct / 100 * 180 %}
        {% endif %}
      {% else %}
        {% if mode_temp == 'winter' %}
          {% if not direct_sun_detected %}
            {% set angle = 110 %}
          {% else %}
            {% set angle = slat_star_deg %}
          {% endif %}
        {% elif mode_temp == 'summer' %}
          {% set angle = 45 %}
        {% elif mode_temp == 'intermediate' %}
          {% if not direct_sun_detected %}
            {% set angle = 80 %}
          {% else %}
            {% set angle = slat_star_deg %}
          {% endif %}
        {% else %}
          {% set angle = block_position_pct / 100 * 180 %}
        {% endif %}
      {% endif %}
      {% if angle is none %}
        {{ none }}
      {% else %}
        {{ [0, [angle, max_tilt_angle].min()].max() }}
      {% endif %}
    {% endif %}
  slat_target_position: >-
    {% if shading_mode != 'slat' %}
      {{ none }}
    {% else %}
      {% if target_angle_deg is none %}
        {{ none }}
      {% else %}
        {{ (target_angle_deg / 180 * 100) | round(0) }}
      {% endif %}
    {% endif %}
  zebra_target_position: >-
    {% if shading_mode != 'zebra' %}
      {{ none }}
    {% else %}
      {% if not sun_above_horizon %}
        {{ night_position_pct }}
      {% else %}
      {% set frontlit = direct_sun_detected or sun_on_window %}
      {% set mode = mode_temp %}
      {% set occ = occupied %}
      {% set glare = glare_detected %}

      {% if not occ %}
        {# UNOCCUPIED:
           - Summer: bias to blocking when frontlit & cooling is a concern
           - Winter: bias to admitting when not frontlit & heating is a concern
           - Otherwise: sit in the middle (dim) to avoid extremes
        #}
        {% if mode == 'summer' %}
          {% if frontlit and cooling_needed %}
            {{ block_position_pct }}
          {% else %}
            {{ dim_position_pct }}
          {% endif %}
        {% elif mode == 'winter' %}
          {% if not frontlit and heating_needed %}
            {{ admit_position_pct }}
          {% else %}
            {{ dim_position_pct }}
          {% endif %}
        {% else %}
          {{ dim_position_pct }}
        {% endif %}

      {% else %}
        {# OCCUPIED:
           - When frontlit, glare drives behavior strongly.
           - In summer, if there is sun but no glare, err more closed.
           - When not frontlit, admit light.
        #}
        {% if frontlit %}
          {% if glare %}
            {{ block_position_pct }}
          {% elif mode == 'summer' %}
            {{ [dim_position_pct, block_position_pct] | max }}
          {% else %}
            {{ dim_position_pct }}
          {% endif %}
        {% else %}
          {{ admit_position_pct }}
        {% endif %}
      {% endif %}
      {% endif %}
    {% endif %}
  desired_position_room: >-
    {% if shading_mode == 'slat' %}
      {{ slat_target_position }}
    {% elif shading_mode == 'zebra' %}
      {{ zebra_target_position }}
    {% else %}
      {{ none }}
    {% endif %}

trigger:
  - platform: time_pattern
    minutes: "/5"
  - platform: state
    entity_id: !input sun_entity
  - platform: state
    entity_id: !input cover_target
    id: cover_changed
  - platform: state
    entity_id: !input window_contacts
    to: "on"
    id: window_opened
  - platform: state
    entity_id: !input window_contacts
    to: "off"
    id: window_closed
  - platform: homeassistant
    event: start

condition: []

action:
  # When a window opens and delay is configured, wait for the delay period
  - choose:
      - conditions: "{{ trigger.id == 'window_opened' and (window_open_delay | int(0)) > 0 }}"
        sequence:
          - delay:
              seconds: "{{ window_open_delay | int(0) }}"
          # After delay, verify the window is still open before proceeding
          - condition: template
            value_template: "{{ is_state(trigger.entity_id, 'on') }}"
  - choose:
      - conditions: "{{ triggered_by_cover and manual_change_detected }}"
        sequence:
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: >-
                Manual adjustment detected on {{ triggered_cover_entity }}.
                Pausing automation for {{ manual_timeout_minutes }} minutes. (v{{ blueprint_version }})
              domain: cover
          - stop: "Manual change detected, pausing automation"
      - conditions: "{{ manual_override_active }}"
        sequence:
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: "Paused: manual override is ON. (v{{ blueprint_version }})"
              domain: cover
          - stop: "Manual override active"
      - conditions: "{{ in_quiet_hours }}"
        sequence:
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: "Paused during quiet hours. (v{{ blueprint_version }})"
              domain: cover
          - stop: "Quiet hours active"
      - conditions: "{{ not presence_ok }}"
        sequence:
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: "Skipped: presence requirement not met. (v{{ blueprint_version }})"
              domain: cover
          - stop: "Presence requirement not met"
  - repeat:
      for_each: "{{ cover_target if cover_target is sequence else [cover_target] }}"
      sequence:
        - variables:
            this_cover: "{{ repeat.item }}"
            idx: "{{ repeat.index - 1 }}"
            this_window: >-
              {% set sensors = window_contacts %}
              {% if sensors is sequence and (sensors | length > idx) %}
                {{ sensors[idx] }}
              {% else %}
                ""
              {% endif %}
            this_window_open: >-
              {% if not this_window or not is_state(this_window, 'on') %}
                false
              {% elif window_open_delay | int(0) <= 0 %}
                true
              {% else %}
                {% set w = states[this_window] %}
                {% if w is none or w.last_changed is none %}
                  false
                {% else %}
                  {% set open_seconds = (as_timestamp(now()) - as_timestamp(w.last_changed)) %}
                  {{ open_seconds >= (window_open_delay | int(0)) }}
                {% endif %}
              {% endif %}
            this_current_position: "{{ state_attr(this_cover, 'current_position') }}"
            this_current_tilt: "{{ state_attr(this_cover, 'current_tilt_position') if cover_supports_tilt else none }}"
            this_target_base: "{{ desired_position_room }}"
            this_auto_override_active: >-
              {% if manual_timeout_minutes | int(0) <= 0 %}
                false
              {% else %}
                {% set s = states[this_cover] %}
                {% if s is none or s.last_changed is none %}
                  false
                {% elif s.state in ['opening', 'closing'] %}
                  {# Cover is still moving - don't evaluate manual detection yet #}
                  false
                {% else %}
                  {% set delta = (as_timestamp(now()) - as_timestamp(s.last_changed)) / 60 %}
                  {% set ctx = s.context if s.context is defined else none %}
                  {% set user_id = ctx.user_id | default('') if ctx else '' %}
                  {% set parent_id = ctx.parent_id | default('') if ctx else '' %}
                  {% set from_ui = user_id is string and (user_id | length > 0) %}
                  {% set from_automation = parent_id is string and (parent_id | length > 0) %}
                  {# Manual = UI change, or device report with position different from our target #}
                  {% if from_ui %}
                    {% set is_manual = true %}
                  {% elif from_automation %}
                    {% set is_manual = false %}
                  {% else %}
                    {% set current_pos = state_attr(this_cover, 'current_position') | float(none) %}
                    {% set target = this_target_base %}
                    {% if current_pos is none or target is none %}
                      {% set is_manual = false %}
                    {% else %}
                      {% set effective_target = (100 - target) if inverted_shades else target %}
                      {% set diff = (current_pos - effective_target) | abs %}
                      {% set is_manual = diff > (position_hysteresis | float(3)) %}
                    {% endif %}
                  {% endif %}
                  {{ is_manual and (delta < (manual_timeout_minutes | float)) }}
                {% endif %}
              {% endif %}
            this_target_position: >-
              {% if this_target_base is none %}
                {{ none }}
              {% elif this_window_open %}
                {% if inverted_shades %}
                  100
                {% else %}
                  0
                {% endif %}
              {% elif inverted_shades %}
                {{ 100 - (this_target_base | int) }}
              {% else %}
                {{ this_target_base | int }}
              {% endif %}
            this_target_tilt: >-
              {% if cover_supports_tilt and shading_mode == 'slat' and this_target_position is not none %}
                {{ this_target_position | int }}
              {% else %}
                {{ none }}
              {% endif %}

        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ this_auto_override_active }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ debug_basic }}"
                      sequence:
                        - service: logbook.log
                          data:
                            name: "Adaptive Shades"
                            message: "Paused for manual adjustment timeout on {{ this_cover }}. (v{{ blueprint_version }})"
                            domain: cover
                - stop: true

        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ debug_verbose }}"
                - condition: template
                  value_template: "{{ this_target_position is none }}"
              sequence:
                - service: logbook.log
                  data:
                    name: "Adaptive Shades"
                    message: >-
                      No movement for {{ this_cover }}: target_position is none
                      (sun_on_window={{ sun_on_window }},
                      direct_sun={{ direct_sun_detected }},
                      mode_temp={{ mode_temp }}). (v{{ blueprint_version }})
                    domain: cover

        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ debug_verbose }}"
                - condition: template
                  value_template: >-
                    {% if cover_supports_tilt and shading_mode == 'slat' %}
                      {{ this_target_tilt is not none and this_current_tilt is not none and (this_current_tilt - this_target_tilt) | abs < position_hysteresis }}
                    {% else %}
                      {{ this_current_position is not none and this_target_position is not none and (this_current_position - this_target_position) | abs < position_hysteresis }}
                    {% endif %}
              sequence:
                - service: logbook.log
                  data:
                    name: "Adaptive Shades"
                    message: >-
                      No movement for {{ this_cover }}: change below hysteresis
                      (current={{ this_current_position }}, target={{ this_target_position }}). (v{{ blueprint_version }})
                    domain: cover

        - condition: template
          value_template: "{{ this_target_position is not none }}"
        - condition: template
          value_template: >-
            {% if cover_supports_tilt and shading_mode == 'slat' %}
              {{ this_target_tilt is not none and (this_current_tilt is none or (this_current_tilt - this_target_tilt) | abs >= position_hysteresis) }}
            {% else %}
              {{ this_current_position is none or (this_current_position - this_target_position) | abs >= position_hysteresis }}
            {% endif %}

        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ is_state(this_cover, 'unavailable') or is_state(this_cover, 'unknown') }}"
              sequence:
                - service: logbook.log
                  data:
                    name: "Adaptive Shades"
                    message: "Cover {{ this_cover }} unavailable; no movement. (v{{ blueprint_version }})"
                    domain: cover
            - conditions:
                - condition: template
                  value_template: "{{ is_state(this_cover, 'opening') or is_state(this_cover, 'closing') }}"
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ debug_verbose }}"
                      sequence:
                        - service: logbook.log
                          data:
                            name: "Adaptive Shades"
                            message: "Cover {{ this_cover }} is moving; waiting for it to stop. (v{{ blueprint_version }})"
                            domain: cover
            - conditions: []
              sequence:
                - choose:
                    - conditions: "{{ cover_supports_tilt and shading_mode == 'slat' }}"
                      sequence:
                        - service: cover.set_cover_tilt_position
                          target:
                            entity_id: "{{ this_cover }}"
                          data:
                            tilt_position: "{{ this_target_tilt | int }}"
                    - conditions: []
                      sequence:
                        - service: cover.set_cover_position
                          target:
                            entity_id: "{{ this_cover }}"
                          data:
                            position: "{{ this_target_position | int }}"
                - condition: template
                  value_template: "{{ debug_basic }}"
                - service: logbook.log
                  data:
                    name: "Adaptive Shades"
                    message: >-
                      Set shade {{ this_cover }} to {{ this_target_position | int }}% (sun_on_window={{ sun_on_window }},
                      heating_needed={{ heating_needed }}, cooling_needed={{ cooling_needed }},
                      glare={{ glare_detected }}, az={{ sun_azimuth | round(1) }}°, el={{ sun_elevation | round(1) }}°). (v{{ blueprint_version }})
                    domain: cover

mode: restart
