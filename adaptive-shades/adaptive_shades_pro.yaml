blueprint:
  name: "Adaptive Shades Pro v1.5.4"
  description: >-
    Automatically positions vertical shades (blackout or zebra) using solar geometry and comfort signals.
    Implements the venetian blind strategy from Energies 13(7):1731: uses direct-vs-diffuse detection, clear-sky irradiance comparison,
    and temperature bands (winter/intermediate/summer) with distinct occupied vs unoccupied behavior. Select your shade and orientation,
    optionally add irradiance/temperature/lux sensors, and the blueprint will balance solar gain, glare control, and cooling load.
  domain: automation
  author: "Jeremy Carter"
  source_url: https://github.com/schoolboyqueue/home-assistant-blueprints/blob/main/adaptive-shades/adaptive_shades_pro.yaml

  input:

    core:
      name: Core Setup
      icon: mdi:blinds
      description: Primary shade control and solar geometry parameters.
      input:
        cover_target:
          name: Shade cover
          description: The vertical shade (cover) to control. Works with blackout or zebra style shades that support position.
          selector:
            entity:
              domain: cover
        window_orientation_deg:
          name: Window orientation (degrees)
          description: >-
            Direction the window faces, in degrees. Use 0° for North, 90° for East, 180° for South,
            270° for West. For diagonals, you can approximate: 45° = NE, 135° = SE, 225° = SW,
            315° = NW. Exact degrees are optional; a close compass direction is usually sufficient.
          default: 180
          selector:
            number:
              min: 0
              max: 359
              unit_of_measurement: "°"
              step: 1
        sun_entity:
          name: Sun entity
          description: >-
            Sun entity to use for elevation/azimuth and sunrise/sunset.
            Normally this should be 'sun.sun'.
          default: sun.sun
          selector:
            entity:
              domain: sun
        sun_tolerance_deg:
          name: Sun exposure cone (degrees)
          description: >-
            Half-angle around the window direction where the sun counts as "on this window".
            Most users can leave this at 45°. Try 30° if the shade reacts too often, or 60°
            if it does not react enough. This does not need to be exact.
          default: 45
          selector:
            number:
              min: 5
              max: 90
              step: 1
              unit_of_measurement: "°"
        admit_position_pct:
          name: Preferred open position (%)
          description: Position used to admit daylight/solar gain. 0 = fully open, 100 = fully closed.
          default: 20
          selector:
            number:
              min: 0
              max: 100
              step: 5
              unit_of_measurement: "%"
        dim_position_pct:
          name: Preferred dimmed position (%)
          description: Position for filtered light with minimal glare.
          default: 50
          selector:
            number:
              min: 0
              max: 100
              step: 5
              unit_of_measurement: "%"
        block_position_pct:
          name: Preferred block position (%)
          description: Position used to block glare or heat. 0 = fully open, 100 = fully closed.
          default: 85
          selector:
            number:
              min: 0
              max: 100
              step: 5
              unit_of_measurement: "%"
        shading_mode:
          name: Shading mode
          description: >-
            Select 'slat' for venetian/vertical-louver shades that support tilt, or 'zebra' for
            banded zebra/roller shades that use position only. If unsure, choose 'zebra' for
            typical fabric roller blinds and 'slat' only for tilt-capable venetian-style covers.
          default: slat
          selector:
            select:
              options:
                - slat
                - zebra

    sensors_and_targets:
      name: Comfort & Sensor Inputs
      icon: mdi:thermometer-auto
      description: Optional comfort and glare sensors. Blueprint falls back to sun geometry when sensors are omitted.
      input:
        indoor_temp_sensor:
          name: (Optional) Indoor temperature
          description: Temperature sensor inside the room. Used to bias shades open for heating or closed for cooling.
          default: ""
          selector:
            entity:
              domain: sensor
        outdoor_temp_sensor:
          name: (Optional) Outdoor temperature
          description: Outdoor temperature sensor. Used to gauge cooling load versus solar gain potential.
          default: ""
          selector:
            entity:
              domain: sensor
        indoor_lux_sensor:
          name: (Optional) Indoor illuminance
          description: Illuminance sensor near the window to detect glare. Leave empty to rely on sun geometry alone.
          default: ""
          selector:
            entity:
              domain: sensor
        climate_entity:
          name: (Optional) Climate entity
          description: >-
            HVAC climate entity for this room (e.g. climate.living_room). When set, the shade will
            bias behavior based on whether the system is actively heating or cooling.
          default: ""
          selector:
            entity:
              domain: climate
        weather_entity:
          name: (Optional) Weather entity
          description: >-
            Weather entity (e.g. weather.home) used to bias shading on cloudy or rainy days.
            Leave empty to ignore weather and rely on irradiance and sun position only.
          default: ""
          selector:
            entity:
              domain: weather
        cooling_setpoint:
          name: Cooling comfort upper bound
          description: >-
            Temperature (°C or °F) at which shades should bias toward blocking heat.
            Use the same units as your indoor temperature sensor.
          default: 25
          selector:
            number:
              min: 10
              max: 35
              step: 0.5
        heating_setpoint:
          name: Heating comfort lower bound
          description: >-
            Temperature (°C or °F) at which shades should bias toward admitting solar gain.
            Use the same units as your indoor temperature sensor.
          default: 20
          selector:
            number:
              min: 5
              max: 30
              step: 0.5
        comfort_margin:
          name: Comfort margin
          description: Hysteresis around the comfort setpoints to reduce chatter. Same units as sensors.
          default: 0.5
          selector:
            number:
              min: 0
              max: 3
              step: 0.1
        glare_lux_threshold:
          name: Glare illuminance threshold (lux)
          description: >-
            Base glare threshold. If indoor illuminance rises above this (adjusted by the room profile),
            shades move toward the block/dim position when the sun is on the window.
          default: 1200
          selector:
            number:
              min: 100
              max: 40000
              step: 100
        room_profile:
          name: Room profile
          description: >-
            High-level behavior preset for this room. 'office' is more sensitive to glare on screens,
            'bedroom' tolerates a bit more light before reacting, and 'living' is balanced. You can
            still fine-tune the glare threshold below.
          default: living
          selector:
            select:
              options:
                - living
                - office
                - bedroom

    scheduling_and_overrides:
      name: Scheduling & Overrides
      icon: mdi:clock-check
      description: Optional presence and override helpers to suppress movement.
      input:
        presence_entity:
          name: (Optional) Presence entity
          description: When provided, shades adjust only if this entity is 'on' or 'home'. Leave empty to ignore presence.
          default: ""
          selector:
            entity:
              filter:
                - domain: person
                - domain: device_tracker
                - domain: binary_sensor
                - domain: input_boolean
        manual_override:
          name: (Optional) Manual override helper
          description: When this input_boolean is 'on', shade adjustments pause. Turn off to resume automation.
          default: ""
          selector:
            entity:
              domain: input_boolean
        manual_timeout_minutes:
          name: Manual adjustment timeout (minutes)
          description: >-
            When the shade is manually adjusted, pause automatic movement for this many minutes.
            Set to 0 to disable automatic manual override detection.
          default: 60
          selector:
            number:
              min: 0
              max: 240
              step: 5
        quiet_hours_start:
          name: (Optional) Quiet hours start
          description: >-
            Optional extra time-of-day window to stop moving shades (keeps last position), regardless of
            sunrise/sunset. Night behavior is already controlled by the sun entity; use quiet hours only
            if you want an additional "do not move" window. Leave empty to disable quiet hours.
          default: ""
          selector:
            time: {}
        quiet_hours_end:
          name: (Optional) Quiet hours end
          description: >-
            Time-of-day to resume movement after the optional quiet hours window. This is independent of
            sunrise/sunset; leave empty (along with quiet_hours_start) to let the shade follow only the
            sun-based and comfort logic.
          default: ""
          selector:
            time: {}

    irradiance:
      name: Solar Irradiance (Optional, Advanced)
      icon: mdi:white-balance-sunny
      description: >-
        Advanced: vertical-plane irradiance to detect direct sun per the paper. Leave all fields at their defaults
        (or the whole section empty) unless you have a dedicated solarimeter and want to tune the clear-sky model.
      input:
        vertical_irradiance_sensor:
          name: (Optional) Vertical irradiance sensor
          description: Solarimeter on the same facade (W/m²). If set, used with clear-sky model to classify direct vs diffuse.
          default: ""
          selector:
            entity:
              domain: sensor
        clear_sky_A:
          name: Clear-sky coefficient A
          description: ASHRAE clear-sky A coefficient (default 1160 W/m²).
          default: 1160
          selector:
            number:
              min: 200
              max: 1400
              step: 10
        clear_sky_B:
          name: Clear-sky coefficient B
          description: ASHRAE clear-sky B coefficient (default 0.14).
          default: 0.14
          selector:
            number:
              min: 0.05
              max: 0.6
              step: 0.01
        direct_ratio_threshold:
          name: Direct sun detection ratio
          description: >-
            Advanced: measured/theoretical direct irradiance ratio to classify direct sun. Lower is more permissive.
            The default (0.35) suits most locations; you usually do not need to change this.
          default: 0.35
          selector:
            number:
              min: 0.1
              max: 1
              step: 0.05
        direct_irradiance_floor:
          name: Direct irradiance floor (W/m²)
          description: Minimum theoretical direct component before checking ratios (avoids noise at low sun angles).
          default: 50
          selector:
            number:
              min: 0
              max: 400
              step: 10
        diffuse_glare_threshold:
          name: Diffuse threshold (W/m²)
          description: Threshold used in diffuse mode per paper (G < 300 W/m²). Keeps original 300 default.
          default: 300
          selector:
            number:
              min: 100
              max: 800
              step: 10

    slat_geometry:
      name: Slat Geometry (Optional, Advanced)
      icon: mdi:angle-acute
      description: >-
        Advanced: used for the glare-limiting angle (Equation 8) in slat mode. The default ratio (~0.9) matches
        typical venetian slats. You normally do not need to measure or change these values.
      input:
        slat_gap_ratio:
          name: Slat gap to width ratio (d/L)
          description: Ratio of slat spacing to slat width. Leave default (0.9) for zebra/venetian-like behavior.
          default: 0.9
          selector:
            number:
              min: 0.2
              max: 1.5
              step: 0.05
        max_tilt_angle:
          name: Maximum tilt angle (degrees)
          description: Cap for computed slat angle (0 deg fully open, 180 deg fully closed). Used when mapping to cover position.
          default: 175
          selector:
            number:
              min: 90
              max: 180
              step: 1

    diagnostics:
      name: Diagnostics & Logging
      icon: mdi:bug
      description: Control logbook verbosity for this automation.
      input:
        debug_level:
          name: Debug level
          description: >-
            off = no logbook messages; basic = only key decisions (pause and movements);
            verbose = includes "no-move" cycles to help with tuning and debugging.
          default: basic
          selector:
            select:
              options:
                - label: off
                  value: off
                - label: basic
                  value: basic
                - label: verbose
                  value: verbose

variables:
  blueprint_version: "1.5.5"
  cover_target: !input cover_target
  window_orientation_deg: !input window_orientation_deg
  sun_tolerance_deg: !input sun_tolerance_deg
  admit_position_pct: !input admit_position_pct
  dim_position_pct: !input dim_position_pct
  block_position_pct: !input block_position_pct
  shading_mode: !input shading_mode
  sun_entity: !input sun_entity
  climate_entity: !input climate_entity
  room_profile: !input room_profile
  weather_entity: !input weather_entity
  indoor_temp_sensor: !input indoor_temp_sensor
  outdoor_temp_sensor: !input outdoor_temp_sensor
  indoor_lux_sensor: !input indoor_lux_sensor
  cooling_setpoint: !input cooling_setpoint
  heating_setpoint: !input heating_setpoint
  comfort_margin: !input comfort_margin
  glare_lux_threshold: !input glare_lux_threshold
  presence_entity: !input presence_entity
  manual_override: !input manual_override
  manual_timeout_minutes: !input manual_timeout_minutes
  quiet_hours_start: !input quiet_hours_start
  quiet_hours_end: !input quiet_hours_end
  vertical_irradiance_sensor: !input vertical_irradiance_sensor
  clear_sky_A: !input clear_sky_A
  clear_sky_B: !input clear_sky_B
  direct_ratio_threshold: !input direct_ratio_threshold
  direct_irradiance_floor: !input direct_irradiance_floor
  diffuse_glare_threshold: !input diffuse_glare_threshold
  slat_gap_ratio: !input slat_gap_ratio
  max_tilt_angle: !input max_tilt_angle
  debug_level: !input debug_level
  debug_basic: "{{ debug_level in ['basic', 'verbose'] }}"
  debug_verbose: "{{ debug_level == 'verbose' }}"
  pi: 3.141592653589793
  e_const: 2.718281828459045
  deg_to_rad: 0.017453292519943295
  sun_above_horizon: "{{ is_state(sun_entity, 'above_horizon') }}"
  min_sun_elevation: "{{ 1 if sun_above_horizon else 90 }}"
  night_block_angle_deg: >-
    {# At night, aim for the configured block position, expressed as an angle out of 180°. #}
    {{ (block_position_pct | float(85) / 100.0) * 180.0 }}
  climate_hvac_mode: "{{ state_attr(climate_entity, 'hvac_mode') if climate_entity else none }}"
  climate_hvac_action: "{{ state_attr(climate_entity, 'hvac_action') if climate_entity else none }}"
  climate_heating: >-
    {% if not climate_entity %}
      false
    {% else %}
      {{ climate_hvac_action in ['heating'] or climate_hvac_mode in ['heat'] }}
    {% endif %}
  climate_cooling: >-
    {% if not climate_entity %}
      false
    {% else %}
      {{ climate_hvac_action in ['cooling'] or climate_hvac_mode in ['cool'] }}
    {% endif %}
  cover_supported_features: "{{ state_attr(cover_target, 'supported_features') | int(0) }}"
  cover_supports_tilt: "{{ (cover_supported_features | bitwise_and(16)) > 0 }}"
  sun_azimuth: "{{ state_attr(sun_entity, 'azimuth') | float(0) }}"
  sun_elevation: "{{ state_attr(sun_entity, 'elevation') | float(-90) }}"
  weather_state: "{{ states(weather_entity) if weather_entity else none }}"
  weather_is_overcast: >-
    {% if not weather_state %}
      false
    {% else %}
      {% set s = weather_state %}
      {{ s in ['cloudy', 'overcast', 'rainy', 'pouring', 'snowy', 'hail', 'partlycloudy'] }}
    {% endif %}
  # Normalize azimuth delta to [-180, 180] then take absolute value to test if the sun is hitting the window.
  sun_on_window: >-
    {% set delta = (((sun_azimuth - window_orientation_deg + 540) % 360) - 180) | abs %}
    {{ sun_elevation >= min_sun_elevation and delta <= sun_tolerance_deg }}
  indoor_temp: "{{ states(indoor_temp_sensor) | float(none) if indoor_temp_sensor else none }}"
  outdoor_temp: "{{ states(outdoor_temp_sensor) | float(none) if outdoor_temp_sensor else none }}"
  indoor_lux: "{{ states(indoor_lux_sensor) | float(none) if indoor_lux_sensor else none }}"
  presence_ok: >-
    {% if not presence_entity %}
      true
    {% else %}
      {{ is_state(presence_entity, 'on') or is_state(presence_entity, 'home') }}
    {% endif %}
  manual_override_active: "{{ manual_override and is_state(manual_override, 'on') }}"
  cover_last_changed: "{{ states[cover_target].last_changed }}"
  auto_override_active: >-
    {% if manual_timeout_minutes | int(0) <= 0 or not cover_last_changed %}
      false
    {% else %}
      {% set delta = (now() - cover_last_changed).total_seconds() / 60 %}
      {{ delta < (manual_timeout_minutes | float) }}
    {% endif %}
  in_quiet_hours: >-
    {% if not quiet_hours_start or not quiet_hours_end %}
      false
    {% else %}
      {% set now_time = now().time() %}
      {% set start = strptime(quiet_hours_start, '%H:%M:%S').time() %}
      {% set end = strptime(quiet_hours_end, '%H:%M:%S').time() %}
      {% if start < end %}
        {{ start <= now_time < end }}
      {% else %}
        {{ now_time >= start or now_time < end }}
      {% endif %}
    {% endif %}
  cooling_needed: >-
    {% if indoor_temp is not none %}
      {{ indoor_temp >= (cooling_setpoint - comfort_margin) or climate_cooling }}
    {% elif climate_cooling %}
      true
    {% else %}
      false
    {% endif %}
  heating_needed: >-
    {% if indoor_temp is not none %}
      {{ indoor_temp <= (heating_setpoint + comfort_margin) or climate_heating }}
    {% elif climate_heating %}
      true
    {% else %}
      false
    {% endif %}
  measured_irradiance: "{{ states(vertical_irradiance_sensor) | float(none) if vertical_irradiance_sensor else none }}"
  cos_az_offset: "{{ ((sun_azimuth - window_orientation_deg) | float * deg_to_rad) | cos }}"
  sin_elevation: "{{ (sun_elevation | float * deg_to_rad) | sin }}"
  cos_elevation: "{{ (sun_elevation | float * deg_to_rad) | cos }}"
  clear_sky_direct_normal: >-
    {% set sin_el = [sin_elevation, 0.017].max() %}
    {% set exponent = (-clear_sky_B / sin_el) | float %}
    {{ clear_sky_A * (e_const ** exponent) }}
  direct_incidence_cos: "{{ cos_az_offset * cos_elevation }}"
  direct_vertical_component: >-
    {% if direct_incidence_cos > 0 %}
      {{ clear_sky_direct_normal * direct_incidence_cos }}
    {% else %}
      0
    {% endif %}
  direct_sun_detected: >-
    {% if measured_irradiance is not none and direct_vertical_component > direct_irradiance_floor %}
      {{ measured_irradiance >= (direct_ratio_threshold * direct_vertical_component) }}
    {% else %}
      {# Fall back to sun geometry, but suppress "direct sun" when weather is clearly overcast #}
      {{ sun_on_window and not weather_is_overcast }}
    {% endif %}
  effective_glare_lux_threshold: >-
    {% if room_profile == 'office' %}
      {{ (glare_lux_threshold * 0.8) | round(0) }}
    {% elif room_profile == 'bedroom' %}
      {{ (glare_lux_threshold * 1.2) | round(0) }}
    {% else %}
      {{ glare_lux_threshold }}
    {% endif %}
  glare_detected: >-
    {% if indoor_lux is not none %}
      {{ indoor_lux >= effective_glare_lux_threshold }}
    {% else %}
      false
    {% endif %}
  beta_deg: >-
    {% if cos_az_offset == 0 %}
      90
    {% else %}
      {% set tan_elev = (sun_elevation | float * deg_to_rad) | tan %}
      {{ (tan_elev / cos_az_offset) | atan * 180 / pi }}
    {% endif %}
  beta_plus_90: "{{ beta_deg + 90 }}"
  diffuse_empirical_angle: "{{ 120 - (0.66 * sun_elevation) }}"
  slat_star_deg: >-
    {% set tan_beta = (beta_deg | float * deg_to_rad) | tan %}
    {% set ratio = slat_gap_ratio | float(0.9) %}
    {% set radicand = tan_beta*tan_beta - (ratio*ratio) + 1 %}
    {% if radicand <= 0 %}
      {{ beta_plus_90 }}
    {% else %}
      {% set num = tan_beta + (radicand | sqrt) %}
      {% set denom = 1 + ratio %}
      {{ 2 * (num / denom) | atan * 180 / pi }}
    {% endif %}
  mode_temp: >-
    {% set t = indoor_temp %}
    {% set heat_sp = heating_setpoint %}
    {% set cool_sp = cooling_setpoint %}
    {% if t is none and not climate_entity %}
      unknown
    {% elif climate_entity %}
      {# Climate mode takes precedence when clearly heating or cooling #}
      {% if climate_heating %}
        winter
      {% elif climate_cooling %}
        summer
      {% elif t is none %}
        unknown
      {% elif t <= (heat_sp + comfort_margin) %}
        winter
      {% elif t >= (cool_sp - comfort_margin) %}
        summer
      {% else %}
        intermediate
      {% endif %}
    {% else %}
      {# No climate entity: derive purely from temperature and setpoints #}
      {% if t <= (heat_sp + comfort_margin) %}
        winter
      {% elif t >= (cool_sp - comfort_margin) %}
        summer
      {% else %}
        intermediate
      {% endif %}
    {% endif %}
  occupied: "{{ presence_ok }}"
  target_angle_deg: >-
    {# Pause paths #}
    {% if manual_override_active or auto_override_active or in_quiet_hours or not presence_ok %}
      {{ none }}
    {% elif not sun_above_horizon %}
      {# Sun is below horizon: fully close to night block position. #}
      {{ night_block_angle_deg }}
    {% elif not direct_sun_detected and not sun_on_window %}
      {{ admit_position_pct / 100 * 180 }}
    {% else %}
      {% set G = measured_irradiance %}
      {% set angle = none %}
      {% if not occupied %}
        {% if mode_temp == 'winter' %}
          {% if not direct_sun_detected %}
            {% set angle = 110 %}
          {% else %}
            {% if beta_deg < 65 %}
              {% set angle = beta_plus_90 %}
            {% elif G is not none and G > diffuse_glare_threshold %}
              {% set angle = beta_plus_90 %}
            {% else %}
              {% set angle = diffuse_empirical_angle %}
            {% endif %}
          {% endif %}
        {% elif mode_temp == 'summer' %}
          {% set angle = max_tilt_angle %}
        {% elif mode_temp == 'intermediate' %}
          {% set angle = 80 %}
        {% else %}
          {% set angle = block_position_pct / 100 * 180 %}
        {% endif %}
      {% else %}
        {% if mode_temp == 'winter' %}
          {% if not direct_sun_detected %}
            {% set angle = 110 %}
          {% else %}
            {% set angle = slat_star_deg %}
          {% endif %}
        {% elif mode_temp == 'summer' %}
          {% set angle = 45 %}
        {% elif mode_temp == 'intermediate' %}
          {% if not direct_sun_detected %}
            {% set angle = 80 %}
          {% else %}
            {% set angle = slat_star_deg %}
          {% endif %}
        {% else %}
          {% set angle = block_position_pct / 100 * 180 %}
        {% endif %}
      {% endif %}
      {% if angle is none %}
        {{ none }}
      {% else %}
        {{ [0, [angle, max_tilt_angle].min()].max() }}
      {% endif %}
    {% endif %}
  slat_target_position: >-
    {% if shading_mode != 'slat' %}
      {{ none }}
    {% else %}
      {% if target_angle_deg is none %}
        {{ none }}
      {% else %}
        {{ (target_angle_deg / 180 * 100) | round(0) }}
      {% endif %}
    {% endif %}
  zebra_target_position: >-
    {% if shading_mode != 'zebra' %}
      {{ none }}
    {% else %}
      {% set frontlit = direct_sun_detected or sun_on_window %}
      {% set mode = mode_temp %}
      {% set glare = glare_detected %}
      {% set occ = presence_ok %}
      {% if not occ %}
        {% if mode == 'summer' and frontlit %}
          {{ block_position_pct }}
        {% elif mode == 'winter' and not frontlit %}
          {{ admit_position_pct }}
        {% else %}
          {{ dim_position_pct }}
        {% endif %}
      {% else %}
        {% if frontlit %}
          {% if glare %}
            {{ block_position_pct }}
          {% elif mode == 'summer' %}
            {{ [dim_position_pct, block_position_pct] | max }}
          {% else %}
            {{ dim_position_pct }}
          {% endif %}
        {% else %}
          {{ admit_position_pct }}
        {% endif %}
      {% endif %}
    {% endif %}
  desired_position: >-
    {% if shading_mode == 'slat' %}
      {{ slat_target_position }}
    {% elif shading_mode == 'zebra' %}
      {{ zebra_target_position }}
    {% else %}
      {{ none }}
    {% endif %}

trigger:
  - platform: time_pattern
    minutes: "/5"
  - platform: state
    entity_id: !input sun_entity
  - platform: homeassistant
    event: start

condition: []

action:
  - choose:
      - conditions: "{{ manual_override_active }}"
        sequence:
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: "Paused: manual override is ON. (v{{ blueprint_version }})"
              domain: cover
      - conditions: "{{ in_quiet_hours }}"
        sequence:
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: "Paused during quiet hours. (v{{ blueprint_version }})"
              domain: cover
      - conditions: "{{ not presence_ok }}"
        sequence:
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: "Skipped: presence requirement not met. (v{{ blueprint_version }})"
              domain: cover
  - variables:
      current_position: "{{ state_attr(cover_target, 'current_position') }}"
      current_tilt: "{{ state_attr(cover_target, 'current_tilt_position') if cover_supports_tilt else none }}"
      target_position: "{{ desired_position }}"
      target_tilt: >-
        {% if cover_supports_tilt and shading_mode == 'slat' and target_position is not none %}
          {{ target_position | int }}
        {% else %}
          {{ none }}
        {% endif %}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ debug_verbose }}"
          - condition: template
            value_template: "{{ target_position is none }}"
        sequence:
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: >-
                No movement: target_position is none
                (sun_on_window={{ sun_on_window }},
                direct_sun={{ direct_sun_detected }},
                mode_temp={{ mode_temp }}). (v{{ blueprint_version }})
              domain: cover
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ debug_verbose }}"
          - condition: template
            value_template: >-
              {% if cover_supports_tilt and shading_mode == 'slat' %}
                {{ target_tilt is not none and current_tilt is not none and (current_tilt - target_tilt) | abs < 3 }}
              {% else %}
                {{ current_position is not none and target_position is not none and (current_position - target_position) | abs < 3 }}
              {% endif %}
        sequence:
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: >-
                No movement: change below hysteresis
                (current={{ current_position }}, target={{ target_position }}). (v{{ blueprint_version }})
              domain: cover
  - condition: template
    value_template: "{{ target_position is not none }}"
  - condition: template
    value_template: >-
      {% if cover_supports_tilt and shading_mode == 'slat' %}
        {{ target_tilt is not none and (current_tilt is none or (current_tilt - target_tilt) | abs >= 3) }}
      {% else %}
        {{ current_position is none or (current_position - target_position) | abs >= 3 }}
      {% endif %}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_state(cover_target, 'unavailable') or is_state(cover_target, 'unknown') }}"
        sequence:
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: "Cover unavailable; no movement. (v{{ blueprint_version }})"
              domain: cover
      - conditions: []
        sequence:
          - choose:
              - conditions: "{{ cover_supports_tilt and shading_mode == 'slat' }}"
                sequence:
                  - service: cover.set_cover_tilt_position
                    target:
                      entity_id: "{{ cover_target }}"
                    data:
                      tilt_position: "{{ target_tilt | int }}"
              - conditions: []
                sequence:
                  - service: cover.set_cover_position
                    target:
                      entity_id: "{{ cover_target }}"
                    data:
                      position: "{{ target_position | int }}"
          - condition: template
            value_template: "{{ debug_basic }}"
          - service: logbook.log
            data:
              name: "Adaptive Shades"
              message: >-
                Set shade to {{ target_position | int }}% (sun_on_window={{ sun_on_window }},
                heating_needed={{ heating_needed }}, cooling_needed={{ cooling_needed }},
                glare={{ glare_detected }}, az={{ sun_azimuth | round(1) }}°, el={{ sun_elevation | round(1) }}°). (v{{ blueprint_version }})
              domain: cover

mode: restart
max_exceeded: silent
